<!doctype html><html class="theme-next mist use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Hexo, NexT"><link rel="alternate" href="/atom.xml" title="Abracadabra" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0"><meta name="description" content="Ewan&apos;s IT Blog"><meta property="og:type" content="website"><meta property="og:title" content="Abracadabra"><meta property="og:url" content="http://yoursite.com/page/21/index.html"><meta property="og:site_name" content="Abracadabra"><meta property="og:description" content="Ewan&apos;s IT Blog"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Abracadabra"><meta name="twitter:description" content="Ewan&apos;s IT Blog"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/page/21/"><title>Abracadabra</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?dc405a79ad500922134d14cdf288f646";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Abracadabra</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Do it yourself</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/07/python-data-analysis-learning-note-09/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Ewan Li"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Abracadabra"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Abracadabra" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2017/03/07/python-data-analysis-learning-note-09/" itemprop="url">python data analysis learning note 09</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-07T15:37:24+08:00">2017-03-07 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2017/03/07/python-data-analysis-learning-note-09/#comments" itemprop="discussionUrl"><span class="post-comments-count hc-comment-count" data-xid="2017/03/07/python-data-analysis-learning-note-09/" itemprop="commentsCount"></span> </a></span><span id="/2017/03/07/python-data-analysis-learning-note-09/" class="leancloud_visitors" data-flag-title="python data analysis learning note 09"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="数据聚合与分组运算"><a href="#数据聚合与分组运算" class="headerlink" title="数据聚合与分组运算"></a>数据聚合与分组运算</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><span class="keyword">from</span> numpy.random <span class="keyword">import</span> randn</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line">np.random.seed(<span class="number">12345</span>)</div><div class="line">plt.rc(<span class="string">'figure'</span>, figsize=(<span class="number">10</span>, <span class="number">6</span>))</div><div class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> Series, DataFrame</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line">np.set_printoptions(precision=<span class="number">4</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pd.options.display.notebook_repr_html = <span class="keyword">False</span></div><div class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</div><div class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%matplotlib inline</div></pre></td></tr></table></figure><h2 id="GroupBy-机制"><a href="#GroupBy-机制" class="headerlink" title="GroupBy 机制"></a>GroupBy 机制</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">df = DataFrame(&#123;<span class="string">'key1'</span> : [<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>],</div><div class="line">                <span class="string">'key2'</span> : [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'one'</span>],</div><div class="line">                <span class="string">'data1'</span> : np.random.randn(<span class="number">5</span>),</div><div class="line">                <span class="string">'data2'</span> : np.random.randn(<span class="number">5</span>)&#125;)</div><div class="line">df</div></pre></td></tr></table></figure><pre><code>      data1     data2 key1 key2
0 -0.204708  1.393406    a  one
1  0.478943  0.092908    a  two
2 -0.519439  0.281746    b  one
3 -0.555730  0.769023    b  two
4  1.965781  1.246435    a  one
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grouped = df[<span class="string">'data1'</span>].groupby(df[<span class="string">'key1'</span>])</div><div class="line">grouped</div></pre></td></tr></table></figure><pre><code>&lt;pandas.core.groupby.SeriesGroupBy object at 0x0000000008BAFA90&gt;
</code></pre><p>变量<code>groupby</code>是一个<code>GroupBy</code>对象。它实际还没有进行任何计算，只有进行计算之后才能显示结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grouped.mean()</div></pre></td></tr></table></figure><pre><code>key1
a    0.746672
b   -0.537585
Name: data1, dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">means = df[<span class="string">'data1'</span>].groupby([df[<span class="string">'key1'</span>], df[<span class="string">'key2'</span>]]).mean()</div><div class="line">means</div></pre></td></tr></table></figure><pre><code>key1  key2
a     one     0.880536
      two     0.478943
b     one    -0.519439
      two    -0.555730
Name: data1, dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">means.unstack()</div></pre></td></tr></table></figure><pre><code>key2       one       two
key1                    
a     0.880536  0.478943
b    -0.519439 -0.555730
</code></pre><p>只要长度相同即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">states = np.array([<span class="string">'Ohio'</span>, <span class="string">'California'</span>, <span class="string">'California'</span>, <span class="string">'Ohio'</span>, <span class="string">'Ohio'</span>])</div><div class="line">years = np.array([<span class="number">2005</span>, <span class="number">2005</span>, <span class="number">2006</span>, <span class="number">2005</span>, <span class="number">2006</span>])</div><div class="line">df[<span class="string">'data1'</span>].groupby([states, years]).mean()</div></pre></td></tr></table></figure><pre><code>California  2005    0.478943
            2006   -0.519439
Ohio        2005   -0.380219
            2006    1.965781
Name: data1, dtype: float64
</code></pre><p>只要数值型数据才会出现在结果中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.groupby(<span class="string">'key1'</span>).mean()</div></pre></td></tr></table></figure><pre><code>         data1     data2
key1                    
a     0.746672  0.910916
b    -0.537585  0.525384
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.groupby([<span class="string">'key1'</span>, <span class="string">'key2'</span>]).mean()</div></pre></td></tr></table></figure><pre><code>              data1     data2
key1 key2                    
a    one   0.880536  1.319920
     two   0.478943  0.092908
b    one  -0.519439  0.281746
     two  -0.555730  0.769023
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.groupby([<span class="string">'key1'</span>, <span class="string">'key2'</span>]).size()</div></pre></td></tr></table></figure><pre><code>key1  key2
a     one     2
      two     1
b     one     1
      two     1
dtype: int64
</code></pre><h3 id="对分组进行迭代"><a href="#对分组进行迭代" class="headerlink" title="对分组进行迭代"></a>对分组进行迭代</h3><p>显示分组数据（要通过这种迭代的方式才能显示）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.groupby(<span class="string">'key1'</span>)</div></pre></td></tr></table></figure><pre><code>&lt;pandas.core.groupby.DataFrameGroupBy object at 0x0000000034BC8CF8&gt;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">df</div><div class="line"><span class="keyword">for</span> name, group <span class="keyword">in</span> df.groupby(<span class="string">'key1'</span>):</div><div class="line">    print(name)</div><div class="line">    print(group)</div></pre></td></tr></table></figure><pre><code>      data1     data2 key1 key2
0 -0.204708  1.393406    a  one
1  0.478943  0.092908    a  two
2 -0.519439  0.281746    b  one
3 -0.555730  0.769023    b  two
4  1.965781  1.246435    a  one



a
      data1     data2 key1 key2
0 -0.204708  1.393406    a  one
1  0.478943  0.092908    a  two
4  1.965781  1.246435    a  one
b
      data1     data2 key1 key2
2 -0.519439  0.281746    b  one
3 -0.555730  0.769023    b  two
</code></pre><p>同样进行迭代才能显示结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (k1, k2), group <span class="keyword">in</span> df.groupby([<span class="string">'key1'</span>, <span class="string">'key2'</span>]):</div><div class="line">    print((k1, k2))</div><div class="line">    print(group)</div></pre></td></tr></table></figure><pre><code>(&apos;a&apos;, &apos;one&apos;)
      data1     data2 key1 key2
0 -0.204708  1.393406    a  one
4  1.965781  1.246435    a  one
(&apos;a&apos;, &apos;two&apos;)
      data1     data2 key1 key2
1  0.478943  0.092908    a  two
(&apos;b&apos;, &apos;one&apos;)
      data1     data2 key1 key2
2 -0.519439  0.281746    b  one
(&apos;b&apos;, &apos;two&apos;)
     data1     data2 key1 key2
3 -0.55573  0.769023    b  two
</code></pre><p>将分组结果转化成一个字典（要先转化为一个列表）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pieces = dict(list(df.groupby(<span class="string">'key1'</span>)))</div><div class="line">pieces[<span class="string">'b'</span>]</div></pre></td></tr></table></figure><pre><code>      data1     data2 key1 key2
2 -0.519439  0.281746    b  one
3 -0.555730  0.769023    b  two
</code></pre><p>显示每一项的数据类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.dtypes</div></pre></td></tr></table></figure><pre><code>data1    float64
data2    float64
key1      object
key2      object
dtype: object
</code></pre><p>对列进行分组…按照数据类型来？！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grouped = df.groupby(df.dtypes, axis=<span class="number">1</span>)</div><div class="line">dict(list(grouped))</div></pre></td></tr></table></figure><pre><code>{dtype(&apos;float64&apos;):       data1     data2
 0 -0.204708  1.393406
 1  0.478943  0.092908
 2 -0.519439  0.281746
 3 -0.555730  0.769023
 4  1.965781  1.246435, dtype(&apos;O&apos;):   key1 key2
 0    a  one
 1    a  two
 2    b  one
 3    b  two
 4    a  one}
</code></pre><h3 id="选择一列或一组列"><a href="#选择一列或一组列" class="headerlink" title="选择一列或一组列"></a>选择一列或一组列</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">df.groupby(<span class="string">'key1'</span>)[<span class="string">'data1'</span>]</div><div class="line">df.groupby(<span class="string">'key1'</span>)[[<span class="string">'data2'</span>]]</div></pre></td></tr></table></figure><pre><code>&lt;pandas.core.groupby.SeriesGroupBy object at 0x0000000034BDC2E8&gt;






&lt;pandas.core.groupby.DataFrameGroupBy object at 0x0000000015EDF2B0&gt;
</code></pre><p>上述代码是以下代码的语法糖</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">df[<span class="string">'data1'</span>].groupby(df[<span class="string">'key1'</span>])</div><div class="line">df[[<span class="string">'data2'</span>]].groupby(df[<span class="string">'key1'</span>])</div></pre></td></tr></table></figure><pre><code>&lt;pandas.core.groupby.SeriesGroupBy object at 0x0000000034BDC8D0&gt;






&lt;pandas.core.groupby.DataFrameGroupBy object at 0x0000000034BDC898&gt;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.groupby([<span class="string">'key1'</span>, <span class="string">'key2'</span>])[[<span class="string">'data2'</span>]].mean()</div></pre></td></tr></table></figure><pre><code>              data2
key1 key2          
a    one   1.319920
     two   0.092908
b    one   0.281746
     two   0.769023
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s_grouped = df.groupby([<span class="string">'key1'</span>, <span class="string">'key2'</span>])[<span class="string">'data2'</span>]</div><div class="line">s_grouped</div></pre></td></tr></table></figure><pre><code>&lt;pandas.core.groupby.SeriesGroupBy object at 0x0000000034BDC6A0&gt;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s_grouped.mean()</div></pre></td></tr></table></figure><pre><code>key1  key2
a     one     1.319920
      two     0.092908
b     one     0.281746
      two     0.769023
Name: data2, dtype: float64
</code></pre><h3 id="通过字典或Series进行分组"><a href="#通过字典或Series进行分组" class="headerlink" title="通过字典或Series进行分组"></a>通过字典或Series进行分组</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">people = DataFrame(np.random.randn(<span class="number">5</span>, <span class="number">5</span>),</div><div class="line">                   columns=[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>],</div><div class="line">                   index=[<span class="string">'Joe'</span>, <span class="string">'Steve'</span>, <span class="string">'Wes'</span>, <span class="string">'Jim'</span>, <span class="string">'Travis'</span>])</div><div class="line">people.ix[<span class="number">2</span>:<span class="number">3</span>, [<span class="string">'b'</span>, <span class="string">'c'</span>]] = np.nan <span class="comment"># Add a few NA values</span></div><div class="line">people</div></pre></td></tr></table></figure><pre><code>               a         b         c         d         e
Joe     1.007189 -1.296221  0.274992  0.228913  1.352917
Steve   0.886429 -2.001637 -0.371843  1.669025 -0.438570
Wes    -0.539741       NaN       NaN -1.021228 -0.577087
Jim     0.124121  0.302614  0.523772  0.000940  1.343810
Travis -0.713544 -0.831154 -2.370232 -1.860761 -0.860757
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mapping = &#123;<span class="string">'a'</span>: <span class="string">'red'</span>, <span class="string">'b'</span>: <span class="string">'red'</span>, <span class="string">'c'</span>: <span class="string">'blue'</span>,</div><div class="line">           <span class="string">'d'</span>: <span class="string">'blue'</span>, <span class="string">'e'</span>: <span class="string">'red'</span>, <span class="string">'f'</span> : <span class="string">'orange'</span>&#125;</div></pre></td></tr></table></figure><p>会跳过NA值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">by_column = people.groupby(mapping, axis=<span class="number">1</span>)</div><div class="line">by_column.sum()</div></pre></td></tr></table></figure><pre><code>            blue       red
Joe     0.503905  1.063885
Steve   1.297183 -1.553778
Wes    -1.021228 -1.116829
Jim     0.524712  1.770545
Travis -4.230992 -2.405455
</code></pre><p>上述功能同样可以通过Series实现</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">map_series = Series(mapping)</div><div class="line">map_series</div></pre></td></tr></table></figure><pre><code>a       red
b       red
c      blue
d      blue
e       red
f    orange
dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">people.groupby(map_series, axis=<span class="number">1</span>).count()</div></pre></td></tr></table></figure><pre><code>        blue  red
Joe        2    3
Steve      2    3
Wes        1    2
Jim        2    3
Travis     2    3
</code></pre><h3 id="通过函数进行分组"><a href="#通过函数进行分组" class="headerlink" title="通过函数进行分组"></a>通过函数进行分组</h3><p>根据人名长度进行分组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">people.groupby(len).sum()</div></pre></td></tr></table></figure><pre><code>          a         b         c         d         e
3  0.591569 -0.993608  0.798764 -0.791374  2.119639
5  0.886429 -2.001637 -0.371843  1.669025 -0.438570
6 -0.713544 -0.831154 -2.370232 -1.860761 -0.860757
</code></pre><p>再加一个分组度量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">key_list = [<span class="string">'one'</span>, <span class="string">'one'</span>, <span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'two'</span>]</div><div class="line">people.groupby([len, key_list]).min()</div></pre></td></tr></table></figure><pre><code>              a         b         c         d         e
3 one -0.539741 -1.296221  0.274992 -1.021228 -0.577087
  two  0.124121  0.302614  0.523772  0.000940  1.343810
5 one  0.886429 -2.001637 -0.371843  1.669025 -0.438570
6 two -0.713544 -0.831154 -2.370232 -1.860761 -0.860757
</code></pre><h3 id="根据索引级别分组"><a href="#根据索引级别分组" class="headerlink" title="根据索引级别分组"></a>根据索引级别分组</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">columns = pd.MultiIndex.from_arrays([[<span class="string">'US'</span>, <span class="string">'US'</span>, <span class="string">'US'</span>, <span class="string">'JP'</span>, <span class="string">'JP'</span>],</div><div class="line">                                    [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">3</span>]], names=[<span class="string">'cty'</span>, <span class="string">'tenor'</span>])</div><div class="line">hier_df = DataFrame(np.random.randn(<span class="number">4</span>, <span class="number">5</span>), columns=columns)</div><div class="line">hier_df</div></pre></td></tr></table></figure><pre><code>cty          US                            JP          
tenor         1         3         5         1         3
0      0.560145 -1.265934  0.119827 -1.063512  0.332883
1     -2.359419 -0.199543 -1.541996 -0.970736 -1.307030
2      0.286350  0.377984 -0.753887  0.331286  1.349742
3      0.069877  0.246674 -0.011862  1.004812  1.327195
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hier_df.groupby(level=<span class="string">'cty'</span>, axis=<span class="number">1</span>).count()</div></pre></td></tr></table></figure><pre><code>cty  JP  US
0     2   3
1     2   3
2     2   3
3     2   3
</code></pre><h2 id="数据聚合"><a href="#数据聚合" class="headerlink" title="数据聚合"></a>数据聚合</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df</div></pre></td></tr></table></figure><pre><code>      data1     data2 key1 key2
0 -0.204708  1.393406    a  one
1  0.478943  0.092908    a  two
2 -0.519439  0.281746    b  one
3 -0.555730  0.769023    b  two
4  1.965781  1.246435    a  one
</code></pre><p>对分组后的数据进行相应操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grouped = df.groupby(<span class="string">'key1'</span>)</div><div class="line">grouped[<span class="string">'data1'</span>].quantile(<span class="number">0.9</span>)</div></pre></td></tr></table></figure><pre><code>key1
a    1.668413
b   -0.523068
Name: data1, dtype: float64
</code></pre><p>通过函数进行聚合操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">peak_to_peak</span><span class="params">(arr)</span>:</span></div><div class="line">    <span class="keyword">return</span> arr.max() - arr.min()</div><div class="line">grouped.agg(peak_to_peak)</div></pre></td></tr></table></figure><pre><code>         data1     data2
key1                    
a     2.170488  1.300498
b     0.036292  0.487276
</code></pre><p>列出分组后数据的一些常用属性</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grouped.describe()</div></pre></td></tr></table></figure><pre><code>               data1     data2
key1                          
a    count  3.000000  3.000000
     mean   0.746672  0.910916
     std    1.109736  0.712217
     min   -0.204708  0.092908
     25%    0.137118  0.669671
     50%    0.478943  1.246435
     75%    1.222362  1.319920
     max    1.965781  1.393406
b    count  2.000000  2.000000
     mean  -0.537585  0.525384
     std    0.025662  0.344556
     min   -0.555730  0.281746
     25%   -0.546657  0.403565
     50%   -0.537585  0.525384
     75%   -0.528512  0.647203
     max   -0.519439  0.769023
</code></pre><p>导入一个数据集用于接下来更加高级的聚合操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tips = pd.read_csv(<span class="string">'ch08/tips.csv'</span>)</div><div class="line"><span class="comment"># Add tip percentage of total bill</span></div><div class="line">tips[<span class="string">'tip_pct'</span>] = tips[<span class="string">'tip'</span>] / tips[<span class="string">'total_bill'</span>]</div><div class="line">tips[:<span class="number">6</span>]</div></pre></td></tr></table></figure><pre><code>   total_bill   tip     sex smoker  day    time  size_   tip_pct
0       16.99  1.01  Female     No  Sun  Dinner      2  0.059447
1       10.34  1.66    Male     No  Sun  Dinner      3  0.160542
2       21.01  3.50    Male     No  Sun  Dinner      3  0.166587
3       23.68  3.31    Male     No  Sun  Dinner      2  0.139780
4       24.59  3.61  Female     No  Sun  Dinner      4  0.146808
5       25.29  4.71    Male     No  Sun  Dinner      4  0.186240
</code></pre><h3 id="面向列的多函数应用"><a href="#面向列的多函数应用" class="headerlink" title="面向列的多函数应用"></a>面向列的多函数应用</h3><p>根据性别以及是否吸烟进行分类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grouped = tips.groupby([<span class="string">'sex'</span>, <span class="string">'smoker'</span>])</div></pre></td></tr></table></figure><p>算出不同类型的顾客所给的小费占总花费的比例的平均值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grouped_pct = grouped[<span class="string">'tip_pct'</span>]</div><div class="line">grouped_pct.agg(<span class="string">'mean'</span>)</div></pre></td></tr></table></figure><pre><code>sex     smoker
Female  No        0.156921
        Yes       0.182150
Male    No        0.160669
        Yes       0.152771
Name: tip_pct, dtype: float64
</code></pre><p>同时算出比例的均值、标准差以及范围大小</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grouped_pct.agg([<span class="string">'mean'</span>, <span class="string">'std'</span>, peak_to_peak])</div></pre></td></tr></table></figure><pre><code>                   mean       std  peak_to_peak
sex    smoker                                  
Female No      0.156921  0.036421      0.195876
       Yes     0.182150  0.071595      0.360233
Male   No      0.160669  0.041849      0.220186
       Yes     0.152771  0.090588      0.674707
</code></pre><p>起一个别名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grouped_pct.agg([(<span class="string">'foo'</span>, <span class="string">'mean'</span>), (<span class="string">'bar'</span>, np.std)])</div></pre></td></tr></table></figure><pre><code>                    foo       bar
sex    smoker                    
Female No      0.156921  0.036421
       Yes     0.182150  0.071595
Male   No      0.160669  0.041849
       Yes     0.152771  0.090588
</code></pre><p>对分组后的数据的两个属性分别做三个不同的操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">functions = [<span class="string">'count'</span>, <span class="string">'mean'</span>, <span class="string">'max'</span>]</div><div class="line">result = grouped[<span class="string">'tip_pct'</span>, <span class="string">'total_bill'</span>].agg(functions)</div><div class="line">result</div></pre></td></tr></table></figure><pre><code>              tip_pct                     total_bill                  
                count      mean       max      count       mean    max
sex    smoker                                                         
Female No          54  0.156921  0.252672         54  18.105185  35.83
       Yes         33  0.182150  0.416667         33  17.977879  44.30
Male   No          97  0.160669  0.291990         97  19.791237  48.33
       Yes         60  0.152771  0.710345         60  22.284500  50.81
</code></pre><p>提取出上述两个属性中的一个</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result[<span class="string">'tip_pct'</span>]</div></pre></td></tr></table></figure><pre><code>               count      mean       max
sex    smoker                           
Female No         54  0.156921  0.252672
       Yes        33  0.182150  0.416667
Male   No         97  0.160669  0.291990
       Yes        60  0.152771  0.710345
</code></pre><p>对多个属性进行多个操作的同时进行起别名的操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ftuples = [(<span class="string">'Durchschnitt'</span>, <span class="string">'mean'</span>), (<span class="string">'Abweichung'</span>, np.var)]</div><div class="line">grouped[<span class="string">'tip_pct'</span>, <span class="string">'total_bill'</span>].agg(ftuples)</div></pre></td></tr></table></figure><pre><code>                   tip_pct              total_bill           
              Durchschnitt Abweichung Durchschnitt Abweichung
sex    smoker                                                
Female No         0.156921   0.001327    18.105185  53.092422
       Yes        0.182150   0.005126    17.977879  84.451517
Male   No         0.160669   0.001751    19.791237  76.152961
       Yes        0.152771   0.008206    22.284500  98.244673
</code></pre><p>对不同的列进行不同的操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grouped.agg(&#123;<span class="string">'tip'</span> : np.max, <span class="string">'size_'</span> : <span class="string">'sum'</span>&#125;)</div></pre></td></tr></table></figure><pre><code>               size_   tip
sex    smoker             
Female No        140   5.2
       Yes        74   6.5
Male   No        263   9.0
       Yes       150  10.0
</code></pre><p>对不同的列进行数量不同类型不同的操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grouped.agg(&#123;<span class="string">'tip_pct'</span> : [<span class="string">'min'</span>, <span class="string">'max'</span>, <span class="string">'mean'</span>, <span class="string">'std'</span>],</div><div class="line">             <span class="string">'size_'</span> : <span class="string">'sum'</span>&#125;)</div></pre></td></tr></table></figure><pre><code>                tip_pct                               size_
                    min       max      mean       std   sum
sex    smoker                                              
Female No      0.056797  0.252672  0.156921  0.036421   140
       Yes     0.056433  0.416667  0.182150  0.071595    74
Male   No      0.071804  0.291990  0.160669  0.041849   263
       Yes     0.035638  0.710345  0.152771  0.090588   150
</code></pre><h3 id="以无索引的形式返回聚合数据"><a href="#以无索引的形式返回聚合数据" class="headerlink" title="以无索引的形式返回聚合数据"></a>以无索引的形式返回聚合数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips.groupby([<span class="string">'sex'</span>, <span class="string">'smoker'</span>], as_index=<span class="keyword">False</span>).mean()</div></pre></td></tr></table></figure><pre><code>      sex smoker  total_bill       tip     size_   tip_pct
0  Female     No   18.105185  2.773519  2.592593  0.156921
1  Female    Yes   17.977879  2.931515  2.242424  0.182150
2    Male     No   19.791237  3.113402  2.711340  0.160669
3    Male    Yes   22.284500  3.051167  2.500000  0.152771
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips.groupby([<span class="string">'sex'</span>, <span class="string">'smoker'</span>], as_index=<span class="keyword">True</span>).mean()</div></pre></td></tr></table></figure><pre><code>               total_bill       tip     size_   tip_pct
sex    smoker                                          
Female No       18.105185  2.773519  2.592593  0.156921
       Yes      17.977879  2.931515  2.242424  0.182150
Male   No       19.791237  3.113402  2.711340  0.160669
       Yes      22.284500  3.051167  2.500000  0.152771
</code></pre><h2 id="分组级运算和转换"><a href="#分组级运算和转换" class="headerlink" title="分组级运算和转换"></a>分组级运算和转换</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df</div></pre></td></tr></table></figure><pre><code>      data1     data2 key1 key2
0 -0.204708  1.393406    a  one
1  0.478943  0.092908    a  two
2 -0.519439  0.281746    b  one
3 -0.555730  0.769023    b  two
4  1.965781  1.246435    a  one
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">k1_means = df.groupby(<span class="string">'key1'</span>).mean().add_prefix(<span class="string">'mean_'</span>)</div><div class="line">k1_means</div></pre></td></tr></table></figure><pre><code>      mean_data1  mean_data2
key1                        
a       0.746672    0.910916
b      -0.537585    0.525384
</code></pre><p>保留原索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(df, k1_means, left_on=<span class="string">'key1'</span>, right_index=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><pre><code>      data1     data2 key1 key2  mean_data1  mean_data2
0 -0.204708  1.393406    a  one    0.746672    0.910916
1  0.478943  0.092908    a  two    0.746672    0.910916
4  1.965781  1.246435    a  one    0.746672    0.910916
2 -0.519439  0.281746    b  one   -0.537585    0.525384
3 -0.555730  0.769023    b  two   -0.537585    0.525384
</code></pre><p>另一个例子，以更简洁的方式实现上述功能</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">people</div></pre></td></tr></table></figure><pre><code>               a         b         c         d         e
Joe     1.007189 -1.296221  0.274992  0.228913  1.352917
Steve   0.886429 -2.001637 -0.371843  1.669025 -0.438570
Wes    -0.539741       NaN       NaN -1.021228 -0.577087
Jim     0.124121  0.302614  0.523772  0.000940  1.343810
Travis -0.713544 -0.831154 -2.370232 -1.860761 -0.860757
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">key = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'one'</span>]</div><div class="line">people.groupby(key).mean()</div></pre></td></tr></table></figure><pre><code>            a         b         c         d         e
one -0.082032 -1.063687 -1.047620 -0.884358 -0.028309
two  0.505275 -0.849512  0.075965  0.834983  0.452620
</code></pre><p>将聚合后的结果放回原来数据中合适的位置（标量进行广播）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">people.groupby(key).transform(np.mean)</div></pre></td></tr></table></figure><pre><code>               a         b         c         d         e
Joe    -0.082032 -1.063687 -1.047620 -0.884358 -0.028309
Steve   0.505275 -0.849512  0.075965  0.834983  0.452620
Wes    -0.082032 -1.063687 -1.047620 -0.884358 -0.028309
Jim     0.505275 -0.849512  0.075965  0.834983  0.452620
Travis -0.082032 -1.063687 -1.047620 -0.884358 -0.028309
</code></pre><p>同时减去均值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">demean</span><span class="params">(arr)</span>:</span></div><div class="line">    <span class="keyword">return</span> arr - arr.mean()</div><div class="line">demeaned = people.groupby(key).transform(demean)</div><div class="line">demeaned</div></pre></td></tr></table></figure><pre><code>               a         b         c         d         e
Joe     1.089221 -0.232534  1.322612  1.113271  1.381226
Steve   0.381154 -1.152125 -0.447807  0.834043 -0.891190
Wes    -0.457709       NaN       NaN -0.136869 -0.548778
Jim    -0.381154  1.152125  0.447807 -0.834043  0.891190
Travis -0.631512  0.232534 -1.322612 -0.976402 -0.832448
</code></pre><p>检验一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">demeaned.groupby(key).mean()</div></pre></td></tr></table></figure><pre><code>                a             b    c             d    e
one  0.000000e+00 -1.110223e-16  0.0  7.401487e-17  0.0
two -2.775558e-17  0.000000e+00  0.0  0.000000e+00  0.0
</code></pre><h3 id="Apply-一般性的-“拆分-应用-合并”"><a href="#Apply-一般性的-“拆分-应用-合并”" class="headerlink" title="Apply: 一般性的 “拆分-应用-合并”"></a>Apply: 一般性的 “拆分-应用-合并”</h3><p>小费数据，根据某一个属性从大到小进行排序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">top</span><span class="params">(df, n=<span class="number">5</span>, column=<span class="string">'tip_pct'</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> df.sort_values(by=column)[-n:]</div><div class="line">top(tips, n=<span class="number">6</span>)</div></pre></td></tr></table></figure><pre><code>     total_bill   tip     sex smoker  day    time  size_   tip_pct
109       14.31  4.00  Female    Yes  Sat  Dinner      2  0.279525
183       23.17  6.50    Male    Yes  Sun  Dinner      4  0.280535
232       11.61  3.39    Male     No  Sat  Dinner      2  0.291990
67         3.07  1.00  Female    Yes  Sat  Dinner      1  0.325733
178        9.60  4.00  Female    Yes  Sun  Dinner      2  0.416667
172        7.25  5.15    Male    Yes  Sun  Dinner      2  0.710345
</code></pre><p>在分组后的数据集上进行上述排序操作，说明分组后的每一组都是一个DataFrame对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips.groupby(<span class="string">'smoker'</span>).apply(top)</div></pre></td></tr></table></figure><pre><code>            total_bill   tip     sex smoker   day    time  size_   tip_pct
smoker                                                                    
No     88        24.71  5.85    Male     No  Thur   Lunch      2  0.236746
       185       20.69  5.00    Male     No   Sun  Dinner      5  0.241663
       51        10.29  2.60  Female     No   Sun  Dinner      2  0.252672
       149        7.51  2.00    Male     No  Thur   Lunch      2  0.266312
       232       11.61  3.39    Male     No   Sat  Dinner      2  0.291990
Yes    109       14.31  4.00  Female    Yes   Sat  Dinner      2  0.279525
       183       23.17  6.50    Male    Yes   Sun  Dinner      4  0.280535
       67         3.07  1.00  Female    Yes   Sat  Dinner      1  0.325733
       178        9.60  4.00  Female    Yes   Sun  Dinner      2  0.416667
       172        7.25  5.15    Male    Yes   Sun  Dinner      2  0.710345
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips.groupby([<span class="string">'smoker'</span>, <span class="string">'day'</span>]).apply(top, n=<span class="number">1</span>, column=<span class="string">'total_bill'</span>)</div></pre></td></tr></table></figure><pre><code>                 total_bill    tip     sex smoker   day    time  size_  \
smoker day                                                               
No     Fri  94        22.75   3.25  Female     No   Fri  Dinner      2   
       Sat  212       48.33   9.00    Male     No   Sat  Dinner      4   
       Sun  156       48.17   5.00    Male     No   Sun  Dinner      6   
       Thur 142       41.19   5.00    Male     No  Thur   Lunch      5   
Yes    Fri  95        40.17   4.73    Male    Yes   Fri  Dinner      4   
       Sat  170       50.81  10.00    Male    Yes   Sat  Dinner      3   
       Sun  182       45.35   3.50    Male    Yes   Sun  Dinner      3   
       Thur 197       43.11   5.00  Female    Yes  Thur   Lunch      4   

                  tip_pct  
smoker day                 
No     Fri  94   0.142857  
       Sat  212  0.186220  
       Sun  156  0.103799  
       Thur 142  0.121389  
Yes    Fri  95   0.117750  
       Sat  170  0.196812  
       Sun  182  0.077178  
       Thur 197  0.115982  
</code></pre><p>获取分组后数据某一列的统计数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">result = tips.groupby(<span class="string">'smoker'</span>)[<span class="string">'tip_pct'</span>].describe()</div><div class="line">result</div></pre></td></tr></table></figure><pre><code>smoker       
No      count    151.000000
        mean       0.159328
        std        0.039910
        min        0.056797
        25%        0.136906
        50%        0.155625
        75%        0.185014
        max        0.291990
Yes     count     93.000000
        mean       0.163196
        std        0.085119
        min        0.035638
        25%        0.106771
        50%        0.153846
        75%        0.195059
        max        0.710345
Name: tip_pct, dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result.unstack(<span class="string">'smoker'</span>)</div></pre></td></tr></table></figure><pre><code>smoker          No        Yes
count   151.000000  93.000000
mean      0.159328   0.163196
std       0.039910   0.085119
min       0.056797   0.035638
25%       0.136906   0.106771
50%       0.155625   0.153846
75%       0.185014   0.195059
max       0.291990   0.710345
</code></pre><p>grouped 根据性别以及是否吸烟进行分组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">f = <span class="keyword">lambda</span> x: x.describe()</div><div class="line">grouped.apply(f)</div></pre></td></tr></table></figure><pre><code>                     total_bill        tip      size_    tip_pct
sex    smoker                                                   
Female No     count   54.000000  54.000000  54.000000  54.000000
              mean    18.105185   2.773519   2.592593   0.156921
              std      7.286455   1.128425   1.073146   0.036421
              min      7.250000   1.000000   1.000000   0.056797
              25%     12.650000   2.000000   2.000000   0.139708
              50%     16.690000   2.680000   2.000000   0.149691
              75%     20.862500   3.437500   3.000000   0.181630
              max     35.830000   5.200000   6.000000   0.252672
       Yes    count   33.000000  33.000000  33.000000  33.000000
              mean    17.977879   2.931515   2.242424   0.182150
              std      9.189751   1.219916   0.613917   0.071595
              min      3.070000   1.000000   1.000000   0.056433
              25%     12.760000   2.000000   2.000000   0.152439
              50%     16.270000   2.880000   2.000000   0.173913
              75%     22.120000   3.500000   2.000000   0.198216
              max     44.300000   6.500000   4.000000   0.416667
Male   No     count   97.000000  97.000000  97.000000  97.000000
              mean    19.791237   3.113402   2.711340   0.160669
              std      8.726566   1.489559   0.989094   0.041849
              min      7.510000   1.250000   2.000000   0.071804
              25%     13.810000   2.000000   2.000000   0.131810
              50%     18.240000   2.740000   2.000000   0.157604
              75%     22.820000   3.710000   3.000000   0.186220
              max     48.330000   9.000000   6.000000   0.291990
       Yes    count   60.000000  60.000000  60.000000  60.000000
              mean    22.284500   3.051167   2.500000   0.152771
              std      9.911845   1.500120   0.892530   0.090588
              min      7.250000   1.000000   1.000000   0.035638
              25%     15.272500   2.000000   2.000000   0.101845
              50%     20.390000   3.000000   2.000000   0.141015
              75%     28.572500   3.820000   3.000000   0.191697
              max     50.810000  10.000000   5.000000   0.710345
</code></pre><h4 id="禁止分组键"><a href="#禁止分组键" class="headerlink" title="禁止分组键"></a>禁止分组键</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips.groupby(<span class="string">'smoker'</span>, group_keys=<span class="keyword">True</span>).apply(top)</div></pre></td></tr></table></figure><pre><code>            total_bill   tip     sex smoker   day    time  size_   tip_pct
smoker                                                                    
No     88        24.71  5.85    Male     No  Thur   Lunch      2  0.236746
       185       20.69  5.00    Male     No   Sun  Dinner      5  0.241663
       51        10.29  2.60  Female     No   Sun  Dinner      2  0.252672
       149        7.51  2.00    Male     No  Thur   Lunch      2  0.266312
       232       11.61  3.39    Male     No   Sat  Dinner      2  0.291990
Yes    109       14.31  4.00  Female    Yes   Sat  Dinner      2  0.279525
       183       23.17  6.50    Male    Yes   Sun  Dinner      4  0.280535
       67         3.07  1.00  Female    Yes   Sat  Dinner      1  0.325733
       178        9.60  4.00  Female    Yes   Sun  Dinner      2  0.416667
       172        7.25  5.15    Male    Yes   Sun  Dinner      2  0.710345
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips.groupby(<span class="string">'smoker'</span>, group_keys=<span class="keyword">False</span>).apply(top)</div></pre></td></tr></table></figure><pre><code>     total_bill   tip     sex smoker   day    time  size_   tip_pct
88        24.71  5.85    Male     No  Thur   Lunch      2  0.236746
185       20.69  5.00    Male     No   Sun  Dinner      5  0.241663
51        10.29  2.60  Female     No   Sun  Dinner      2  0.252672
149        7.51  2.00    Male     No  Thur   Lunch      2  0.266312
232       11.61  3.39    Male     No   Sat  Dinner      2  0.291990
109       14.31  4.00  Female    Yes   Sat  Dinner      2  0.279525
183       23.17  6.50    Male    Yes   Sun  Dinner      4  0.280535
67         3.07  1.00  Female    Yes   Sat  Dinner      1  0.325733
178        9.60  4.00  Female    Yes   Sun  Dinner      2  0.416667
172        7.25  5.15    Male    Yes   Sun  Dinner      2  0.710345
</code></pre><h3 id="分位数与桶分析"><a href="#分位数与桶分析" class="headerlink" title="分位数与桶分析"></a>分位数与桶分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">frame = DataFrame(&#123;<span class="string">'data1'</span>: np.random.randn(<span class="number">1000</span>),</div><div class="line">                   <span class="string">'data2'</span>: np.random.randn(<span class="number">1000</span>)&#125;)</div><div class="line">factor = pd.cut(frame.data1, <span class="number">4</span>)</div><div class="line">factor[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>0     (-1.23, 0.489]
1    (-2.956, -1.23]
2     (-1.23, 0.489]
3     (0.489, 2.208]
4     (-1.23, 0.489]
5     (0.489, 2.208]
6     (-1.23, 0.489]
7     (-1.23, 0.489]
8     (0.489, 2.208]
9     (0.489, 2.208]
Name: data1, dtype: category
Categories (4, object): [(-2.956, -1.23] &lt; (-1.23, 0.489] &lt; (0.489, 2.208] &lt; (2.208, 3.928]]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_stats</span><span class="params">(group)</span>:</span></div><div class="line">    <span class="keyword">return</span> &#123;<span class="string">'min'</span>: group.min(), <span class="string">'max'</span>: group.max(),</div><div class="line">            <span class="string">'count'</span>: group.count(), <span class="string">'mean'</span>: group.mean()&#125;</div><div class="line"></div><div class="line">grouped = frame.data2.groupby(factor)</div><div class="line">grouped.apply(get_stats).unstack()</div><div class="line"></div><div class="line"><span class="comment">#ADAPT the output is not sorted in the book while this is the case now (swap first two lines)</span></div></pre></td></tr></table></figure><pre><code>                 count       max      mean       min
data1                                               
(-2.956, -1.23]   95.0  1.670835 -0.039521 -3.399312
(-1.23, 0.489]   598.0  3.260383 -0.002051 -2.989741
(0.489, 2.208]   297.0  2.954439  0.081822 -3.745356
(2.208, 3.928]    10.0  1.765640  0.024750 -1.929776
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Return quantile numbers</span></div><div class="line">grouping = pd.qcut(frame.data1, <span class="number">10</span>, labels=<span class="keyword">False</span>)</div><div class="line"></div><div class="line">grouped = frame.data2.groupby(grouping)</div><div class="line">grouped.apply(get_stats).unstack()</div></pre></td></tr></table></figure><pre><code>       count       max      mean       min
data1                                     
0      100.0  1.670835 -0.049902 -3.399312
1      100.0  2.628441  0.030989 -1.950098
2      100.0  2.527939 -0.067179 -2.925113
3      100.0  3.260383  0.065713 -2.315555
4      100.0  2.074345 -0.111653 -2.047939
5      100.0  2.184810  0.052130 -2.989741
6      100.0  2.458842 -0.021489 -2.223506
7      100.0  2.954439 -0.026459 -3.056990
8      100.0  2.735527  0.103406 -3.745356
9      100.0  2.377020  0.220122 -2.064111
</code></pre><h3 id="Example-用特定分组的值填充缺失值"><a href="#Example-用特定分组的值填充缺失值" class="headerlink" title="Example: 用特定分组的值填充缺失值"></a>Example: 用特定分组的值填充缺失值</h3><p>填一些缺失值进去</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s = Series(np.random.randn(<span class="number">6</span>))</div><div class="line">s[::<span class="number">2</span>] = np.nan</div><div class="line">s</div></pre></td></tr></table></figure><pre><code>0         NaN
1   -0.125921
2         NaN
3   -0.884475
4         NaN
5    0.227290
dtype: float64
</code></pre><p>用均值填充缺失值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.fillna(s.mean())</div></pre></td></tr></table></figure><pre><code>0   -0.261035
1   -0.125921
2   -0.261035
3   -0.884475
4   -0.261035
5    0.227290
dtype: float64
</code></pre><p>同样，填一些缺失值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">states = [<span class="string">'Ohio'</span>, <span class="string">'New York'</span>, <span class="string">'Vermont'</span>, <span class="string">'Florida'</span>,</div><div class="line">          <span class="string">'Oregon'</span>, <span class="string">'Nevada'</span>, <span class="string">'California'</span>, <span class="string">'Idaho'</span>]</div><div class="line">group_key = [<span class="string">'East'</span>] * <span class="number">4</span> + [<span class="string">'West'</span>] * <span class="number">4</span></div><div class="line">data = Series(np.random.randn(<span class="number">8</span>), index=states)</div><div class="line">data[[<span class="string">'Vermont'</span>, <span class="string">'Nevada'</span>, <span class="string">'Idaho'</span>]] = np.nan</div><div class="line">data</div></pre></td></tr></table></figure><pre><code>Ohio          0.922264
New York     -2.153545
Vermont            NaN
Florida      -0.375842
Oregon        0.329939
Nevada             NaN
California    1.105913
Idaho              NaN
dtype: float64
</code></pre><p>计算分组均值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.groupby(group_key).mean()</div></pre></td></tr></table></figure><pre><code>East   -0.535707
West    0.717926
dtype: float64
</code></pre><p>这里的<code>g</code>指代调用<code>apply</code>的主体，也就是<code>data.groupby(group_key)</code>分组后的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fill_mean = <span class="keyword">lambda</span> g: g.fillna(g.mean())</div><div class="line">data.groupby(group_key).apply(fill_mean)</div></pre></td></tr></table></figure><pre><code>Ohio          0.922264
New York     -2.153545
Vermont      -0.535707
Florida      -0.375842
Oregon        0.329939
Nevada        0.717926
California    1.105913
Idaho         0.717926
dtype: float64
</code></pre><p>由于<code>groupby</code>操作后得到的结果类似于一个字典，字典<code>key</code>是组名，<code>value</code>是一个<code>DataFrame Object</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fill_values = &#123;<span class="string">'East'</span>: <span class="number">0.5</span>, <span class="string">'West'</span>: <span class="number">-1</span>&#125;</div><div class="line">fill_func = <span class="keyword">lambda</span> g: g.fillna(fill_values[g.name])</div><div class="line"></div><div class="line">data.groupby(group_key).apply(fill_func)</div></pre></td></tr></table></figure><pre><code>Ohio          0.922264
New York     -2.153545
Vermont       0.500000
Florida      -0.375842
Oregon        0.329939
Nevada       -1.000000
California    1.105913
Idaho        -1.000000
dtype: float64
</code></pre><h3 id="Example-随机采样和排列"><a href="#Example-随机采样和排列" class="headerlink" title="Example: 随机采样和排列"></a>Example: 随机采样和排列</h3><p>构造扑克牌</p><p>红桃<code>Hearts</code>, 黑桃<code>Spades</code>, 梅花<code>Clubs</code>, 方片<code>Diamonds</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Hearts, Spades, Clubs, Diamonds</span></div><div class="line">suits = [<span class="string">'H'</span>, <span class="string">'S'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>]</div><div class="line">card_val = (list(range(<span class="number">1</span>, <span class="number">11</span>)) + [<span class="number">10</span>] * <span class="number">3</span>) * <span class="number">4</span></div><div class="line">base_names = [<span class="string">'A'</span>] + range(<span class="number">2</span>, <span class="number">11</span>) + [<span class="string">'J'</span>, <span class="string">'K'</span>, <span class="string">'Q'</span>]</div><div class="line">cards = []</div><div class="line"><span class="keyword">for</span> suit <span class="keyword">in</span> [<span class="string">'H'</span>, <span class="string">'S'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>]:</div><div class="line">    cards.extend(str(num) + suit <span class="keyword">for</span> num <span class="keyword">in</span> base_names)</div><div class="line"></div><div class="line">deck = Series(card_val, index=cards)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">deck[:<span class="number">13</span>]</div></pre></td></tr></table></figure><pre><code>AH      1
2H      2
3H      3
4H      4
5H      5
6H      6
7H      7
8H      8
9H      9
10H    10
JH     10
KH     10
QH     10
dtype: int64
</code></pre><p>随机抽牌</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw</span><span class="params">(deck, n=<span class="number">5</span>)</span>:</span></div><div class="line">    <span class="keyword">return</span> deck.take(np.random.permutation(len(deck))[:n])</div><div class="line">draw(deck)</div></pre></td></tr></table></figure><pre><code>AD     1
8C     8
5H     5
KC    10
2C     2
dtype: int64
</code></pre><p>分类抽牌</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">get_suit = <span class="keyword">lambda</span> card: card[<span class="number">-1</span>] <span class="comment"># last letter is suit</span></div><div class="line">deck.groupby(get_suit).apply(draw, n=<span class="number">2</span>)</div></pre></td></tr></table></figure><pre><code>C  2C     2
   3C     3
D  KD    10
   8D     8
H  KH    10
   3H     3
S  2S     2
   4S     4
dtype: int64
</code></pre><p>去掉分组键</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># alternatively</span></div><div class="line">deck.groupby(get_suit, group_keys=<span class="keyword">False</span>).apply(draw, n=<span class="number">2</span>)</div></pre></td></tr></table></figure><pre><code>KC    10
JC    10
AD     1
5D     5
5H     5
6H     6
7S     7
KS    10
dtype: int64
</code></pre><h3 id="Example-分组加权平均数和相关系数"><a href="#Example-分组加权平均数和相关系数" class="headerlink" title="Example: 分组加权平均数和相关系数"></a>Example: 分组加权平均数和相关系数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">df = DataFrame(&#123;<span class="string">'category'</span>: [<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>],</div><div class="line">                <span class="string">'data'</span>: np.random.randn(<span class="number">8</span>),</div><div class="line">                <span class="string">'weights'</span>: np.random.rand(<span class="number">8</span>)&#125;)</div><div class="line">df</div></pre></td></tr></table></figure><pre><code>  category      data   weights
0        a  1.561587  0.957515
1        a  1.219984  0.347267
2        a -0.482239  0.581362
3        a  0.315667  0.217091
4        b -0.047852  0.894406
5        b -0.454145  0.918564
6        b -0.556774  0.277825
7        b  0.253321  0.955905
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">grouped = df.groupby(<span class="string">'category'</span>)</div><div class="line">get_wavg = <span class="keyword">lambda</span> g: np.average(g[<span class="string">'data'</span>], weights=g[<span class="string">'weights'</span>])</div><div class="line">grouped.apply(get_wavg)</div></pre></td></tr></table></figure><pre><code>category
a    0.811643
b   -0.122262
dtype: float64
</code></pre><p><code>stock</code>数据集</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">close_px = pd.read_csv(<span class="string">'ch09/stock_px.csv'</span>, parse_dates=<span class="keyword">True</span>, index_col=<span class="number">0</span>)</div><div class="line">close_px.info()</div></pre></td></tr></table></figure><pre><code>&lt;class &apos;pandas.core.frame.DataFrame&apos;&gt;
DatetimeIndex: 2214 entries, 2003-01-02 to 2011-10-14
Data columns (total 4 columns):
AAPL    2214 non-null float64
MSFT    2214 non-null float64
XOM     2214 non-null float64
SPX     2214 non-null float64
dtypes: float64(4)
memory usage: 86.5 KB
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">close_px[<span class="number">-4</span>:]</div></pre></td></tr></table></figure><pre><code>              AAPL   MSFT    XOM      SPX
2011-10-11  400.29  27.00  76.27  1195.54
2011-10-12  402.19  26.96  77.16  1207.25
2011-10-13  408.43  27.18  76.37  1203.66
2011-10-14  422.00  27.27  78.11  1224.58
</code></pre><p>计算相关系数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">rets = close_px.pct_change().dropna()</div><div class="line">spx_corr = <span class="keyword">lambda</span> x: x.corrwith(x[<span class="string">'SPX'</span>])</div><div class="line">by_year = rets.groupby(<span class="keyword">lambda</span> x: x.year)</div><div class="line">by_year.apply(spx_corr)</div></pre></td></tr></table></figure><pre><code>          AAPL      MSFT       XOM  SPX
2003  0.541124  0.745174  0.661265  1.0
2004  0.374283  0.588531  0.557742  1.0
2005  0.467540  0.562374  0.631010  1.0
2006  0.428267  0.406126  0.518514  1.0
2007  0.508118  0.658770  0.786264  1.0
2008  0.681434  0.804626  0.828303  1.0
2009  0.707103  0.654902  0.797921  1.0
2010  0.710105  0.730118  0.839057  1.0
2011  0.691931  0.800996  0.859975  1.0
</code></pre><p><code>lambda</code>看来有很大用处</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Annual correlation of Apple with Microsoft</span></div><div class="line">by_year.apply(<span class="keyword">lambda</span> g: g[<span class="string">'AAPL'</span>].corr(g[<span class="string">'MSFT'</span>]))</div></pre></td></tr></table></figure><pre><code>2003    0.480868
2004    0.259024
2005    0.300093
2006    0.161735
2007    0.417738
2008    0.611901
2009    0.432738
2010    0.571946
2011    0.581987
dtype: float64
</code></pre><h3 id="Example-分组级线型回归"><a href="#Example-分组级线型回归" class="headerlink" title="Example: 分组级线型回归"></a>Example: 分组级线型回归</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">regress</span><span class="params">(data, yvar, xvars)</span>:</span></div><div class="line">    Y = data[yvar]</div><div class="line">    X = data[xvars]</div><div class="line">    X[<span class="string">'intercept'</span>] = <span class="number">1.</span></div><div class="line">    result = sm.OLS(Y, X).fit()</div><div class="line">    <span class="keyword">return</span> result.params</div></pre></td></tr></table></figure><p>这样传参</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">by_year.apply(regress, <span class="string">'AAPL'</span>, [<span class="string">'SPX'</span>])</div></pre></td></tr></table></figure><pre><code>           SPX  intercept
2003  1.195406   0.000710
2004  1.363463   0.004201
2005  1.766415   0.003246
2006  1.645496   0.000080
2007  1.198761   0.003438
2008  0.968016  -0.001110
2009  0.879103   0.002954
2010  1.052608   0.001261
2011  0.806605   0.001514
</code></pre><h2 id="透视表和交叉表"><a href="#透视表和交叉表" class="headerlink" title="透视表和交叉表"></a>透视表和交叉表</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>   total_bill   tip     sex smoker  day    time  size_   tip_pct
0       16.99  1.01  Female     No  Sun  Dinner      2  0.059447
1       10.34  1.66    Male     No  Sun  Dinner      3  0.160542
2       21.01  3.50    Male     No  Sun  Dinner      3  0.166587
3       23.68  3.31    Male     No  Sun  Dinner      2  0.139780
4       24.59  3.61  Female     No  Sun  Dinner      4  0.146808
5       25.29  4.71    Male     No  Sun  Dinner      4  0.186240
6        8.77  2.00    Male     No  Sun  Dinner      2  0.228050
7       26.88  3.12    Male     No  Sun  Dinner      4  0.116071
8       15.04  1.96    Male     No  Sun  Dinner      2  0.130319
9       14.78  3.23    Male     No  Sun  Dinner      2  0.218539
</code></pre><p><code>pivot_table</code>默认情况相当于分组后进行<code>mean()</code>操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips.pivot_table(index=[<span class="string">'sex'</span>, <span class="string">'smoker'</span>])</div></pre></td></tr></table></figure><pre><code>                  size_       tip   tip_pct  total_bill
sex    smoker                                          
Female No      2.592593  2.773519  0.156921   18.105185
       Yes     2.242424  2.931515  0.182150   17.977879
Male   No      2.711340  3.113402  0.160669   19.791237
       Yes     2.500000  3.051167  0.152771   22.284500
</code></pre><p>指定分组度量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tips.pivot_table([<span class="string">'tip_pct'</span>, <span class="string">'size_'</span>], index=[<span class="string">'sex'</span>, <span class="string">'day'</span>],</div><div class="line">                 columns=<span class="string">'smoker'</span>)</div></pre></td></tr></table></figure><pre><code>              tip_pct               size_          
smoker             No       Yes        No       Yes
sex    day                                         
Female Fri   0.165296  0.209129  2.500000  2.000000
       Sat   0.147993  0.163817  2.307692  2.200000
       Sun   0.165710  0.237075  3.071429  2.500000
       Thur  0.155971  0.163073  2.480000  2.428571
Male   Fri   0.138005  0.144730  2.000000  2.125000
       Sat   0.162132  0.139067  2.656250  2.629630
       Sun   0.158291  0.173964  2.883721  2.600000
       Thur  0.165706  0.164417  2.500000  2.300000
</code></pre><p>增加ALL列</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tips.pivot_table([<span class="string">'tip_pct'</span>, <span class="string">'size_'</span>], index=[<span class="string">'sex'</span>, <span class="string">'day'</span>],</div><div class="line">                 columns=<span class="string">'smoker'</span>, margins=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><pre><code>              tip_pct                         size_                    
smoker             No       Yes       All        No       Yes       All
sex    day                                                             
Female Fri   0.165296  0.209129  0.199388  2.500000  2.000000  2.111111
       Sat   0.147993  0.163817  0.156470  2.307692  2.200000  2.250000
       Sun   0.165710  0.237075  0.181569  3.071429  2.500000  2.944444
       Thur  0.155971  0.163073  0.157525  2.480000  2.428571  2.468750
Male   Fri   0.138005  0.144730  0.143385  2.000000  2.125000  2.100000
       Sat   0.162132  0.139067  0.151577  2.656250  2.629630  2.644068
       Sun   0.158291  0.173964  0.162344  2.883721  2.600000  2.810345
       Thur  0.165706  0.164417  0.165276  2.500000  2.300000  2.433333
All          0.159328  0.163196  0.160803  2.668874  2.408602  2.569672
</code></pre><p>更换一个分组度量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tips.pivot_table(<span class="string">'tip_pct'</span>, index=[<span class="string">'sex'</span>, <span class="string">'smoker'</span>], columns=<span class="string">'day'</span>,</div><div class="line">                 aggfunc=len, margins=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><pre><code>day             Fri   Sat   Sun  Thur    All
sex    smoker                               
Female No       2.0  13.0  14.0  25.0   54.0
       Yes      7.0  15.0   4.0   7.0   33.0
Male   No       2.0  32.0  43.0  20.0   97.0
       Yes      8.0  27.0  15.0  10.0   60.0
All            19.0  87.0  76.0  62.0  244.0
</code></pre><p>分组计数并填充（可能存在空组合）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tips.pivot_table(<span class="string">'size_'</span>, index=[<span class="string">'time'</span>, <span class="string">'sex'</span>, <span class="string">'smoker'</span>],</div><div class="line">                 columns=<span class="string">'day'</span>, aggfunc=<span class="string">'sum'</span>, fill_value=<span class="number">0</span>)</div></pre></td></tr></table></figure><pre><code>day                   Fri  Sat  Sun  Thur
time   sex    smoker                     
Dinner Female No        2   30   43     2
              Yes       8   33   10     0
       Male   No        4   85  124     0
              Yes      12   71   39     0
Lunch  Female No        3    0    0    60
              Yes       6    0    0    17
       Male   No        0    0    0    50
              Yes       5    0    0    23
</code></pre><h3 id="交叉表-crosstab"><a href="#交叉表-crosstab" class="headerlink" title="交叉表: crosstab"></a>交叉表: crosstab</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> StringIO <span class="keyword">import</span> StringIO</div><div class="line">data = <span class="string">"""\</span></div><div class="line">Sample    Gender    Handedness</div><div class="line">1    Female    Right-handed</div><div class="line">2    Male    Left-handed</div><div class="line">3    Female    Right-handed</div><div class="line">4    Male    Right-handed</div><div class="line">5    Male    Left-handed</div><div class="line">6    Male    Right-handed</div><div class="line">7    Female    Right-handed</div><div class="line">8    Female    Left-handed</div><div class="line">9    Male    Right-handed</div><div class="line">10    Female    Right-handed"""</div><div class="line">data = pd.read_table(StringIO(data), sep=<span class="string">'\s+'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data</div></pre></td></tr></table></figure><pre><code>   Sample  Gender    Handedness
0       1  Female  Right-handed
1       2    Male   Left-handed
2       3  Female  Right-handed
3       4    Male  Right-handed
4       5    Male   Left-handed
5       6    Male  Right-handed
6       7  Female  Right-handed
7       8  Female   Left-handed
8       9    Male  Right-handed
9      10  Female  Right-handed
</code></pre><p>交叉表就是在…计数…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.crosstab(data.Gender, data.Handedness, margins=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><pre><code>Handedness  Left-handed  Right-handed  All
Gender                                    
Female                1             4    5
Male                  2             3    5
All                   3             7   10
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.crosstab([tips.time, tips.day], tips.smoker, margins=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><pre><code>smoker        No  Yes  All
time   day                
Dinner Fri     3    9   12
       Sat    45   42   87
       Sun    57   19   76
       Thur    1    0    1
Lunch  Fri     1    6    7
       Thur   44   17   61
All          151   93  244
</code></pre><h2 id="Example-2012-联邦选举委员会数据库"><a href="#Example-2012-联邦选举委员会数据库" class="headerlink" title="Example: 2012 联邦选举委员会数据库"></a>Example: 2012 联邦选举委员会数据库</h2><p>这个数据库包括赞助人的姓名，职业、雇主、地址以及出资额等信息</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec = pd.read_csv(<span class="string">'ch09/P00000001-ALL.csv'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec.info()</div></pre></td></tr></table></figure><pre><code>&lt;class &apos;pandas.core.frame.DataFrame&apos;&gt;
RangeIndex: 1001731 entries, 0 to 1001730
Data columns (total 16 columns):
cmte_id              1001731 non-null object
cand_id              1001731 non-null object
cand_nm              1001731 non-null object
contbr_nm            1001731 non-null object
contbr_city          1001712 non-null object
contbr_st            1001727 non-null object
contbr_zip           1001620 non-null object
contbr_employer      988002 non-null object
contbr_occupation    993301 non-null object
contb_receipt_amt    1001731 non-null float64
contb_receipt_dt     1001731 non-null object
receipt_desc         14166 non-null object
memo_cd              92482 non-null object
memo_text            97770 non-null object
form_tp              1001731 non-null object
file_num             1001731 non-null int64
dtypes: float64(1), int64(1), object(14)
memory usage: 122.3+ MB
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec.ix[<span class="number">123456</span>]</div></pre></td></tr></table></figure><pre><code>cmte_id                             C00431445
cand_id                             P80003338
cand_nm                         Obama, Barack
contbr_nm                         ELLMAN, IRA
contbr_city                             TEMPE
contbr_st                                  AZ
contbr_zip                          852816719
contbr_employer      ARIZONA STATE UNIVERSITY
contbr_occupation                   PROFESSOR
contb_receipt_amt                          50
contb_receipt_dt                    01-DEC-11
receipt_desc                              NaN
memo_cd                                   NaN
memo_text                                 NaN
form_tp                                 SA17A
file_num                               772372
Name: 123456, dtype: object
</code></pre><p>输出全部候选人名单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">unique_cands = fec.cand_nm.unique()</div><div class="line">unique_cands</div></pre></td></tr></table></figure><pre><code>array([&apos;Bachmann, Michelle&apos;, &apos;Romney, Mitt&apos;, &apos;Obama, Barack&apos;,
       &quot;Roemer, Charles E. &apos;Buddy&apos; III&quot;, &apos;Pawlenty, Timothy&apos;,
       &apos;Johnson, Gary Earl&apos;, &apos;Paul, Ron&apos;, &apos;Santorum, Rick&apos;, &apos;Cain, Herman&apos;,
       &apos;Gingrich, Newt&apos;, &apos;McCotter, Thaddeus G&apos;, &apos;Huntsman, Jon&apos;,
       &apos;Perry, Rick&apos;], dtype=object)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unique_cands[<span class="number">2</span>]</div></pre></td></tr></table></figure><pre><code>&apos;Obama, Barack&apos;
</code></pre><p>政党映射</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">parties = &#123;<span class="string">'Bachmann, Michelle'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Cain, Herman'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Gingrich, Newt'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Huntsman, Jon'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Johnson, Gary Earl'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'McCotter, Thaddeus G'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Obama, Barack'</span>: <span class="string">'Democrat'</span>,</div><div class="line">           <span class="string">'Paul, Ron'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Pawlenty, Timothy'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Perry, Rick'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">"Roemer, Charles E. 'Buddy' III"</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Romney, Mitt'</span>: <span class="string">'Republican'</span>,</div><div class="line">           <span class="string">'Santorum, Rick'</span>: <span class="string">'Republican'</span>&#125;</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec.cand_nm[<span class="number">123456</span>:<span class="number">123461</span>]</div></pre></td></tr></table></figure><pre><code>123456    Obama, Barack
123457    Obama, Barack
123458    Obama, Barack
123459    Obama, Barack
123460    Obama, Barack
Name: cand_nm, dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec.cand_nm[<span class="number">123456</span>:<span class="number">123461</span>].map(parties)</div></pre></td></tr></table></figure><pre><code>123456    Democrat
123457    Democrat
123458    Democrat
123459    Democrat
123460    Democrat
Name: cand_nm, dtype: object
</code></pre><p>根据以上创建的映射，在原数据集中添加一列<code>party</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Add it as a column</span></div><div class="line">fec[<span class="string">'party'</span>] = fec.cand_nm.map(parties)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec[<span class="string">'party'</span>].value_counts()</div></pre></td></tr></table></figure><pre><code>Democrat      593746
Republican    407985
Name: party, dtype: int64
</code></pre><p>看看出资额是正是负</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(fec.contb_receipt_amt &gt; <span class="number">0</span>).value_counts()</div></pre></td></tr></table></figure><pre><code>True     991475
False     10256
Name: contb_receipt_amt, dtype: int64
</code></pre><p>调整出资额为正</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec = fec[fec.contb_receipt_amt &gt; <span class="number">0</span>]</div></pre></td></tr></table></figure><p>筛选候选人</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec_mrbo = fec[fec.cand_nm.isin([<span class="string">'Obama, Barack'</span>, <span class="string">'Romney, Mitt'</span>])]</div></pre></td></tr></table></figure><h3 id="根据职业和雇主统计赞助信息"><a href="#根据职业和雇主统计赞助信息" class="headerlink" title="根据职业和雇主统计赞助信息"></a>根据职业和雇主统计赞助信息</h3><p>统计职业信息</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fec.contbr_occupation.value_counts()[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>RETIRED                                   233990
INFORMATION REQUESTED                      35107
ATTORNEY                                   34286
HOMEMAKER                                  29931
PHYSICIAN                                  23432
INFORMATION REQUESTED PER BEST EFFORTS     21138
ENGINEER                                   14334
TEACHER                                    13990
CONSULTANT                                 13273
PROFESSOR                                  12555
Name: contbr_occupation, dtype: int64
</code></pre><p>筛选出一些不符合规格的信息映射到正常信息</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">occ_mapping = &#123;</div><div class="line">   <span class="string">'INFORMATION REQUESTED PER BEST EFFORTS'</span> : <span class="string">'NOT PROVIDED'</span>,</div><div class="line">   <span class="string">'INFORMATION REQUESTED'</span> : <span class="string">'NOT PROVIDED'</span>,</div><div class="line">   <span class="string">'INFORMATION REQUESTED (BEST EFFORTS)'</span> : <span class="string">'NOT PROVIDED'</span>,</div><div class="line">   <span class="string">'C.E.O.'</span>: <span class="string">'CEO'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># If no mapping provided, return x</span></div><div class="line">f = <span class="keyword">lambda</span> x: occ_mapping.get(x, x)</div><div class="line">fec.contbr_occupation = fec.contbr_occupation.map(f)</div></pre></td></tr></table></figure><p>以上巧妙运用了get方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">emp_mapping = &#123;</div><div class="line">   <span class="string">'INFORMATION REQUESTED PER BEST EFFORTS'</span> : <span class="string">'NOT PROVIDED'</span>,</div><div class="line">   <span class="string">'INFORMATION REQUESTED'</span> : <span class="string">'NOT PROVIDED'</span>,</div><div class="line">   <span class="string">'SELF'</span> : <span class="string">'SELF-EMPLOYED'</span>,</div><div class="line">   <span class="string">'SELF EMPLOYED'</span> : <span class="string">'SELF-EMPLOYED'</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># If no mapping provided, return x</span></div><div class="line">f = <span class="keyword">lambda</span> x: emp_mapping.get(x, x)</div><div class="line">fec.contbr_employer = fec.contbr_employer.map(f)</div></pre></td></tr></table></figure><p>根据职业以及候选人政党分组，统计出资额总和</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">by_occupation = fec.pivot_table(<span class="string">'contb_receipt_amt'</span>,</div><div class="line">                                index=<span class="string">'contbr_occupation'</span>,</div><div class="line">                                columns=<span class="string">'party'</span>, aggfunc=<span class="string">'sum'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">over_2mm = by_occupation[by_occupation.sum(<span class="number">1</span>) &gt; <span class="number">2000000</span>]</div><div class="line">over_2mm</div></pre></td></tr></table></figure><pre><code>party                 Democrat    Republican
contbr_occupation                           
ATTORNEY           11141982.97  7.477194e+06
CEO                 2074974.79  4.211041e+06
CONSULTANT          2459912.71  2.544725e+06
ENGINEER             951525.55  1.818374e+06
EXECUTIVE           1355161.05  4.138850e+06
HOMEMAKER           4248875.80  1.363428e+07
INVESTOR             884133.00  2.431769e+06
LAWYER              3160478.87  3.912243e+05
MANAGER              762883.22  1.444532e+06
NOT PROVIDED        4866973.96  2.056547e+07
OWNER               1001567.36  2.408287e+06
PHYSICIAN           3735124.94  3.594320e+06
PRESIDENT           1878509.95  4.720924e+06
PROFESSOR           2165071.08  2.967027e+05
REAL ESTATE          528902.09  1.625902e+06
RETIRED            25305116.38  2.356124e+07
SELF-EMPLOYED        672393.40  1.640253e+06
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">over_2mm.plot(kind=<span class="string">'barh'</span>)</div></pre></td></tr></table></figure><pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x340fb4e0&gt;
</code></pre><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch09/output_202_1.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_top_amounts</span><span class="params">(group, key, n=<span class="number">5</span>)</span>:</span></div><div class="line">    totals = group.groupby(key)[<span class="string">'contb_receipt_amt'</span>].sum()</div><div class="line"></div><div class="line">    <span class="comment"># Order totals by key in descending order</span></div><div class="line">    <span class="keyword">return</span> totals.sort_values()[-n:]</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grouped = fec_mrbo.groupby(<span class="string">'cand_nm'</span>)</div><div class="line">grouped.apply(get_top_amounts, <span class="string">'contbr_occupation'</span>, n=<span class="number">7</span>)</div></pre></td></tr></table></figure><pre><code>cand_nm        contbr_occupation                     
Obama, Barack  CONSULTANT                                 2459912.71
               LAWYER                                     3160478.87
               PHYSICIAN                                  3735124.94
               HOMEMAKER                                  4248875.80
               INFORMATION REQUESTED                      4866973.96
               ATTORNEY                                  11141982.97
               RETIRED                                   25305116.38
Romney, Mitt   C.E.O.                                     1968386.11
               EXECUTIVE                                  2300947.03
               PRESIDENT                                  2491244.89
               ATTORNEY                                   5364718.82
               HOMEMAKER                                  8147446.22
               INFORMATION REQUESTED PER BEST EFFORTS    11396894.84
               RETIRED                                   11508473.59
Name: contb_receipt_amt, dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grouped.apply(get_top_amounts, <span class="string">'contbr_employer'</span>, n=<span class="number">10</span>)</div></pre></td></tr></table></figure><pre><code>cand_nm        contbr_employer                       
Obama, Barack  MICROSOFT                                   215585.36
               VOLUNTEER                                   257104.00
               STUDENT                                     318831.45
               SELF EMPLOYED                               469290.00
               SELF                                       1076531.20
               HOMEMAKER                                  2605408.54
               INFORMATION REQUESTED                      5053480.37
               NOT EMPLOYED                               8586308.70
               SELF-EMPLOYED                             17080985.96
               RETIRED                                   22694358.85
Romney, Mitt   H.I.G. CAPITAL                              139500.00
               BARCLAYS CAPITAL                            162750.00
               GOLDMAN SACH &amp; CO.                          238250.00
               MORGAN STANLEY                              267266.00
               CREDIT SUISSE                               281150.00
               STUDENT                                     496490.94
               SELF-EMPLOYED                              7409860.98
               HOMEMAKER                                  8147196.22
               RETIRED                                   11506225.71
               INFORMATION REQUESTED PER BEST EFFORTS    12059527.24
Name: contb_receipt_amt, dtype: float64
</code></pre><h3 id="根据出资额分组"><a href="#根据出资额分组" class="headerlink" title="根据出资额分组"></a>根据出资额分组</h3><p>不出意外果然要用到桶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bins = np.array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">1000</span>, <span class="number">10000</span>, <span class="number">100000</span>, <span class="number">1000000</span>, <span class="number">10000000</span>])</div><div class="line">labels = pd.cut(fec_mrbo.contb_receipt_amt, bins)</div><div class="line">labels[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>411      (10, 100]
412    (100, 1000]
413    (100, 1000]
414      (10, 100]
415      (10, 100]
416      (10, 100]
417    (100, 1000]
418      (10, 100]
419    (100, 1000]
420      (10, 100]
Name: contb_receipt_amt, dtype: category
Categories (8, object): [(0, 1] &lt; (1, 10] &lt; (10, 100] &lt; (100, 1000] &lt; (1000, 10000] &lt; (10000, 100000] &lt; (100000, 1000000] &lt; (1000000, 10000000]]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grouped = fec_mrbo.groupby([<span class="string">'cand_nm'</span>, labels])</div><div class="line">grouped.size().unstack(<span class="number">0</span>)</div></pre></td></tr></table></figure><pre><code>cand_nm              Obama, Barack  Romney, Mitt
contb_receipt_amt                               
(0, 1]                       493.0          77.0
(1, 10]                    40070.0        3681.0
(10, 100]                 372280.0       31853.0
(100, 1000]               153991.0       43357.0
(1000, 10000]              22284.0       26186.0
(10000, 100000]                2.0           1.0
(100000, 1000000]              3.0           NaN
(1000000, 10000000]            4.0           NaN
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bucket_sums = grouped.contb_receipt_amt.sum().unstack(<span class="number">0</span>)</div><div class="line">bucket_sums</div></pre></td></tr></table></figure><pre><code>cand_nm              Obama, Barack  Romney, Mitt
contb_receipt_amt                               
(0, 1]                      318.24         77.00
(1, 10]                  337267.62      29819.66
(10, 100]              20288981.41    1987783.76
(100, 1000]            54798531.46   22363381.69
(1000, 10000]          51753705.67   63942145.42
(10000, 100000]           59100.00      12700.00
(100000, 1000000]       1490683.08           NaN
(1000000, 10000000]     7148839.76           NaN
</code></pre><p>计算比例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">normed_sums = bucket_sums.div(bucket_sums.sum(axis=<span class="number">1</span>), axis=<span class="number">0</span>)</div><div class="line">normed_sums</div></pre></td></tr></table></figure><pre><code>cand_nm              Obama, Barack  Romney, Mitt
contb_receipt_amt                               
(0, 1]                    0.805182      0.194818
(1, 10]                   0.918767      0.081233
(10, 100]                 0.910769      0.089231
(100, 1000]               0.710176      0.289824
(1000, 10000]             0.447326      0.552674
(10000, 100000]           0.823120      0.176880
(100000, 1000000]         1.000000           NaN
(1000000, 10000000]       1.000000           NaN
</code></pre><p>画个图看看</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">normed_sums[:<span class="number">-2</span>].plot(kind=<span class="string">'barh'</span>, stacked=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x14c4db00&gt;
</code></pre><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch09/output_214_1.png" alt="png"></p><h3 id="根据州统计赞助信息"><a href="#根据州统计赞助信息" class="headerlink" title="根据州统计赞助信息"></a>根据州统计赞助信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">grouped = fec_mrbo.groupby([<span class="string">'cand_nm'</span>, <span class="string">'contbr_st'</span>])</div><div class="line">totals = grouped.contb_receipt_amt.sum().unstack(<span class="number">0</span>).fillna(<span class="number">0</span>)</div><div class="line">totals = totals[totals.sum(<span class="number">1</span>) &gt; <span class="number">100000</span>]</div><div class="line">totals[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>cand_nm    Obama, Barack  Romney, Mitt
contbr_st                             
AK             281840.15      86204.24
AL             543123.48     527303.51
AR             359247.28     105556.00
AZ            1506476.98    1888436.23
CA           23824984.24   11237636.60
CO            2132429.49    1506714.12
CT            2068291.26    3499475.45
DC            4373538.80    1025137.50
DE             336669.14      82712.00
FL            7318178.58    8338458.81
</code></pre><p><code>Mitt is so...poorly...</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">percent = totals.div(totals.sum(<span class="number">1</span>), axis=<span class="number">0</span>)</div><div class="line">percent[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>cand_nm    Obama, Barack  Romney, Mitt
contbr_st                             
AK              0.765778      0.234222
AL              0.507390      0.492610
AR              0.772902      0.227098
AZ              0.443745      0.556255
CA              0.679498      0.320502
CO              0.585970      0.414030
CT              0.371476      0.628524
DC              0.810113      0.189887
DE              0.802776      0.197224
FL              0.467417      0.532583
</code></pre></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/05/python-data-analysis-learning-note-ch08/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Ewan Li"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Abracadabra"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Abracadabra" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2017/03/05/python-data-analysis-learning-note-ch08/" itemprop="url">python data analysis learning note ch08</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-05T22:55:28+08:00">2017-03-05 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2017/03/05/python-data-analysis-learning-note-ch08/#comments" itemprop="discussionUrl"><span class="post-comments-count hc-comment-count" data-xid="2017/03/05/python-data-analysis-learning-note-ch08/" itemprop="commentsCount"></span> </a></span><span id="/2017/03/05/python-data-analysis-learning-note-ch08/" class="leancloud_visitors" data-flag-title="python data analysis learning note ch08"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="绘图和可视化"><a href="#绘图和可视化" class="headerlink" title="绘图和可视化"></a>绘图和可视化</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><span class="keyword">from</span> numpy.random <span class="keyword">import</span> randn</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line">np.random.seed(<span class="number">12345</span>)</div><div class="line">plt.rc(<span class="string">'figure'</span>, figsize=(<span class="number">10</span>, <span class="number">6</span>))</div><div class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> Series, DataFrame</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line">np.set_printoptions(precision=<span class="number">4</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</div><div class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%matplotlib inline</div></pre></td></tr></table></figure><h2 id="matplotlib-API-入门"><a href="#matplotlib-API-入门" class="headerlink" title="matplotlib API 入门"></a>matplotlib API 入门</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div></pre></td></tr></table></figure><h3 id="Figure-和-Subplot"><a href="#Figure-和-Subplot" class="headerlink" title="Figure 和 Subplot"></a>Figure 和 Subplot</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fig = plt.figure()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ax1 = fig.add_subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ax2 = fig.add_subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>)</div><div class="line">ax3 = fig.add_subplot(<span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> numpy.random <span class="keyword">import</span> randn</div><div class="line">plt.plot(randn(<span class="number">50</span>).cumsum(), <span class="string">'k--'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_10_1.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">_ = ax1.hist(randn(<span class="number">100</span>), bins=<span class="number">20</span>, color=<span class="string">'k'</span>, alpha=<span class="number">0.3</span>)</div><div class="line">ax2.scatter(np.arange(<span class="number">30</span>), np.arange(<span class="number">30</span>) + <span class="number">3</span> * randn(<span class="number">30</span>))</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.close(<span class="string">'all'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fig, axes = plt.subplots(<span class="number">2</span>, <span class="number">3</span>)</div><div class="line">axes</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_13_1.png" alt="png"></p><h4 id="调整subplot周围的间距"><a href="#调整subplot周围的间距" class="headerlink" title="调整subplot周围的间距"></a>调整subplot周围的间距</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">plt.subplots_adjust(left=<span class="keyword">None</span>, bottom=<span class="keyword">None</span>, right=<span class="keyword">None</span>, top=<span class="keyword">None</span>,</div><div class="line">                wspace=<span class="keyword">None</span>, hspace=<span class="keyword">None</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">fig, axes = plt.subplots(<span class="number">2</span>, <span class="number">2</span>, sharex=<span class="keyword">True</span>, sharey=<span class="keyword">True</span>)</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">2</span>):</div><div class="line">        axes[i, j].hist(randn(<span class="number">500</span>), bins=<span class="number">50</span>, color=<span class="string">'k'</span>, alpha=<span class="number">0.5</span>)</div><div class="line">plt.subplots_adjust(wspace=<span class="number">0</span>, hspace=<span class="number">0</span>)</div></pre></td></tr></table></figure><pre><code>(array([  2.,   0.,   3.,   2.,   1.,   1.,   0.,   3.,   5.,   8.,   9.,
          9.,  10.,  18.,  34.,  13.,  24.,  30.,  24.,  24.,  25.,  20.,
         34.,  20.,  30.,  30.,  19.,  14.,  14.,   8.,  19.,  14.,   7.,
          3.,   7.,   2.,   7.,   2.,   2.,   0.,   1.,   0.,   0.,   0.,
          1.,   0.,   0.,   0.,   0.,   1.]),
 array([-2.9493, -2.8118, -2.6743, -2.5367, -2.3992, -2.2617, -2.1241,
        -1.9866, -1.849 , -1.7115, -1.574 , -1.4364, -1.2989, -1.1614,
        -1.0238, -0.8863, -0.7487, -0.6112, -0.4737, -0.3361, -0.1986,
        -0.0611,  0.0765,  0.214 ,  0.3516,  0.4891,  0.6266,  0.7642,
         0.9017,  1.0392,  1.1768,  1.3143,  1.4519,  1.5894,  1.7269,
         1.8645,  2.002 ,  2.1395,  2.2771,  2.4146,  2.5522,  2.6897,
         2.8272,  2.9648,  3.1023,  3.2398,  3.3774,  3.5149,  3.6525,
         3.79  ,  3.9275]),
 &lt;a list of 50 Patch objects&gt;)






(array([  1.,   1.,   0.,   2.,   0.,   1.,   1.,   5.,   7.,   4.,   5.,
          8.,  12.,  12.,  13.,  15.,  17.,  13.,  22.,  30.,  21.,  24.,
         17.,  20.,  20.,  20.,  18.,  26.,  16.,  24.,  19.,   8.,  14.,
         15.,   7.,  11.,   5.,   4.,   9.,   7.,   6.,   1.,   6.,   2.,
          4.,   2.,   0.,   2.,   1.,   2.]),
 array([-2.595 , -2.4898, -2.3845, -2.2793, -2.1741, -2.0688, -1.9636,
        -1.8584, -1.7531, -1.6479, -1.5427, -1.4374, -1.3322, -1.227 ,
        -1.1217, -1.0165, -0.9112, -0.806 , -0.7008, -0.5955, -0.4903,
        -0.3851, -0.2798, -0.1746, -0.0694,  0.0359,  0.1411,  0.2463,
         0.3516,  0.4568,  0.562 ,  0.6673,  0.7725,  0.8777,  0.983 ,
         1.0882,  1.1935,  1.2987,  1.4039,  1.5092,  1.6144,  1.7196,
         1.8249,  1.9301,  2.0353,  2.1406,  2.2458,  2.351 ,  2.4563,
         2.5615,  2.6667]),
 &lt;a list of 50 Patch objects&gt;)






(array([  1.,   0.,   1.,   0.,   0.,   1.,   0.,   1.,   1.,   0.,   4.,
          1.,   4.,   5.,  11.,   8.,   6.,  11.,  13.,  13.,  17.,  18.,
         20.,  27.,  32.,  29.,  31.,  22.,  21.,  31.,  29.,  19.,  22.,
         18.,  10.,  18.,  11.,  12.,   9.,   6.,   2.,   3.,   3.,   3.,
          2.,   1.,   1.,   1.,   0.,   1.]),
 array([-3.7454, -3.6052, -3.4651, -3.325 , -3.1849, -3.0448, -2.9047,
        -2.7646, -2.6244, -2.4843, -2.3442, -2.2041, -2.064 , -1.9239,
        -1.7837, -1.6436, -1.5035, -1.3634, -1.2233, -1.0832, -0.9431,
        -0.8029, -0.6628, -0.5227, -0.3826, -0.2425, -0.1024,  0.0377,
         0.1779,  0.318 ,  0.4581,  0.5982,  0.7383,  0.8784,  1.0185,
         1.1587,  1.2988,  1.4389,  1.579 ,  1.7191,  1.8592,  1.9994,
         2.1395,  2.2796,  2.4197,  2.5598,  2.6999,  2.84  ,  2.9802,
         3.1203,  3.2604]),
 &lt;a list of 50 Patch objects&gt;)






(array([  1.,   0.,   0.,   1.,   1.,   0.,   0.,   0.,   0.,   1.,   2.,
          5.,   9.,   8.,   6.,   2.,  11.,  17.,  10.,  13.,  10.,  14.,
         12.,  27.,  17.,  28.,  27.,  25.,  14.,  24.,  25.,  38.,  13.,
         24.,  15.,  10.,  17.,  14.,  13.,   8.,   7.,  10.,   3.,   7.,
          2.,   5.,   2.,   0.,   1.,   1.]),
 array([-3.4283, -3.3066, -3.185 , -3.0633, -2.9417, -2.8201, -2.6984,
        -2.5768, -2.4551, -2.3335, -2.2119, -2.0902, -1.9686, -1.847 ,
        -1.7253, -1.6037, -1.482 , -1.3604, -1.2388, -1.1171, -0.9955,
        -0.8739, -0.7522, -0.6306, -0.5089, -0.3873, -0.2657, -0.144 ,
        -0.0224,  0.0993,  0.2209,  0.3425,  0.4642,  0.5858,  0.7074,
         0.8291,  0.9507,  1.0724,  1.194 ,  1.3156,  1.4373,  1.5589,
         1.6806,  1.8022,  1.9238,  2.0455,  2.1671,  2.2887,  2.4104,
         2.532 ,  2.6537]),
 &lt;a list of 50 Patch objects&gt;)
</code></pre><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_16_4.png" alt="png"></p><h3 id="颜色、标记和线型"><a href="#颜色、标记和线型" class="headerlink" title="颜色、标记和线型"></a>颜色、标记和线型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.figure()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.plot(randn(<span class="number">30</span>).cumsum(), <span class="string">'ko--'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_19_1.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.close(<span class="string">'all'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">data = randn(<span class="number">30</span>).cumsum()</div><div class="line">plt.plot(data, <span class="string">'k--'</span>, label=<span class="string">'Default'</span>)</div><div class="line">plt.plot(data, <span class="string">'k-'</span>, drawstyle=<span class="string">'steps-post'</span>, label=<span class="string">'steps-post'</span>)</div><div class="line">plt.legend(loc=<span class="string">'best'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_21_3.png" alt="png"></p><h3 id="刻度、标签和图例"><a href="#刻度、标签和图例" class="headerlink" title="刻度、标签和图例"></a>刻度、标签和图例</h3><h4 id="设置标题、轴标签、刻度以及刻度标签"><a href="#设置标题、轴标签、刻度以及刻度标签" class="headerlink" title="设置标题、轴标签、刻度以及刻度标签"></a>设置标题、轴标签、刻度以及刻度标签</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fig = plt.figure(); ax = fig.add_subplot(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</div><div class="line">ax.plot(randn(<span class="number">1000</span>).cumsum())</div><div class="line"></div><div class="line">ticks = ax.set_xticks([<span class="number">0</span>, <span class="number">250</span>, <span class="number">500</span>, <span class="number">750</span>, <span class="number">1000</span>])</div><div class="line">labels = ax.set_xticklabels([<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>, <span class="string">'four'</span>, <span class="string">'five'</span>],</div><div class="line">                            rotation=<span class="number">30</span>, fontsize=<span class="string">'small'</span>)</div><div class="line">ax.set_title(<span class="string">'My first matplotlib plot'</span>)</div><div class="line">ax.set_xlabel(<span class="string">'Stages'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_24_3.png" alt="png"></p><h4 id="添加图例"><a href="#添加图例" class="headerlink" title="添加图例"></a>添加图例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fig = plt.figure(); ax = fig.add_subplot(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</div><div class="line">ax.plot(randn(<span class="number">1000</span>).cumsum(), <span class="string">'k'</span>, label=<span class="string">'one'</span>)</div><div class="line">ax.plot(randn(<span class="number">1000</span>).cumsum(), <span class="string">'k--'</span>, label=<span class="string">'two'</span>)</div><div class="line">ax.plot(randn(<span class="number">1000</span>).cumsum(), <span class="string">'k.'</span>, label=<span class="string">'three'</span>)</div><div class="line"></div><div class="line">ax.legend(loc=<span class="string">'best'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_26_4.png" alt="png"></p><h3 id="注解以及在subplot上绘图"><a href="#注解以及在subplot上绘图" class="headerlink" title="注解以及在subplot上绘图"></a>注解以及在subplot上绘图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line">fig = plt.figure()</div><div class="line">ax = fig.add_subplot(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</div><div class="line"></div><div class="line">data = pd.read_csv(<span class="string">'ch08/spx.csv'</span>, index_col=<span class="number">0</span>, parse_dates=<span class="keyword">True</span>)</div><div class="line">spx = data[<span class="string">'SPX'</span>]</div><div class="line"></div><div class="line">spx.plot(ax=ax, style=<span class="string">'k-'</span>)</div><div class="line"></div><div class="line">crisis_data = [</div><div class="line">    (datetime(<span class="number">2007</span>, <span class="number">10</span>, <span class="number">11</span>), <span class="string">'Peak of bull market'</span>),</div><div class="line">    (datetime(<span class="number">2008</span>, <span class="number">3</span>, <span class="number">12</span>), <span class="string">'Bear Stearns Fails'</span>),</div><div class="line">    (datetime(<span class="number">2008</span>, <span class="number">9</span>, <span class="number">15</span>), <span class="string">'Lehman Bankruptcy'</span>)</div><div class="line">]</div><div class="line"></div><div class="line"><span class="keyword">for</span> date, label <span class="keyword">in</span> crisis_data:</div><div class="line">    ax.annotate(label, xy=(date, spx.asof(date) + <span class="number">50</span>),</div><div class="line">                xytext=(date, spx.asof(date) + <span class="number">200</span>),</div><div class="line">                arrowprops=dict(facecolor=<span class="string">'black'</span>),</div><div class="line">                horizontalalignment=<span class="string">'left'</span>, verticalalignment=<span class="string">'top'</span>)</div><div class="line"></div><div class="line"><span class="comment"># Zoom in on 2007-2010</span></div><div class="line">ax.set_xlim([<span class="string">'1/1/2007'</span>, <span class="string">'1/1/2011'</span>])</div><div class="line">ax.set_ylim([<span class="number">600</span>, <span class="number">1800</span>])</div><div class="line"></div><div class="line">ax.set_title(<span class="string">'Important dates in 2008-2009 financial crisis'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_28_7.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">fig = plt.figure()</div><div class="line">ax = fig.add_subplot(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</div><div class="line"></div><div class="line">rect = plt.Rectangle((<span class="number">0.2</span>, <span class="number">0.75</span>), <span class="number">0.4</span>, <span class="number">0.15</span>, color=<span class="string">'k'</span>, alpha=<span class="number">0.3</span>)</div><div class="line">circ = plt.Circle((<span class="number">0.7</span>, <span class="number">0.2</span>), <span class="number">0.15</span>, color=<span class="string">'b'</span>, alpha=<span class="number">0.3</span>)</div><div class="line">pgon = plt.Polygon([[<span class="number">0.15</span>, <span class="number">0.15</span>], [<span class="number">0.35</span>, <span class="number">0.4</span>], [<span class="number">0.2</span>, <span class="number">0.6</span>]],</div><div class="line">                   color=<span class="string">'g'</span>, alpha=<span class="number">0.5</span>)</div><div class="line"></div><div class="line">ax.add_patch(rect)</div><div class="line">ax.add_patch(circ)</div><div class="line">ax.add_patch(pgon)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_29_3.png" alt="png"></p><h3 id="将图表保存到文件"><a href="#将图表保存到文件" class="headerlink" title="将图表保存到文件"></a>将图表保存到文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fig</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_31_0.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fig.savefig(<span class="string">'figpath.svg'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fig.savefig(<span class="string">'figpath.png'</span>, dpi=<span class="number">400</span>, bbox_inches=<span class="string">'tight'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</div><div class="line">buffer = BytesIO()</div><div class="line">plt.savefig(buffer)</div><div class="line">plot_data = buffer.getvalue()</div></pre></td></tr></table></figure><pre><code>&lt;matplotlib.figure.Figure at 0xaebe550&gt;
</code></pre><h3 id="matplotlib-配置"><a href="#matplotlib-配置" class="headerlink" title="matplotlib 配置"></a>matplotlib 配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.rc(<span class="string">'figure'</span>, figsize=(<span class="number">10</span>, <span class="number">10</span>))</div></pre></td></tr></table></figure><h2 id="pandas中的绘图函数"><a href="#pandas中的绘图函数" class="headerlink" title="pandas中的绘图函数"></a>pandas中的绘图函数</h2><h3 id="线型图"><a href="#线型图" class="headerlink" title="线型图"></a>线型图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.close(<span class="string">'all'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s = Series(np.random.randn(<span class="number">10</span>).cumsum(), index=np.arange(<span class="number">0</span>, <span class="number">100</span>, <span class="number">10</span>))</div><div class="line">s.plot()</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_40_1.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">df = DataFrame(np.random.randn(<span class="number">10</span>, <span class="number">4</span>).cumsum(<span class="number">0</span>),</div><div class="line">               columns=[<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>],</div><div class="line">               index=np.arange(<span class="number">0</span>, <span class="number">100</span>, <span class="number">10</span>))</div><div class="line">df.plot()</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_41_1.png" alt="png"></p><h3 id="柱状图"><a href="#柱状图" class="headerlink" title="柱状图"></a>柱状图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fig, axes = plt.subplots(<span class="number">2</span>, <span class="number">1</span>)</div><div class="line">data = Series(np.random.rand(<span class="number">16</span>), index=list(<span class="string">'abcdefghijklmnop'</span>))</div><div class="line">data.plot(kind=<span class="string">'bar'</span>, ax=axes[<span class="number">0</span>], color=<span class="string">'k'</span>, alpha=<span class="number">0.7</span>)</div><div class="line">data.plot(kind=<span class="string">'barh'</span>, ax=axes[<span class="number">1</span>], color=<span class="string">'k'</span>, alpha=<span class="number">0.7</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_43_2.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">df = DataFrame(np.random.rand(<span class="number">6</span>, <span class="number">4</span>),</div><div class="line">               index=[<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>, <span class="string">'four'</span>, <span class="string">'five'</span>, <span class="string">'six'</span>],</div><div class="line">               columns=pd.Index([<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>], name=<span class="string">'Genus'</span>))</div><div class="line">df</div><div class="line">df.plot(kind=<span class="string">'bar'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>Genus</th><br><th>A</th><br><th>B</th><br><th>C</th><br><th>D</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>one</th><br><td>0.301686</td><br><td>0.156333</td><br><td>0.371943</td><br><td>0.270731</td><br></tr><br><tr><br><th>two</th><br><td>0.750589</td><br><td>0.525587</td><br><td>0.689429</td><br><td>0.358974</td><br></tr><br><tr><br><th>three</th><br><td>0.381504</td><br><td>0.667707</td><br><td>0.473772</td><br><td>0.632528</td><br></tr><br><tr><br><th>four</th><br><td>0.942408</td><br><td>0.180186</td><br><td>0.708284</td><br><td>0.641783</td><br></tr><br><tr><br><th>five</th><br><td>0.840278</td><br><td>0.909589</td><br><td>0.010041</td><br><td>0.653207</td><br></tr><br><tr><br><th>six</th><br><td>0.062854</td><br><td>0.589813</td><br><td>0.811318</td><br><td>0.060217</td><br></tr><br><br></tbody><br></table><br></div><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_44_2.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.figure()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.plot(kind=<span class="string">'barh'</span>, stacked=<span class="keyword">True</span>, alpha=<span class="number">0.5</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_46_1.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tips = pd.read_csv(<span class="string">'ch08/tips.csv'</span>)</div><div class="line">party_counts = pd.crosstab(tips.day, tips.size_)</div><div class="line">party_counts</div><div class="line"><span class="comment"># Not many 1- and 6-person parties</span></div><div class="line">party_counts = party_counts.ix[:, <span class="number">2</span>:<span class="number">5</span>]</div><div class="line">party_counts</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>size_</th><br><th>1</th><br><th>2</th><br><th>3</th><br><th>4</th><br><th>5</th><br><th>6</th><br></tr><br><tr><br><th>day</th><br><th></th><br><th></th><br><th></th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>Fri</th><br><td>1</td><br><td>16</td><br><td>1</td><br><td>1</td><br><td>0</td><br><td>0</td><br></tr><br><tr><br><th>Sat</th><br><td>2</td><br><td>53</td><br><td>18</td><br><td>13</td><br><td>1</td><br><td>0</td><br></tr><br><tr><br><th>Sun</th><br><td>0</td><br><td>39</td><br><td>15</td><br><td>18</td><br><td>3</td><br><td>1</td><br></tr><br><tr><br><th>Thur</th><br><td>1</td><br><td>48</td><br><td>4</td><br><td>5</td><br><td>1</td><br><td>3</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>size_</th><br><th>2</th><br><th>3</th><br><th>4</th><br><th>5</th><br></tr><br><tr><br><th>day</th><br><th></th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>Fri</th><br><td>16</td><br><td>1</td><br><td>1</td><br><td>0</td><br></tr><br><tr><br><th>Sat</th><br><td>53</td><br><td>18</td><br><td>13</td><br><td>1</td><br></tr><br><tr><br><th>Sun</th><br><td>39</td><br><td>15</td><br><td>18</td><br><td>3</td><br></tr><br><tr><br><th>Thur</th><br><td>48</td><br><td>4</td><br><td>5</td><br><td>1</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Normalize to sum to 1</span></div><div class="line">party_pcts = party_counts.div(party_counts.sum(<span class="number">1</span>).astype(float), axis=<span class="number">0</span>)</div><div class="line">party_pcts</div><div class="line"></div><div class="line">party_pcts.plot(kind=<span class="string">'bar'</span>, stacked=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>size_</th><br><th>2</th><br><th>3</th><br><th>4</th><br><th>5</th><br></tr><br><tr><br><th>day</th><br><th></th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>Fri</th><br><td>0.888889</td><br><td>0.055556</td><br><td>0.055556</td><br><td>0.000000</td><br></tr><br><tr><br><th>Sat</th><br><td>0.623529</td><br><td>0.211765</td><br><td>0.152941</td><br><td>0.011765</td><br></tr><br><tr><br><th>Sun</th><br><td>0.520000</td><br><td>0.200000</td><br><td>0.240000</td><br><td>0.040000</td><br></tr><br><tr><br><th>Thur</th><br><td>0.827586</td><br><td>0.068966</td><br><td>0.086207</td><br><td>0.017241</td><br></tr><br><br></tbody><br></table><br></div><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_48_2.png" alt="png"></p><h3 id="直方图和密度图"><a href="#直方图和密度图" class="headerlink" title="直方图和密度图"></a>直方图和密度图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.figure()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tips[<span class="string">'tip_pct'</span>] = tips[<span class="string">'tip'</span>] / tips[<span class="string">'total_bill'</span>]</div><div class="line">tips[<span class="string">'tip_pct'</span>].hist(bins=<span class="number">50</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_51_1.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.figure()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tips[<span class="string">'tip_pct'</span>].plot(kind=<span class="string">'kde'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_53_1.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.figure()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">comp1 = np.random.normal(<span class="number">0</span>, <span class="number">1</span>, size=<span class="number">200</span>)  <span class="comment"># N(0, 1)</span></div><div class="line">comp2 = np.random.normal(<span class="number">10</span>, <span class="number">2</span>, size=<span class="number">200</span>)  <span class="comment"># N(10, 4)</span></div><div class="line">values = Series(np.concatenate([comp1, comp2]))</div><div class="line">values.hist(bins=<span class="number">100</span>, alpha=<span class="number">0.3</span>, color=<span class="string">'k'</span>, normed=<span class="keyword">True</span>)</div><div class="line">values.plot(kind=<span class="string">'kde'</span>, style=<span class="string">'k--'</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_55_2.png" alt="png"></p><h3 id="散点图"><a href="#散点图" class="headerlink" title="散点图"></a>散点图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">macro = pd.read_csv(<span class="string">'ch08/macrodata.csv'</span>)</div><div class="line">data = macro[[<span class="string">'cpi'</span>, <span class="string">'m1'</span>, <span class="string">'tbilrate'</span>, <span class="string">'unemp'</span>]]</div><div class="line">trans_data = np.log(data).diff().dropna()</div><div class="line">trans_data[<span class="number">-5</span>:]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>cpi</th><br><th>m1</th><br><th>tbilrate</th><br><th>unemp</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>198</th><br><td>-0.007904</td><br><td>0.045361</td><br><td>-0.396881</td><br><td>0.105361</td><br></tr><br><tr><br><th>199</th><br><td>-0.021979</td><br><td>0.066753</td><br><td>-2.277267</td><br><td>0.139762</td><br></tr><br><tr><br><th>200</th><br><td>0.002340</td><br><td>0.010286</td><br><td>0.606136</td><br><td>0.160343</td><br></tr><br><tr><br><th>201</th><br><td>0.008419</td><br><td>0.037461</td><br><td>-0.200671</td><br><td>0.127339</td><br></tr><br><tr><br><th>202</th><br><td>0.008894</td><br><td>0.012202</td><br><td>-0.405465</td><br><td>0.042560</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">plt.figure()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">plt.scatter(trans_data[<span class="string">'m1'</span>], trans_data[<span class="string">'unemp'</span>])</div><div class="line">plt.title(<span class="string">'Changes in log %s vs. log %s'</span> % (<span class="string">'m1'</span>, <span class="string">'unemp'</span>))</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_59_2.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.scatter_matrix(trans_data, diagonal=<span class="string">'kde'</span>, c=<span class="string">'k'</span>, alpha=<span class="number">0.3</span>)</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_60_1.png" alt="png"></p><h2 id="绘制地图：图形化显示海底地震危机数据"><a href="#绘制地图：图形化显示海底地震危机数据" class="headerlink" title="绘制地图：图形化显示海底地震危机数据"></a>绘制地图：图形化显示海底地震危机数据</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data = pd.read_csv(<span class="string">'ch08/Haiti.csv'</span>)</div><div class="line">data.info()</div></pre></td></tr></table></figure><pre><code>&lt;class &apos;pandas.core.frame.DataFrame&apos;&gt;
RangeIndex: 3593 entries, 0 to 3592
Data columns (total 10 columns):
Serial            3593 non-null int64
INCIDENT TITLE    3593 non-null object
INCIDENT DATE     3593 non-null object
LOCATION          3592 non-null object
DESCRIPTION       3593 non-null object
CATEGORY          3587 non-null object
LATITUDE          3593 non-null float64
LONGITUDE         3593 non-null float64
APPROVED          3593 non-null object
VERIFIED          3593 non-null object
dtypes: float64(2), int64(1), object(7)
memory usage: 280.8+ KB
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data[[<span class="string">'INCIDENT DATE'</span>, <span class="string">'LATITUDE'</span>, <span class="string">'LONGITUDE'</span>]][:<span class="number">10</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>INCIDENT DATE</th><br><th>LATITUDE</th><br><th>LONGITUDE</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>05/07/2010 17:26</td><br><td>18.233333</td><br><td>-72.533333</td><br></tr><br><tr><br><th>1</th><br><td>28/06/2010 23:06</td><br><td>50.226029</td><br><td>5.729886</td><br></tr><br><tr><br><th>2</th><br><td>24/06/2010 16:21</td><br><td>22.278381</td><br><td>114.174287</td><br></tr><br><tr><br><th>3</th><br><td>20/06/2010 21:59</td><br><td>44.407062</td><br><td>8.933989</td><br></tr><br><tr><br><th>4</th><br><td>18/05/2010 16:26</td><br><td>18.571084</td><br><td>-72.334671</td><br></tr><br><tr><br><th>5</th><br><td>26/04/2010 13:14</td><br><td>18.593707</td><br><td>-72.310079</td><br></tr><br><tr><br><th>6</th><br><td>26/04/2010 14:19</td><br><td>18.482800</td><br><td>-73.638800</td><br></tr><br><tr><br><th>7</th><br><td>26/04/2010 14:27</td><br><td>18.415000</td><br><td>-73.195000</td><br></tr><br><tr><br><th>8</th><br><td>15/03/2010 10:58</td><br><td>18.517443</td><br><td>-72.236841</td><br></tr><br><tr><br><th>9</th><br><td>15/03/2010 11:00</td><br><td>18.547790</td><br><td>-72.410010</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data[<span class="string">'CATEGORY'</span>][:<span class="number">6</span>]</div></pre></td></tr></table></figure><pre><code>0          1. Urgences | Emergency, 3. Public Health, 
1    1. Urgences | Emergency, 2. Urgences logistiqu...
2    2. Urgences logistiques | Vital Lines, 8. Autr...
3                            1. Urgences | Emergency, 
4                            1. Urgences | Emergency, 
5                       5e. Communication lines down, 
Name: CATEGORY, dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.describe()</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Serial</th><br><th>LATITUDE</th><br><th>LONGITUDE</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>count</th><br><td>3593.000000</td><br><td>3593.000000</td><br><td>3593.000000</td><br></tr><br><tr><br><th>mean</th><br><td>2080.277484</td><br><td>18.611495</td><br><td>-72.322680</td><br></tr><br><tr><br><th>std</th><br><td>1171.100360</td><br><td>0.738572</td><br><td>3.650776</td><br></tr><br><tr><br><th>min</th><br><td>4.000000</td><br><td>18.041313</td><br><td>-74.452757</td><br></tr><br><tr><br><th>25%</th><br><td>1074.000000</td><br><td>18.524070</td><br><td>-72.417500</td><br></tr><br><tr><br><th>50%</th><br><td>2163.000000</td><br><td>18.539269</td><br><td>-72.335000</td><br></tr><br><tr><br><th>75%</th><br><td>3088.000000</td><br><td>18.561820</td><br><td>-72.293570</td><br></tr><br><tr><br><th>max</th><br><td>4052.000000</td><br><td>50.226029</td><br><td>114.174287</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">data = data[(data.LATITUDE &gt; <span class="number">18</span>) &amp; (data.LATITUDE &lt; <span class="number">20</span>) &amp;</div><div class="line">            (data.LONGITUDE &gt; <span class="number">-75</span>) &amp; (data.LONGITUDE &lt; <span class="number">-70</span>)</div><div class="line">            &amp; data.CATEGORY.notnull()]</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_cat_list</span><span class="params">(catstr)</span>:</span></div><div class="line">    stripped = (x.strip() <span class="keyword">for</span> x <span class="keyword">in</span> catstr.split(<span class="string">','</span>))</div><div class="line">    <span class="keyword">return</span> [x <span class="keyword">for</span> x <span class="keyword">in</span> stripped <span class="keyword">if</span> x]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_categories</span><span class="params">(cat_series)</span>:</span></div><div class="line">    cat_sets = (set(to_cat_list(x)) <span class="keyword">for</span> x <span class="keyword">in</span> cat_series)</div><div class="line">    <span class="keyword">return</span> sorted(set.union(*cat_sets))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_english</span><span class="params">(cat)</span>:</span></div><div class="line">    code, names = cat.split(<span class="string">'.'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="string">'|'</span> <span class="keyword">in</span> names:</div><div class="line">        names = names.split(<span class="string">' | '</span>)[<span class="number">1</span>]</div><div class="line">    <span class="keyword">return</span> code, names.strip()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">get_english(<span class="string">'2. Urgences logistiques | Vital Lines'</span>)</div></pre></td></tr></table></figure><pre><code>(&apos;2&apos;, &apos;Vital Lines&apos;)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">all_cats = get_all_categories(data.CATEGORY)</div><div class="line"><span class="comment"># Generator expression</span></div><div class="line">english_mapping = dict(get_english(x) <span class="keyword">for</span> x <span class="keyword">in</span> all_cats)</div><div class="line">english_mapping[<span class="string">'2a'</span>]</div><div class="line">english_mapping[<span class="string">'6c'</span>]</div></pre></td></tr></table></figure><pre><code>&apos;Food Shortage&apos;






&apos;Earthquake and aftershocks&apos;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code</span><span class="params">(seq)</span>:</span></div><div class="line">    <span class="keyword">return</span> [x.split(<span class="string">'.'</span>)[<span class="number">0</span>] <span class="keyword">for</span> x <span class="keyword">in</span> seq <span class="keyword">if</span> x]</div><div class="line"></div><div class="line">all_codes = get_code(all_cats)</div><div class="line">code_index = pd.Index(np.unique(all_codes))</div><div class="line">dummy_frame = DataFrame(np.zeros((len(data), len(code_index))),</div><div class="line">                        index=data.index, columns=code_index)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dummy_frame.ix[:, :<span class="number">6</span>].info()</div></pre></td></tr></table></figure><pre><code>&lt;class &apos;pandas.core.frame.DataFrame&apos;&gt;
Int64Index: 3569 entries, 0 to 3592
Data columns (total 6 columns):
1     3569 non-null float64
1a    3569 non-null float64
1b    3569 non-null float64
1c    3569 non-null float64
1d    3569 non-null float64
2     3569 non-null float64
dtypes: float64(6)
memory usage: 195.2 KB
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> row, cat <span class="keyword">in</span> zip(data.index, data.CATEGORY):</div><div class="line">    codes = get_code(to_cat_list(cat))</div><div class="line">    dummy_frame.ix[row, codes] = <span class="number">1</span></div><div class="line"></div><div class="line">data = data.join(dummy_frame.add_prefix(<span class="string">'category_'</span>))</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.ix[:, <span class="number">10</span>:<span class="number">15</span>].info()</div></pre></td></tr></table></figure><pre><code>&lt;class &apos;pandas.core.frame.DataFrame&apos;&gt;
Int64Index: 3569 entries, 0 to 3592
Data columns (total 5 columns):
category_1     3569 non-null float64
category_1a    3569 non-null float64
category_1b    3569 non-null float64
category_1c    3569 non-null float64
category_1d    3569 non-null float64
dtypes: float64(5)
memory usage: 167.3 KB
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> mpl_toolkits.basemap <span class="keyword">import</span> Basemap</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic_haiti_map</span><span class="params">(ax=None, lllat=<span class="number">17.25</span>, urlat=<span class="number">20.25</span>,</span></span></div><div class="line">                    lllon=<span class="number">-75</span>, urlon=<span class="number">-71</span>):</div><div class="line">    <span class="comment"># create polar stereographic Basemap instance.</span></div><div class="line">    m = Basemap(ax=ax, projection=<span class="string">'stere'</span>,</div><div class="line">                lon_0=(urlon + lllon) / <span class="number">2</span>,</div><div class="line">                lat_0=(urlat + lllat) / <span class="number">2</span>,</div><div class="line">                llcrnrlat=lllat, urcrnrlat=urlat,</div><div class="line">                llcrnrlon=lllon, urcrnrlon=urlon,</div><div class="line">                resolution=<span class="string">'f'</span>)</div><div class="line">    <span class="comment"># draw coastlines, state and country boundaries, edge of map.</span></div><div class="line">    m.drawcoastlines()</div><div class="line">    m.drawstates()</div><div class="line">    m.drawcountries()</div><div class="line">    <span class="keyword">return</span> m</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">fig, axes = plt.subplots(nrows=<span class="number">2</span>, ncols=<span class="number">2</span>, figsize=(<span class="number">12</span>, <span class="number">10</span>))</div><div class="line">fig.subplots_adjust(hspace=<span class="number">0.05</span>, wspace=<span class="number">0.05</span>)</div><div class="line"></div><div class="line">to_plot = [<span class="string">'2a'</span>, <span class="string">'1'</span>, <span class="string">'3c'</span>, <span class="string">'7a'</span>]</div><div class="line"></div><div class="line">lllat=<span class="number">17.25</span>; urlat=<span class="number">20.25</span>; lllon=<span class="number">-75</span>; urlon=<span class="number">-71</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> code, ax <span class="keyword">in</span> zip(to_plot, axes.flat):</div><div class="line">    m = basic_haiti_map(ax, lllat=lllat, urlat=urlat,</div><div class="line">                        lllon=lllon, urlon=urlon)</div><div class="line"></div><div class="line">    cat_data = data[data[<span class="string">'category_%s'</span> % code] == <span class="number">1</span>]</div><div class="line"></div><div class="line">    <span class="comment"># compute map proj coordinates.</span></div><div class="line">    x, y = m(cat_data.LONGITUDE.values, cat_data.LATITUDE.values)</div><div class="line"></div><div class="line">    m.plot(x, y, <span class="string">'k.'</span>, alpha=<span class="number">0.5</span>)</div><div class="line">    ax.set_title(<span class="string">'%s: %s'</span> % (code, english_mapping[code]))</div></pre></td></tr></table></figure><pre><code>C:\Users\Ewan\Anaconda3\envs\ipykernel_py2\lib\site-packages\mpl_toolkits\basemap\__init__.py:3260: MatplotlibDeprecationWarning: The ishold function was deprecated in version 2.0.
  b = ax.ishold()
C:\Users\Ewan\Anaconda3\envs\ipykernel_py2\lib\site-packages\mpl_toolkits\basemap\__init__.py:3269: MatplotlibDeprecationWarning: axes.hold is deprecated.
    See the API Changes document (http://matplotlib.org/api/api_changes.html)
    for more details.
  ax.hold(b)
</code></pre><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_75_9.png" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#街道数据的路径</span></div><div class="line">shapefilepath = <span class="string">'ch08/PortAuPrince_Roads/PortAuPrince_Roads'</span></div><div class="line"></div><div class="line">fig = plt.figure()</div><div class="line">ax = fig.add_subplot(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line"></div><div class="line">lat0 = <span class="number">18.533333</span>;lon0 = <span class="number">-72.333333</span>;change = <span class="number">0.13</span>;</div><div class="line">lllat=lat0-change; urlat=lat0+change; lllon=lon0-change; urlon=lon0+change;</div><div class="line"></div><div class="line">m = basic_haiti_map(ax, lllat=lllat, urlat=urlat,lllon=lllon, urlon=urlon)</div><div class="line"></div><div class="line">m.readshapefile(shapefilepath,<span class="string">'roads'</span>) <span class="comment">#添加街道数据</span></div><div class="line"></div><div class="line">code = <span class="string">'2a'</span></div><div class="line">cat_data = data[data[<span class="string">'category_%s'</span> % code] == <span class="number">1</span>]</div><div class="line"></div><div class="line"><span class="comment"># compute map proj coordinates.</span></div><div class="line">x, y = m(cat_data.LONGITUDE.values, cat_data.LATITUDE.values)</div><div class="line"></div><div class="line">m.plot(x, y, <span class="string">'k.'</span>, alpha=<span class="number">0.5</span>)</div><div class="line">ax.set_title(<span class="string">'Food shortages reported in Port-au-Prince'</span>)</div><div class="line"><span class="comment"># plt.savefig('myfig.png',dpi=400,bbox_inches='tight')</span></div></pre></td></tr></table></figure><pre><code>(1583,
 3,
 [-72.749246, 18.409952, 0.0, 0.0],
 [-71.973789, 18.7147105, 0.0, 0.0],
</code></pre><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata/ch08/output_76_3.png" alt="png"></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/28/Python-data-analysis-Learning-note-Ch07/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Ewan Li"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Abracadabra"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Abracadabra" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2017/02/28/Python-data-analysis-Learning-note-Ch07/" itemprop="url">Python data analysis Learning note Ch07</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-28T22:36:30+08:00">2017-02-28 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2017/02/28/Python-data-analysis-Learning-note-Ch07/#comments" itemprop="discussionUrl"><span class="post-comments-count hc-comment-count" data-xid="2017/02/28/Python-data-analysis-Learning-note-Ch07/" itemprop="commentsCount"></span> </a></span><span id="/2017/02/28/Python-data-analysis-Learning-note-Ch07/" class="leancloud_visitors" data-flag-title="Python data analysis Learning note Ch07"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="数据规整化：清理、转换、合并、重塑"><a href="#数据规整化：清理、转换、合并、重塑" class="headerlink" title="数据规整化：清理、转换、合并、重塑"></a>数据规整化：清理、转换、合并、重塑</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><span class="keyword">from</span> numpy.random <span class="keyword">import</span> randn</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line">np.random.seed(<span class="number">12345</span>)</div><div class="line">plt.rc(<span class="string">'figure'</span>, figsize=(<span class="number">10</span>, <span class="number">6</span>))</div><div class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> Series, DataFrame</div><div class="line"><span class="keyword">import</span> pandas</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line">np.set_printoptions(precision=<span class="number">4</span>, threshold=<span class="number">500</span>)</div><div class="line">pd.options.display.max_rows = <span class="number">100</span></div><div class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</div><div class="line">InteractiveShell.ast_node_interactivity = <span class="string">"all"</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%matplotlib inline</div></pre></td></tr></table></figure><h2 id="合并数据集"><a href="#合并数据集" class="headerlink" title="合并数据集"></a>合并数据集</h2><h3 id="数据库风格的DataFrame合并"><a href="#数据库风格的DataFrame合并" class="headerlink" title="数据库风格的DataFrame合并"></a>数据库风格的DataFrame合并</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">df1 = DataFrame(&#123;<span class="string">'key'</span>: [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>],</div><div class="line">                 <span class="string">'data1'</span>: range(<span class="number">7</span>)&#125;)</div><div class="line">df2 = DataFrame(&#123;<span class="string">'key'</span>: [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'d'</span>],</div><div class="line">                 <span class="string">'data2'</span>: range(<span class="number">3</span>)&#125;)</div><div class="line">df1</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>a</td><br></tr><br><tr><br><th>3</th><br><td>3</td><br><td>c</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>a</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>a</td><br></tr><br><tr><br><th>6</th><br><td>6</td><br><td>b</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df2</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data2</th><br><th>key</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>a</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>d</td><br></tr><br><br></tbody><br></table><br></div><p>默认情况下根据重叠的列名进行合并</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(df1, df2)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br><th>data2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>2</th><br><td>6</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>3</th><br><td>2</td><br><td>a</td><br><td>0</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>a</td><br><td>0</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>a</td><br><td>0</td><br></tr><br><br></tbody><br></table><br></div><p>最好进行显式地指定</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(df1, df2, on=<span class="string">'key'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br><th>data2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>2</th><br><td>6</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>3</th><br><td>2</td><br><td>a</td><br><td>0</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>a</td><br><td>0</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>a</td><br><td>0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">df3 = DataFrame(&#123;<span class="string">'lkey'</span>: [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>],</div><div class="line">                 <span class="string">'data1'</span>: range(<span class="number">7</span>)&#125;)</div><div class="line">df4 = DataFrame(&#123;<span class="string">'rkey'</span>: [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'d'</span>],</div><div class="line">                 <span class="string">'data2'</span>: range(<span class="number">3</span>)&#125;)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df3</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>lkey</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>a</td><br></tr><br><tr><br><th>3</th><br><td>3</td><br><td>c</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>a</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>a</td><br></tr><br><tr><br><th>6</th><br><td>6</td><br><td>b</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df4</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data2</th><br><th>rkey</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>a</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>d</td><br></tr><br><br></tbody><br></table><br></div><p>如果两个对象的列名不同，那么就需要分别指定</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(df3, df4, left_on=<span class="string">'lkey'</span>, right_on=<span class="string">'rkey'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>lkey</th><br><th>data2</th><br><th>rkey</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>6</td><br><td>b</td><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>3</th><br><td>2</td><br><td>a</td><br><td>0</td><br><td>a</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>a</td><br><td>0</td><br><td>a</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>a</td><br><td>0</td><br><td>a</td><br></tr><br><br></tbody><br></table><br></div><p>默认是进行inner连接（交集）， outer是求取并集</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(df1, df2, how=<span class="string">'outer'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br><th>data2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>b</td><br><td>1.0</td><br></tr><br><tr><br><th>1</th><br><td>1.0</td><br><td>b</td><br><td>1.0</td><br></tr><br><tr><br><th>2</th><br><td>6.0</td><br><td>b</td><br><td>1.0</td><br></tr><br><tr><br><th>3</th><br><td>2.0</td><br><td>a</td><br><td>0.0</td><br></tr><br><tr><br><th>4</th><br><td>4.0</td><br><td>a</td><br><td>0.0</td><br></tr><br><tr><br><th>5</th><br><td>5.0</td><br><td>a</td><br><td>0.0</td><br></tr><br><tr><br><th>6</th><br><td>3.0</td><br><td>c</td><br><td>NaN</td><br></tr><br><tr><br><th>7</th><br><td>NaN</td><br><td>d</td><br><td>2.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">df1 = DataFrame(&#123;<span class="string">'key'</span>: [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>],</div><div class="line">                 <span class="string">'data1'</span>: range(<span class="number">6</span>)&#125;)</div><div class="line">df2 = DataFrame(&#123;<span class="string">'key'</span>: [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'d'</span>],</div><div class="line">                 <span class="string">'data2'</span>: range(<span class="number">5</span>)&#125;)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df1</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>a</td><br></tr><br><tr><br><th>3</th><br><td>3</td><br><td>c</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>a</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>b</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df2</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data2</th><br><th>key</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>a</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>a</td><br></tr><br><tr><br><th>3</th><br><td>3</td><br><td>b</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>d</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(df1, df2, on=<span class="string">'key'</span>, how=<span class="string">'left'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br><th>data2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br><td>1.0</td><br></tr><br><tr><br><th>1</th><br><td>0</td><br><td>b</td><br><td>3.0</td><br></tr><br><tr><br><th>2</th><br><td>1</td><br><td>b</td><br><td>1.0</td><br></tr><br><tr><br><th>3</th><br><td>1</td><br><td>b</td><br><td>3.0</td><br></tr><br><tr><br><th>4</th><br><td>2</td><br><td>a</td><br><td>0.0</td><br></tr><br><tr><br><th>5</th><br><td>2</td><br><td>a</td><br><td>2.0</td><br></tr><br><tr><br><th>6</th><br><td>3</td><br><td>c</td><br><td>NaN</td><br></tr><br><tr><br><th>7</th><br><td>4</td><br><td>a</td><br><td>0.0</td><br></tr><br><tr><br><th>8</th><br><td>4</td><br><td>a</td><br><td>2.0</td><br></tr><br><tr><br><th>9</th><br><td>5</td><br><td>b</td><br><td>1.0</td><br></tr><br><tr><br><th>10</th><br><td>5</td><br><td>b</td><br><td>3.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(df1, df2, how=<span class="string">'inner'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br><th>data2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>1</th><br><td>0</td><br><td>b</td><br><td>3</td><br></tr><br><tr><br><th>2</th><br><td>1</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>3</th><br><td>1</td><br><td>b</td><br><td>3</td><br></tr><br><tr><br><th>4</th><br><td>5</td><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>b</td><br><td>3</td><br></tr><br><tr><br><th>6</th><br><td>2</td><br><td>a</td><br><td>0</td><br></tr><br><tr><br><th>7</th><br><td>2</td><br><td>a</td><br><td>2</td><br></tr><br><tr><br><th>8</th><br><td>4</td><br><td>a</td><br><td>0</td><br></tr><br><tr><br><th>9</th><br><td>4</td><br><td>a</td><br><td>2</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">left = DataFrame(&#123;<span class="string">'key1'</span>: [<span class="string">'foo'</span>, <span class="string">'foo'</span>, <span class="string">'bar'</span>],</div><div class="line">                  <span class="string">'key2'</span>: [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'one'</span>],</div><div class="line">                  <span class="string">'lval'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;)</div><div class="line">right = DataFrame(&#123;<span class="string">'key1'</span>: [<span class="string">'foo'</span>, <span class="string">'foo'</span>, <span class="string">'bar'</span>, <span class="string">'bar'</span>],</div><div class="line">                   <span class="string">'key2'</span>: [<span class="string">'one'</span>, <span class="string">'one'</span>, <span class="string">'one'</span>, <span class="string">'two'</span>],</div><div class="line">                   <span class="string">'rval'</span>: [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]&#125;)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">left</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key1</th><br><th>key2</th><br><th>lval</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>foo</td><br><td>one</td><br><td>1</td><br></tr><br><tr><br><th>1</th><br><td>foo</td><br><td>two</td><br><td>2</td><br></tr><br><tr><br><th>2</th><br><td>bar</td><br><td>one</td><br><td>3</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">right</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key1</th><br><th>key2</th><br><th>rval</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>foo</td><br><td>one</td><br><td>4</td><br></tr><br><tr><br><th>1</th><br><td>foo</td><br><td>one</td><br><td>5</td><br></tr><br><tr><br><th>2</th><br><td>bar</td><br><td>one</td><br><td>6</td><br></tr><br><tr><br><th>3</th><br><td>bar</td><br><td>two</td><br><td>7</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(left, right, on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>], how=<span class="string">'outer'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key1</th><br><th>key2</th><br><th>lval</th><br><th>rval</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>foo</td><br><td>one</td><br><td>1.0</td><br><td>4.0</td><br></tr><br><tr><br><th>1</th><br><td>foo</td><br><td>one</td><br><td>1.0</td><br><td>5.0</td><br></tr><br><tr><br><th>2</th><br><td>foo</td><br><td>two</td><br><td>2.0</td><br><td>NaN</td><br></tr><br><tr><br><th>3</th><br><td>bar</td><br><td>one</td><br><td>3.0</td><br><td>6.0</td><br></tr><br><tr><br><th>4</th><br><td>bar</td><br><td>two</td><br><td>NaN</td><br><td>7.0</td><br></tr><br><br></tbody><br></table><br></div><p>列名重复问题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(left, right, on=<span class="string">'key1'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key1</th><br><th>key2_x</th><br><th>lval</th><br><th>key2_y</th><br><th>rval</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>foo</td><br><td>one</td><br><td>1</td><br><td>one</td><br><td>4</td><br></tr><br><tr><br><th>1</th><br><td>foo</td><br><td>one</td><br><td>1</td><br><td>one</td><br><td>5</td><br></tr><br><tr><br><th>2</th><br><td>foo</td><br><td>two</td><br><td>2</td><br><td>one</td><br><td>4</td><br></tr><br><tr><br><th>3</th><br><td>foo</td><br><td>two</td><br><td>2</td><br><td>one</td><br><td>5</td><br></tr><br><tr><br><th>4</th><br><td>bar</td><br><td>one</td><br><td>3</td><br><td>one</td><br><td>6</td><br></tr><br><tr><br><th>5</th><br><td>bar</td><br><td>one</td><br><td>3</td><br><td>two</td><br><td>7</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(left, right, on=<span class="string">'key1'</span>, suffixes=(<span class="string">'_left'</span>, <span class="string">'_right'</span>))</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key1</th><br><th>key2_left</th><br><th>lval</th><br><th>key2_right</th><br><th>rval</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>foo</td><br><td>one</td><br><td>1</td><br><td>one</td><br><td>4</td><br></tr><br><tr><br><th>1</th><br><td>foo</td><br><td>one</td><br><td>1</td><br><td>one</td><br><td>5</td><br></tr><br><tr><br><th>2</th><br><td>foo</td><br><td>two</td><br><td>2</td><br><td>one</td><br><td>4</td><br></tr><br><tr><br><th>3</th><br><td>foo</td><br><td>two</td><br><td>2</td><br><td>one</td><br><td>5</td><br></tr><br><tr><br><th>4</th><br><td>bar</td><br><td>one</td><br><td>3</td><br><td>one</td><br><td>6</td><br></tr><br><tr><br><th>5</th><br><td>bar</td><br><td>one</td><br><td>3</td><br><td>two</td><br><td>7</td><br></tr><br><br></tbody><br></table><br></div><h3 id="索引上的合并"><a href="#索引上的合并" class="headerlink" title="索引上的合并"></a>索引上的合并</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">left1 = DataFrame(&#123;<span class="string">'key'</span>: [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>],</div><div class="line">                  <span class="string">'value'</span>: range(<span class="number">6</span>)&#125;)</div><div class="line">right1 = DataFrame(&#123;<span class="string">'group_val'</span>: [<span class="number">3.5</span>, <span class="number">7</span>]&#125;, index=[<span class="string">'a'</span>, <span class="string">'b'</span>])</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">left1</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key</th><br><th>value</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>a</td><br><td>0</td><br></tr><br><tr><br><th>1</th><br><td>b</td><br><td>1</td><br></tr><br><tr><br><th>2</th><br><td>a</td><br><td>2</td><br></tr><br><tr><br><th>3</th><br><td>a</td><br><td>3</td><br></tr><br><tr><br><th>4</th><br><td>b</td><br><td>4</td><br></tr><br><tr><br><th>5</th><br><td>c</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">right1</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>group_val</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>3.5</td><br></tr><br><tr><br><th>b</th><br><td>7.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(left1, right1, left_on=<span class="string">'key'</span>, right_index=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key</th><br><th>value</th><br><th>group_val</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>a</td><br><td>0</td><br><td>3.5</td><br></tr><br><tr><br><th>2</th><br><td>a</td><br><td>2</td><br><td>3.5</td><br></tr><br><tr><br><th>3</th><br><td>a</td><br><td>3</td><br><td>3.5</td><br></tr><br><tr><br><th>1</th><br><td>b</td><br><td>1</td><br><td>7.0</td><br></tr><br><tr><br><th>4</th><br><td>b</td><br><td>4</td><br><td>7.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(left1, right1, left_on=<span class="string">'key'</span>, right_index=<span class="keyword">True</span>, how=<span class="string">'outer'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key</th><br><th>value</th><br><th>group_val</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>a</td><br><td>0</td><br><td>3.5</td><br></tr><br><tr><br><th>2</th><br><td>a</td><br><td>2</td><br><td>3.5</td><br></tr><br><tr><br><th>3</th><br><td>a</td><br><td>3</td><br><td>3.5</td><br></tr><br><tr><br><th>1</th><br><td>b</td><br><td>1</td><br><td>7.0</td><br></tr><br><tr><br><th>4</th><br><td>b</td><br><td>4</td><br><td>7.0</td><br></tr><br><tr><br><th>5</th><br><td>c</td><br><td>5</td><br><td>NaN</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">lefth = DataFrame(&#123;<span class="string">'key1'</span>: [<span class="string">'Ohio'</span>, <span class="string">'Ohio'</span>, <span class="string">'Ohio'</span>, <span class="string">'Nevada'</span>, <span class="string">'Nevada'</span>],</div><div class="line">                   <span class="string">'key2'</span>: [<span class="number">2000</span>, <span class="number">2001</span>, <span class="number">2002</span>, <span class="number">2001</span>, <span class="number">2002</span>],</div><div class="line">                   <span class="string">'data'</span>: np.arange(<span class="number">5.</span>)&#125;)</div><div class="line">righth = DataFrame(np.arange(<span class="number">12</span>).reshape((<span class="number">6</span>, <span class="number">2</span>)),</div><div class="line">                   index=[[<span class="string">'Nevada'</span>, <span class="string">'Nevada'</span>, <span class="string">'Ohio'</span>, <span class="string">'Ohio'</span>, <span class="string">'Ohio'</span>, <span class="string">'Ohio'</span>],</div><div class="line">                          [<span class="number">2001</span>, <span class="number">2000</span>, <span class="number">2000</span>, <span class="number">2000</span>, <span class="number">2001</span>, <span class="number">2002</span>]],</div><div class="line">                   columns=[<span class="string">'event1'</span>, <span class="string">'event2'</span>])</div><div class="line">lefth</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data</th><br><th>key1</th><br><th>key2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>Ohio</td><br><td>2000</td><br></tr><br><tr><br><th>1</th><br><td>1.0</td><br><td>Ohio</td><br><td>2001</td><br></tr><br><tr><br><th>2</th><br><td>2.0</td><br><td>Ohio</td><br><td>2002</td><br></tr><br><tr><br><th>3</th><br><td>3.0</td><br><td>Nevada</td><br><td>2001</td><br></tr><br><tr><br><th>4</th><br><td>4.0</td><br><td>Nevada</td><br><td>2002</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">righth</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th></th><br><th>event1</th><br><th>event2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th rowspan="2" valign="top">Nevada</th><br><th>2001</th><br><td>0</td><br><td>1</td><br></tr><br><tr><br><th>2000</th><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th rowspan="4" valign="top">Ohio</th><br><th>2000</th><br><td>4</td><br><td>5</td><br></tr><br><tr><br><th>2000</th><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>2001</th><br><td>8</td><br><td>9</td><br></tr><br><tr><br><th>2002</th><br><td>10</td><br><td>11</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(lefth, righth, left_on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>], right_index=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data</th><br><th>key1</th><br><th>key2</th><br><th>event1</th><br><th>event2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>Ohio</td><br><td>2000</td><br><td>4</td><br><td>5</td><br></tr><br><tr><br><th>0</th><br><td>0.0</td><br><td>Ohio</td><br><td>2000</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>1</th><br><td>1.0</td><br><td>Ohio</td><br><td>2001</td><br><td>8</td><br><td>9</td><br></tr><br><tr><br><th>2</th><br><td>2.0</td><br><td>Ohio</td><br><td>2002</td><br><td>10</td><br><td>11</td><br></tr><br><tr><br><th>3</th><br><td>3.0</td><br><td>Nevada</td><br><td>2001</td><br><td>0</td><br><td>1</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pd.merge(lefth, righth, left_on=[<span class="string">'key1'</span>, <span class="string">'key2'</span>],</div><div class="line">         right_index=<span class="keyword">True</span>, how=<span class="string">'outer'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data</th><br><th>key1</th><br><th>key2</th><br><th>event1</th><br><th>event2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>Ohio</td><br><td>2000.0</td><br><td>4.0</td><br><td>5.0</td><br></tr><br><tr><br><th>0</th><br><td>0.0</td><br><td>Ohio</td><br><td>2000.0</td><br><td>6.0</td><br><td>7.0</td><br></tr><br><tr><br><th>1</th><br><td>1.0</td><br><td>Ohio</td><br><td>2001.0</td><br><td>8.0</td><br><td>9.0</td><br></tr><br><tr><br><th>2</th><br><td>2.0</td><br><td>Ohio</td><br><td>2002.0</td><br><td>10.0</td><br><td>11.0</td><br></tr><br><tr><br><th>3</th><br><td>3.0</td><br><td>Nevada</td><br><td>2001.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>4</th><br><td>4.0</td><br><td>Nevada</td><br><td>2002.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>4</th><br><td>NaN</td><br><td>Nevada</td><br><td>2000.0</td><br><td>2.0</td><br><td>3.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">left2 = DataFrame([[<span class="number">1.</span>, <span class="number">2.</span>], [<span class="number">3.</span>, <span class="number">4.</span>], [<span class="number">5.</span>, <span class="number">6.</span>]], index=[<span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>],</div><div class="line">                 columns=[<span class="string">'Ohio'</span>, <span class="string">'Nevada'</span>])</div><div class="line">right2 = DataFrame([[<span class="number">7.</span>, <span class="number">8.</span>], [<span class="number">9.</span>, <span class="number">10.</span>], [<span class="number">11.</span>, <span class="number">12.</span>], [<span class="number">13</span>, <span class="number">14</span>]],</div><div class="line">                   index=[<span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>], columns=[<span class="string">'Missouri'</span>, <span class="string">'Alabama'</span>])</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">left2</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Ohio</th><br><th>Nevada</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>1.0</td><br><td>2.0</td><br></tr><br><tr><br><th>c</th><br><td>3.0</td><br><td>4.0</td><br></tr><br><tr><br><th>e</th><br><td>5.0</td><br><td>6.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">right2</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Missouri</th><br><th>Alabama</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>b</th><br><td>7.0</td><br><td>8.0</td><br></tr><br><tr><br><th>c</th><br><td>9.0</td><br><td>10.0</td><br></tr><br><tr><br><th>d</th><br><td>11.0</td><br><td>12.0</td><br></tr><br><tr><br><th>e</th><br><td>13.0</td><br><td>14.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.merge(left2, right2, how=<span class="string">'outer'</span>, left_index=<span class="keyword">True</span>, right_index=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Ohio</th><br><th>Nevada</th><br><th>Missouri</th><br><th>Alabama</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>1.0</td><br><td>2.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>b</th><br><td>NaN</td><br><td>NaN</td><br><td>7.0</td><br><td>8.0</td><br></tr><br><tr><br><th>c</th><br><td>3.0</td><br><td>4.0</td><br><td>9.0</td><br><td>10.0</td><br></tr><br><tr><br><th>d</th><br><td>NaN</td><br><td>NaN</td><br><td>11.0</td><br><td>12.0</td><br></tr><br><tr><br><th>e</th><br><td>5.0</td><br><td>6.0</td><br><td>13.0</td><br><td>14.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">left2.join(right2, how=<span class="string">'outer'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Ohio</th><br><th>Nevada</th><br><th>Missouri</th><br><th>Alabama</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>1.0</td><br><td>2.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>b</th><br><td>NaN</td><br><td>NaN</td><br><td>7.0</td><br><td>8.0</td><br></tr><br><tr><br><th>c</th><br><td>3.0</td><br><td>4.0</td><br><td>9.0</td><br><td>10.0</td><br></tr><br><tr><br><th>d</th><br><td>NaN</td><br><td>NaN</td><br><td>11.0</td><br><td>12.0</td><br></tr><br><tr><br><th>e</th><br><td>5.0</td><br><td>6.0</td><br><td>13.0</td><br><td>14.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">left1.join(right1, on=<span class="string">'key'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key</th><br><th>value</th><br><th>group_val</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>a</td><br><td>0</td><br><td>3.5</td><br></tr><br><tr><br><th>1</th><br><td>b</td><br><td>1</td><br><td>7.0</td><br></tr><br><tr><br><th>2</th><br><td>a</td><br><td>2</td><br><td>3.5</td><br></tr><br><tr><br><th>3</th><br><td>a</td><br><td>3</td><br><td>3.5</td><br></tr><br><tr><br><th>4</th><br><td>b</td><br><td>4</td><br><td>7.0</td><br></tr><br><tr><br><th>5</th><br><td>c</td><br><td>5</td><br><td>NaN</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">another = DataFrame([[<span class="number">7.</span>, <span class="number">8.</span>], [<span class="number">9.</span>, <span class="number">10.</span>], [<span class="number">11.</span>, <span class="number">12.</span>], [<span class="number">16.</span>, <span class="number">17.</span>]],</div><div class="line">                    index=[<span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>], columns=[<span class="string">'New York'</span>, <span class="string">'Oregon'</span>])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>New York</th><br><th>Oregon</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>7.0</td><br><td>8.0</td><br></tr><br><tr><br><th>c</th><br><td>9.0</td><br><td>10.0</td><br></tr><br><tr><br><th>e</th><br><td>11.0</td><br><td>12.0</td><br></tr><br><tr><br><th>f</th><br><td>16.0</td><br><td>17.0</td><br></tr><br><br></tbody><br></table><br></div><p>相当于三个表进行合并</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">left2</div><div class="line">right2</div><div class="line">another</div><div class="line">left2.join([right2, another])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Ohio</th><br><th>Nevada</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>1.0</td><br><td>2.0</td><br></tr><br><tr><br><th>c</th><br><td>3.0</td><br><td>4.0</td><br></tr><br><tr><br><th>e</th><br><td>5.0</td><br><td>6.0</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Missouri</th><br><th>Alabama</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>b</th><br><td>7.0</td><br><td>8.0</td><br></tr><br><tr><br><th>c</th><br><td>9.0</td><br><td>10.0</td><br></tr><br><tr><br><th>d</th><br><td>11.0</td><br><td>12.0</td><br></tr><br><tr><br><th>e</th><br><td>13.0</td><br><td>14.0</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>New York</th><br><th>Oregon</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>7.0</td><br><td>8.0</td><br></tr><br><tr><br><th>c</th><br><td>9.0</td><br><td>10.0</td><br></tr><br><tr><br><th>e</th><br><td>11.0</td><br><td>12.0</td><br></tr><br><tr><br><th>f</th><br><td>16.0</td><br><td>17.0</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Ohio</th><br><th>Nevada</th><br><th>Missouri</th><br><th>Alabama</th><br><th>New York</th><br><th>Oregon</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>1.0</td><br><td>2.0</td><br><td>NaN</td><br><td>NaN</td><br><td>7.0</td><br><td>8.0</td><br></tr><br><tr><br><th>c</th><br><td>3.0</td><br><td>4.0</td><br><td>9.0</td><br><td>10.0</td><br><td>9.0</td><br><td>10.0</td><br></tr><br><tr><br><th>e</th><br><td>5.0</td><br><td>6.0</td><br><td>13.0</td><br><td>14.0</td><br><td>11.0</td><br><td>12.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">left2.join([right2, another], how=<span class="string">'outer'</span>)</div></pre></td></tr></table></figure><h3 id="轴向连接"><a href="#轴向连接" class="headerlink" title="轴向连接"></a>轴向连接</h3><p>之前指的都是行级别的连接操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">arr = np.arange(<span class="number">12</span>).reshape((<span class="number">3</span>, <span class="number">4</span>))</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">arr</div></pre></td></tr></table></figure><pre><code>array([[ 0,  1,  2,  3],
       [ 4,  5,  6,  7],
       [ 8,  9, 10, 11]])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">np.concatenate([arr, arr], axis=<span class="number">1</span>)</div></pre></td></tr></table></figure><pre><code>array([[ 0,  1,  2,  3,  0,  1,  2,  3],
       [ 4,  5,  6,  7,  4,  5,  6,  7],
       [ 8,  9, 10, 11,  8,  9, 10, 11]])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s1 = Series([<span class="number">0</span>, <span class="number">1</span>], index=[<span class="string">'a'</span>, <span class="string">'b'</span>])</div><div class="line">s2 = Series([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], index=[<span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>])</div><div class="line">s3 = Series([<span class="number">5</span>, <span class="number">6</span>], index=[<span class="string">'f'</span>, <span class="string">'g'</span>])</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.concat([s1, s2, s3])</div></pre></td></tr></table></figure><pre><code>a    0
b    1
c    2
d    3
e    4
f    5
g    6
dtype: int64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.concat([s1, s2, s3], axis=<span class="number">1</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br><th>2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>b</th><br><td>1.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>c</th><br><td>NaN</td><br><td>2.0</td><br><td>NaN</td><br></tr><br><tr><br><th>d</th><br><td>NaN</td><br><td>3.0</td><br><td>NaN</td><br></tr><br><tr><br><th>e</th><br><td>NaN</td><br><td>4.0</td><br><td>NaN</td><br></tr><br><tr><br><th>f</th><br><td>NaN</td><br><td>NaN</td><br><td>5.0</td><br></tr><br><tr><br><th>g</th><br><td>NaN</td><br><td>NaN</td><br><td>6.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s4 = pd.concat([s1 * <span class="number">5</span>, s3])</div><div class="line">s4</div></pre></td></tr></table></figure><pre><code>a    0
b    5
f    5
g    6
dtype: int64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.concat([s1, s4], axis=<span class="number">1</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0.0</td><br><td>0</td><br></tr><br><tr><br><th>b</th><br><td>1.0</td><br><td>5</td><br></tr><br><tr><br><th>f</th><br><td>NaN</td><br><td>5</td><br></tr><br><tr><br><th>g</th><br><td>NaN</td><br><td>6</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.concat([s1, s4], axis=<span class="number">1</span>, join=<span class="string">'inner'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0</td><br><td>0</td><br></tr><br><tr><br><th>b</th><br><td>1</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.concat([s1, s4], axis=<span class="number">1</span>, join_axes=[[<span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>, <span class="string">'e'</span>]])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>c</th><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>b</th><br><td>1.0</td><br><td>5.0</td><br></tr><br><tr><br><th>e</th><br><td>NaN</td><br><td>NaN</td><br></tr><br><br></tbody><br></table><br></div><p>在连接轴上建立一个层次化索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s1</div><div class="line">s3</div><div class="line">result = pd.concat([s1, s1, s3], keys=[<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>])</div></pre></td></tr></table></figure><pre><code>a    0
b    1
dtype: int64






f    5
g    6
dtype: int64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result</div></pre></td></tr></table></figure><pre><code>one    a    0
       b    1
two    a    0
       b    1
three  f    5
       g    6
dtype: int64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Much more on the unstack function later</span></div><div class="line">result.unstack()</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>f</th><br><th>g</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>one</th><br><td>0.0</td><br><td>1.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>two</th><br><td>0.0</td><br><td>1.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>three</th><br><td>NaN</td><br><td>NaN</td><br><td>5.0</td><br><td>6.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.concat([s1, s2, s3], axis=<span class="number">1</span>, keys=[<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>one</th><br><th>two</th><br><th>three</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>b</th><br><td>1.0</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>c</th><br><td>NaN</td><br><td>2.0</td><br><td>NaN</td><br></tr><br><tr><br><th>d</th><br><td>NaN</td><br><td>3.0</td><br><td>NaN</td><br></tr><br><tr><br><th>e</th><br><td>NaN</td><br><td>4.0</td><br><td>NaN</td><br></tr><br><tr><br><th>f</th><br><td>NaN</td><br><td>NaN</td><br><td>5.0</td><br></tr><br><tr><br><th>g</th><br><td>NaN</td><br><td>NaN</td><br><td>6.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">df1 = DataFrame(np.arange(<span class="number">6</span>).reshape(<span class="number">3</span>, <span class="number">2</span>), index=[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>],</div><div class="line">                columns=[<span class="string">'one'</span>, <span class="string">'two'</span>])</div><div class="line">df2 = DataFrame(<span class="number">5</span> + np.arange(<span class="number">4</span>).reshape(<span class="number">2</span>, <span class="number">2</span>), index=[<span class="string">'a'</span>, <span class="string">'c'</span>],</div><div class="line">                columns=[<span class="string">'three'</span>, <span class="string">'four'</span>])</div><div class="line">df1</div><div class="line">df2</div><div class="line">pd.concat([df1, df2], keys=[<span class="string">'level1'</span>, <span class="string">'level2'</span>])</div><div class="line">pd.concat([df1, df2], axis=<span class="number">1</span>, keys=[<span class="string">'level1'</span>, <span class="string">'level2'</span>])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>one</th><br><th>two</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0</td><br><td>1</td><br></tr><br><tr><br><th>b</th><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>c</th><br><td>4</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>three</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>5</td><br><td>6</td><br></tr><br><tr><br><th>c</th><br><td>7</td><br><td>8</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th></th><br><th>four</th><br><th>one</th><br><th>three</th><br><th>two</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th rowspan="3" valign="top">level1</th><br><th>a</th><br><td>NaN</td><br><td>0.0</td><br><td>NaN</td><br><td>1.0</td><br></tr><br><tr><br><th>b</th><br><td>NaN</td><br><td>2.0</td><br><td>NaN</td><br><td>3.0</td><br></tr><br><tr><br><th>c</th><br><td>NaN</td><br><td>4.0</td><br><td>NaN</td><br><td>5.0</td><br></tr><br><tr><br><th rowspan="2" valign="top">level2</th><br><th>a</th><br><td>6.0</td><br><td>NaN</td><br><td>5.0</td><br><td>NaN</td><br></tr><br><tr><br><th>c</th><br><td>8.0</td><br><td>NaN</td><br><td>7.0</td><br><td>NaN</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr><br><th></th><br><th colspan="2" halign="left">level1</th><br><th colspan="2" halign="left">level2</th><br></tr><br><tr><br><th></th><br><th>one</th><br><th>two</th><br><th>three</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0</td><br><td>1</td><br><td>5.0</td><br><td>6.0</td><br></tr><br><tr><br><th>b</th><br><td>2</td><br><td>3</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>c</th><br><td>4</td><br><td>5</td><br><td>7.0</td><br><td>8.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pd.concat(&#123;<span class="string">'level1'</span>: df1, <span class="string">'level2'</span>: df2&#125;, axis=<span class="number">0</span>)</div><div class="line">pd.concat(&#123;<span class="string">'level1'</span>: df1, <span class="string">'level2'</span>: df2&#125;, axis=<span class="number">1</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th></th><br><th>four</th><br><th>one</th><br><th>three</th><br><th>two</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th rowspan="3" valign="top">level1</th><br><th>a</th><br><td>NaN</td><br><td>0.0</td><br><td>NaN</td><br><td>1.0</td><br></tr><br><tr><br><th>b</th><br><td>NaN</td><br><td>2.0</td><br><td>NaN</td><br><td>3.0</td><br></tr><br><tr><br><th>c</th><br><td>NaN</td><br><td>4.0</td><br><td>NaN</td><br><td>5.0</td><br></tr><br><tr><br><th rowspan="2" valign="top">level2</th><br><th>a</th><br><td>6.0</td><br><td>NaN</td><br><td>5.0</td><br><td>NaN</td><br></tr><br><tr><br><th>c</th><br><td>8.0</td><br><td>NaN</td><br><td>7.0</td><br><td>NaN</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr><br><th></th><br><th colspan="2" halign="left">level1</th><br><th colspan="2" halign="left">level2</th><br></tr><br><tr><br><th></th><br><th>one</th><br><th>two</th><br><th>three</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0</td><br><td>1</td><br><td>5.0</td><br><td>6.0</td><br></tr><br><tr><br><th>b</th><br><td>2</td><br><td>3</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>c</th><br><td>4</td><br><td>5</td><br><td>7.0</td><br><td>8.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pd.concat([df1, df2], axis=<span class="number">1</span>, keys=[<span class="string">'level1'</span>, <span class="string">'level2'</span>],</div><div class="line">          names=[<span class="string">'upper'</span>, <span class="string">'lower'</span>])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr><br><th>upper</th><br><th colspan="2" halign="left">level1</th><br><th colspan="2" halign="left">level2</th><br></tr><br><tr><br><th>lower</th><br><th>one</th><br><th>two</th><br><th>three</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>a</th><br><td>0</td><br><td>1</td><br><td>5.0</td><br><td>6.0</td><br></tr><br><tr><br><th>b</th><br><td>2</td><br><td>3</td><br><td>NaN</td><br><td>NaN</td><br></tr><br><tr><br><th>c</th><br><td>4</td><br><td>5</td><br><td>7.0</td><br><td>8.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">df1 = DataFrame(np.random.randn(<span class="number">3</span>, <span class="number">4</span>), columns=[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>])</div><div class="line">df2 = DataFrame(np.random.randn(<span class="number">2</span>, <span class="number">3</span>), columns=[<span class="string">'b'</span>, <span class="string">'d'</span>, <span class="string">'a'</span>])</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df1</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>c</th><br><th>d</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>-0.204708</td><br><td>0.478943</td><br><td>-0.519439</td><br><td>-0.555730</td><br></tr><br><tr><br><th>1</th><br><td>1.965781</td><br><td>1.393406</td><br><td>0.092908</td><br><td>0.281746</td><br></tr><br><tr><br><th>2</th><br><td>0.769023</td><br><td>1.246435</td><br><td>1.007189</td><br><td>-1.296221</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df2</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>b</th><br><th>d</th><br><th>a</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.274992</td><br><td>0.228913</td><br><td>1.352917</td><br></tr><br><tr><br><th>1</th><br><td>0.886429</td><br><td>-2.001637</td><br><td>-0.371843</td><br></tr><br><br></tbody><br></table><br></div><p>去除无关的行索引</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pd.concat([df1, df2], ignore_index=<span class="keyword">False</span>)</div><div class="line">pd.concat([df1, df2], ignore_index=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>c</th><br><th>d</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>-0.204708</td><br><td>0.478943</td><br><td>-0.519439</td><br><td>-0.555730</td><br></tr><br><tr><br><th>1</th><br><td>1.965781</td><br><td>1.393406</td><br><td>0.092908</td><br><td>0.281746</td><br></tr><br><tr><br><th>2</th><br><td>0.769023</td><br><td>1.246435</td><br><td>1.007189</td><br><td>-1.296221</td><br></tr><br><tr><br><th>0</th><br><td>1.352917</td><br><td>0.274992</td><br><td>NaN</td><br><td>0.228913</td><br></tr><br><tr><br><th>1</th><br><td>-0.371843</td><br><td>0.886429</td><br><td>NaN</td><br><td>-2.001637</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>c</th><br><th>d</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>-0.204708</td><br><td>0.478943</td><br><td>-0.519439</td><br><td>-0.555730</td><br></tr><br><tr><br><th>1</th><br><td>1.965781</td><br><td>1.393406</td><br><td>0.092908</td><br><td>0.281746</td><br></tr><br><tr><br><th>2</th><br><td>0.769023</td><br><td>1.246435</td><br><td>1.007189</td><br><td>-1.296221</td><br></tr><br><tr><br><th>3</th><br><td>1.352917</td><br><td>0.274992</td><br><td>NaN</td><br><td>0.228913</td><br></tr><br><tr><br><th>4</th><br><td>-0.371843</td><br><td>0.886429</td><br><td>NaN</td><br><td>-2.001637</td><br></tr><br><br></tbody><br></table><br></div><h3 id="合并重叠数据"><a href="#合并重叠数据" class="headerlink" title="合并重叠数据"></a>合并重叠数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">a = Series([np.nan, <span class="number">2.5</span>, np.nan, <span class="number">3.5</span>, <span class="number">4.5</span>, np.nan],</div><div class="line">           index=[<span class="string">'f'</span>, <span class="string">'e'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>])</div><div class="line">b = Series(np.arange(len(a), dtype=np.float64),</div><div class="line">           index=[<span class="string">'f'</span>, <span class="string">'e'</span>, <span class="string">'d'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>])</div><div class="line">b[<span class="number">-1</span>] = np.nan</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">a</div></pre></td></tr></table></figure><pre><code>f    NaN
e    2.5
d    NaN
c    3.5
b    4.5
a    NaN
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">b</div></pre></td></tr></table></figure><pre><code>f    0.0
e    1.0
d    2.0
c    3.0
b    4.0
a    NaN
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">np.where(pd.isnull(a), b, a)</div></pre></td></tr></table></figure><pre><code>array([ 0. ,  2.5,  2. ,  3.5,  4.5,  nan])
</code></pre><p>combine_first, 重叠值合并，且进行数据对其</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">b[:<span class="number">-2</span>].combine_first(a[<span class="number">2</span>:])</div></pre></td></tr></table></figure><pre><code>a    NaN
b    4.5
c    3.0
d    2.0
e    1.0
f    0.0
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">df1 = DataFrame(&#123;<span class="string">'a'</span>: [<span class="number">1.</span>, np.nan, <span class="number">5.</span>, np.nan],</div><div class="line">                 <span class="string">'b'</span>: [np.nan, <span class="number">2.</span>, np.nan, <span class="number">6.</span>],</div><div class="line">                 <span class="string">'c'</span>: range(<span class="number">2</span>, <span class="number">18</span>, <span class="number">4</span>)&#125;)</div><div class="line">df2 = DataFrame(&#123;<span class="string">'a'</span>: [<span class="number">5.</span>, <span class="number">4.</span>, np.nan, <span class="number">3.</span>, <span class="number">7.</span>],</div><div class="line">                 <span class="string">'b'</span>: [np.nan, <span class="number">3.</span>, <span class="number">4.</span>, <span class="number">6.</span>, <span class="number">8.</span>]&#125;)</div><div class="line">df1</div><div class="line">df2</div><div class="line">df1.combine_first(df2)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>c</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>1.0</td><br><td>NaN</td><br><td>2</td><br></tr><br><tr><br><th>1</th><br><td>NaN</td><br><td>2.0</td><br><td>6</td><br></tr><br><tr><br><th>2</th><br><td>5.0</td><br><td>NaN</td><br><td>10</td><br></tr><br><tr><br><th>3</th><br><td>NaN</td><br><td>6.0</td><br><td>14</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>5.0</td><br><td>NaN</td><br></tr><br><tr><br><th>1</th><br><td>4.0</td><br><td>3.0</td><br></tr><br><tr><br><th>2</th><br><td>NaN</td><br><td>4.0</td><br></tr><br><tr><br><th>3</th><br><td>3.0</td><br><td>6.0</td><br></tr><br><tr><br><th>4</th><br><td>7.0</td><br><td>8.0</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>c</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>1.0</td><br><td>NaN</td><br><td>2.0</td><br></tr><br><tr><br><th>1</th><br><td>4.0</td><br><td>2.0</td><br><td>6.0</td><br></tr><br><tr><br><th>2</th><br><td>5.0</td><br><td>4.0</td><br><td>10.0</td><br></tr><br><tr><br><th>3</th><br><td>3.0</td><br><td>6.0</td><br><td>14.0</td><br></tr><br><tr><br><th>4</th><br><td>7.0</td><br><td>8.0</td><br><td>NaN</td><br></tr><br><br></tbody><br></table><br></div><h2 id="重塑和轴向旋转"><a href="#重塑和轴向旋转" class="headerlink" title="重塑和轴向旋转"></a>重塑和轴向旋转</h2><h3 id="重塑层次化索引"><a href="#重塑层次化索引" class="headerlink" title="重塑层次化索引"></a>重塑层次化索引</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">data = DataFrame(np.arange(<span class="number">6</span>).reshape((<span class="number">2</span>, <span class="number">3</span>)),</div><div class="line">                 index=pd.Index([<span class="string">'Ohio'</span>, <span class="string">'Colorado'</span>], name=<span class="string">'state'</span>),</div><div class="line">                 columns=pd.Index([<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>], name=<span class="string">'number'</span>))</div><div class="line">data</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>number</th><br><th>one</th><br><th>two</th><br><th>three</th><br></tr><br><tr><br><th>state</th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>Ohio</th><br><td>0</td><br><td>1</td><br><td>2</td><br></tr><br><tr><br><th>Colorado</th><br><td>3</td><br><td>4</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><p>stack将列旋转为行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">result = data.stack()</div><div class="line">result</div></pre></td></tr></table></figure><pre><code>state     number
Ohio      one       0
          two       1
          three     2
Colorado  one       3
          two       4
          three     5
dtype: int32
</code></pre><p>unstack将行旋转为列，默认操作最内层</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result.unstack()</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>number</th><br><th>one</th><br><th>two</th><br><th>three</th><br></tr><br><tr><br><th>state</th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>Ohio</th><br><td>0</td><br><td>1</td><br><td>2</td><br></tr><br><tr><br><th>Colorado</th><br><td>3</td><br><td>4</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result.unstack(<span class="number">0</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>state</th><br><th>Ohio</th><br><th>Colorado</th><br></tr><br><tr><br><th>number</th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>one</th><br><td>0</td><br><td>3</td><br></tr><br><tr><br><th>two</th><br><td>1</td><br><td>4</td><br></tr><br><tr><br><th>three</th><br><td>2</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result.unstack(<span class="string">'state'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>state</th><br><th>Ohio</th><br><th>Colorado</th><br></tr><br><tr><br><th>number</th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>one</th><br><td>0</td><br><td>3</td><br></tr><br><tr><br><th>two</th><br><td>1</td><br><td>4</td><br></tr><br><tr><br><th>three</th><br><td>2</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">s1 = Series([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], index=[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>])</div><div class="line">s2 = Series([<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], index=[<span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>])</div><div class="line">s1</div><div class="line">s2</div><div class="line">data2 = pd.concat([s1, s2], keys=[<span class="string">'one'</span>, <span class="string">'two'</span>])</div><div class="line">data2</div><div class="line">data2.unstack()</div></pre></td></tr></table></figure><pre><code>a    0
b    1
c    2
d    3
dtype: int64






c    4
d    5
e    6
dtype: int64






one  a    0
     b    1
     c    2
     d    3
two  c    4
     d    5
     e    6
dtype: int64
</code></pre><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>c</th><br><th>d</th><br><th>e</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>one</th><br><td>0.0</td><br><td>1.0</td><br><td>2.0</td><br><td>3.0</td><br><td>NaN</td><br></tr><br><tr><br><th>two</th><br><td>NaN</td><br><td>NaN</td><br><td>4.0</td><br><td>5.0</td><br><td>6.0</td><br></tr><br><br></tbody><br></table><br></div><p>stack默认会滤除缺失值，因此两者可逆</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data2.unstack().stack()</div></pre></td></tr></table></figure><pre><code>one  a    0.0
     b    1.0
     c    2.0
     d    3.0
two  c    4.0
     d    5.0
     e    6.0
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data2.unstack().stack(dropna=<span class="keyword">False</span>)</div></pre></td></tr></table></figure><pre><code>one  a    0.0
     b    1.0
     c    2.0
     d    3.0
     e    NaN
two  a    NaN
     b    NaN
     c    4.0
     d    5.0
     e    6.0
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">result</div><div class="line">df = DataFrame(&#123;<span class="string">'left'</span>: result, <span class="string">'right'</span>: result + <span class="number">5</span>&#125;,</div><div class="line">               columns=pd.Index([<span class="string">'left'</span>, <span class="string">'right'</span>], name=<span class="string">'side'</span>))</div><div class="line">df</div></pre></td></tr></table></figure><pre><code>state     number
Ohio      one       0
          two       1
          three     2
Colorado  one       3
          two       4
          three     5
dtype: int32
</code></pre><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>side</th><br><th>left</th><br><th>right</th><br></tr><br><tr><br><th>state</th><br><th>number</th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th rowspan="3" valign="top">Ohio</th><br><th>one</th><br><td>0</td><br><td>5</td><br></tr><br><tr><br><th>two</th><br><td>1</td><br><td>6</td><br></tr><br><tr><br><th>three</th><br><td>2</td><br><td>7</td><br></tr><br><tr><br><th rowspan="3" valign="top">Colorado</th><br><th>one</th><br><td>3</td><br><td>8</td><br></tr><br><tr><br><th>two</th><br><td>4</td><br><td>9</td><br></tr><br><tr><br><th>three</th><br><td>5</td><br><td>10</td><br></tr><br><br></tbody><br></table><br></div><p>DataFrame作为旋转轴的级别将成为结果中的最低级别（axis=MAX）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.unstack(<span class="string">'state'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr><br><th>side</th><br><th colspan="2" halign="left">left</th><br><th colspan="2" halign="left">right</th><br></tr><br><tr><br><th>state</th><br><th>Ohio</th><br><th>Colorado</th><br><th>Ohio</th><br><th>Colorado</th><br></tr><br><tr><br><th>number</th><br><th></th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>one</th><br><td>0</td><br><td>3</td><br><td>5</td><br><td>8</td><br></tr><br><tr><br><th>two</th><br><td>1</td><br><td>4</td><br><td>6</td><br><td>9</td><br></tr><br><tr><br><th>three</th><br><td>2</td><br><td>5</td><br><td>7</td><br><td>10</td><br></tr><br><br></tbody><br></table><br></div><p>stack操作将axis-1?</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.unstack(<span class="string">'state'</span>).stack(<span class="string">'side'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>state</th><br><th>Ohio</th><br><th>Colorado</th><br></tr><br><tr><br><th>number</th><br><th>side</th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th rowspan="2" valign="top">one</th><br><th>left</th><br><td>0</td><br><td>3</td><br></tr><br><tr><br><th>right</th><br><td>5</td><br><td>8</td><br></tr><br><tr><br><th rowspan="2" valign="top">two</th><br><th>left</th><br><td>1</td><br><td>4</td><br></tr><br><tr><br><th>right</th><br><td>6</td><br><td>9</td><br></tr><br><tr><br><th rowspan="2" valign="top">three</th><br><th>left</th><br><td>2</td><br><td>5</td><br></tr><br><tr><br><th>right</th><br><td>7</td><br><td>10</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">df.unstack(<span class="string">'state'</span>)</div><div class="line">df.unstack(<span class="string">'state'</span>).stack(<span class="string">'state'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr><br><th>side</th><br><th colspan="2" halign="left">left</th><br><th colspan="2" halign="left">right</th><br></tr><br><tr><br><th>state</th><br><th>Ohio</th><br><th>Colorado</th><br><th>Ohio</th><br><th>Colorado</th><br></tr><br><tr><br><th>number</th><br><th></th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>one</th><br><td>0</td><br><td>3</td><br><td>5</td><br><td>8</td><br></tr><br><tr><br><th>two</th><br><td>1</td><br><td>4</td><br><td>6</td><br><td>9</td><br></tr><br><tr><br><th>three</th><br><td>2</td><br><td>5</td><br><td>7</td><br><td>10</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>side</th><br><th>left</th><br><th>right</th><br></tr><br><tr><br><th>number</th><br><th>state</th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th rowspan="2" valign="top">one</th><br><th>Ohio</th><br><td>0</td><br><td>5</td><br></tr><br><tr><br><th>Colorado</th><br><td>3</td><br><td>8</td><br></tr><br><tr><br><th rowspan="2" valign="top">two</th><br><th>Ohio</th><br><td>1</td><br><td>6</td><br></tr><br><tr><br><th>Colorado</th><br><td>4</td><br><td>9</td><br></tr><br><tr><br><th rowspan="2" valign="top">three</th><br><th>Ohio</th><br><td>2</td><br><td>7</td><br></tr><br><tr><br><th>Colorado</th><br><td>5</td><br><td>10</td><br></tr><br><br></tbody><br></table><br></div><h3 id="将长格式旋转为宽格式"><a href="#将长格式旋转为宽格式" class="headerlink" title="将长格式旋转为宽格式"></a>将长格式旋转为宽格式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">data = pd.read_csv(<span class="string">'ch07/macrodata.csv'</span>)</div><div class="line">data[:<span class="number">10</span>]</div><div class="line">periods = pd.PeriodIndex(year=data.year, quarter=data.quarter, name=<span class="string">'date'</span>)</div><div class="line">periods[:<span class="number">10</span>]</div><div class="line">data = DataFrame(data.to_records(),</div><div class="line">                 columns=pd.Index([<span class="string">'realgdp'</span>, <span class="string">'infl'</span>, <span class="string">'unemp'</span>], name=<span class="string">'item'</span>),</div><div class="line">                 index=periods.to_timestamp(<span class="string">'D'</span>, <span class="string">'end'</span>))</div><div class="line"></div><div class="line">data[:<span class="number">10</span>]</div><div class="line">data.to_records()[:<span class="number">10</span>]</div><div class="line">data.stack()[:<span class="number">10</span>]</div><div class="line">ldata = data.stack().reset_index().rename(columns=&#123;<span class="number">0</span>: <span class="string">'value'</span>&#125;)</div><div class="line">wdata = ldata.pivot(<span class="string">'date'</span>, <span class="string">'item'</span>, <span class="string">'value'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>year</th><br><th>quarter</th><br><th>realgdp</th><br><th>realcons</th><br><th>realinv</th><br><th>realgovt</th><br><th>realdpi</th><br><th>cpi</th><br><th>m1</th><br><th>tbilrate</th><br><th>unemp</th><br><th>pop</th><br><th>infl</th><br><th>realint</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>1959.0</td><br><td>1.0</td><br><td>2710.349</td><br><td>1707.4</td><br><td>286.898</td><br><td>470.045</td><br><td>1886.9</td><br><td>28.98</td><br><td>139.7</td><br><td>2.82</td><br><td>5.8</td><br><td>177.146</td><br><td>0.00</td><br><td>0.00</td><br></tr><br><tr><br><th>1</th><br><td>1959.0</td><br><td>2.0</td><br><td>2778.801</td><br><td>1733.7</td><br><td>310.859</td><br><td>481.301</td><br><td>1919.7</td><br><td>29.15</td><br><td>141.7</td><br><td>3.08</td><br><td>5.1</td><br><td>177.830</td><br><td>2.34</td><br><td>0.74</td><br></tr><br><tr><br><th>2</th><br><td>1959.0</td><br><td>3.0</td><br><td>2775.488</td><br><td>1751.8</td><br><td>289.226</td><br><td>491.260</td><br><td>1916.4</td><br><td>29.35</td><br><td>140.5</td><br><td>3.82</td><br><td>5.3</td><br><td>178.657</td><br><td>2.74</td><br><td>1.09</td><br></tr><br><tr><br><th>3</th><br><td>1959.0</td><br><td>4.0</td><br><td>2785.204</td><br><td>1753.7</td><br><td>299.356</td><br><td>484.052</td><br><td>1931.3</td><br><td>29.37</td><br><td>140.0</td><br><td>4.33</td><br><td>5.6</td><br><td>179.386</td><br><td>0.27</td><br><td>4.06</td><br></tr><br><tr><br><th>4</th><br><td>1960.0</td><br><td>1.0</td><br><td>2847.699</td><br><td>1770.5</td><br><td>331.722</td><br><td>462.199</td><br><td>1955.5</td><br><td>29.54</td><br><td>139.6</td><br><td>3.50</td><br><td>5.2</td><br><td>180.007</td><br><td>2.31</td><br><td>1.19</td><br></tr><br><tr><br><th>5</th><br><td>1960.0</td><br><td>2.0</td><br><td>2834.390</td><br><td>1792.9</td><br><td>298.152</td><br><td>460.400</td><br><td>1966.1</td><br><td>29.55</td><br><td>140.2</td><br><td>2.68</td><br><td>5.2</td><br><td>180.671</td><br><td>0.14</td><br><td>2.55</td><br></tr><br><tr><br><th>6</th><br><td>1960.0</td><br><td>3.0</td><br><td>2839.022</td><br><td>1785.8</td><br><td>296.375</td><br><td>474.676</td><br><td>1967.8</td><br><td>29.75</td><br><td>140.9</td><br><td>2.36</td><br><td>5.6</td><br><td>181.528</td><br><td>2.70</td><br><td>-0.34</td><br></tr><br><tr><br><th>7</th><br><td>1960.0</td><br><td>4.0</td><br><td>2802.616</td><br><td>1788.2</td><br><td>259.764</td><br><td>476.434</td><br><td>1966.6</td><br><td>29.84</td><br><td>141.1</td><br><td>2.29</td><br><td>6.3</td><br><td>182.287</td><br><td>1.21</td><br><td>1.08</td><br></tr><br><tr><br><th>8</th><br><td>1961.0</td><br><td>1.0</td><br><td>2819.264</td><br><td>1787.7</td><br><td>266.405</td><br><td>475.854</td><br><td>1984.5</td><br><td>29.81</td><br><td>142.1</td><br><td>2.37</td><br><td>6.8</td><br><td>182.992</td><br><td>-0.40</td><br><td>2.77</td><br></tr><br><tr><br><th>9</th><br><td>1961.0</td><br><td>2.0</td><br><td>2872.005</td><br><td>1814.3</td><br><td>286.246</td><br><td>480.328</td><br><td>2014.4</td><br><td>29.92</td><br><td>142.9</td><br><td>2.29</td><br><td>7.0</td><br><td>183.691</td><br><td>1.47</td><br><td>0.81</td><br></tr><br><br></tbody><br></table><br></div><pre><code>PeriodIndex([&apos;1959Q1&apos;, &apos;1959Q2&apos;, &apos;1959Q3&apos;, &apos;1959Q4&apos;, &apos;1960Q1&apos;, &apos;1960Q2&apos;,
             &apos;1960Q3&apos;, &apos;1960Q4&apos;, &apos;1961Q1&apos;, &apos;1961Q2&apos;],
            dtype=&apos;int64&apos;, name=&apos;date&apos;, freq=&apos;Q-DEC&apos;)
</code></pre><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>item</th><br><th>realgdp</th><br><th>infl</th><br><th>unemp</th><br></tr><br><tr><br><th>date</th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1959-03-31</th><br><td>2710.349</td><br><td>0.00</td><br><td>5.8</td><br></tr><br><tr><br><th>1959-06-30</th><br><td>2778.801</td><br><td>2.34</td><br><td>5.1</td><br></tr><br><tr><br><th>1959-09-30</th><br><td>2775.488</td><br><td>2.74</td><br><td>5.3</td><br></tr><br><tr><br><th>1959-12-31</th><br><td>2785.204</td><br><td>0.27</td><br><td>5.6</td><br></tr><br><tr><br><th>1960-03-31</th><br><td>2847.699</td><br><td>2.31</td><br><td>5.2</td><br></tr><br><tr><br><th>1960-06-30</th><br><td>2834.390</td><br><td>0.14</td><br><td>5.2</td><br></tr><br><tr><br><th>1960-09-30</th><br><td>2839.022</td><br><td>2.70</td><br><td>5.6</td><br></tr><br><tr><br><th>1960-12-31</th><br><td>2802.616</td><br><td>1.21</td><br><td>6.3</td><br></tr><br><tr><br><th>1961-03-31</th><br><td>2819.264</td><br><td>-0.40</td><br><td>6.8</td><br></tr><br><tr><br><th>1961-06-30</th><br><td>2872.005</td><br><td>1.47</td><br><td>7.0</td><br></tr><br><br></tbody><br></table><br></div><pre><code>rec.array([(datetime.datetime(1959, 3, 31, 0, 0), 2710.349, 0.0, 5.8),
 (datetime.datetime(1959, 6, 30, 0, 0), 2778.801, 2.34, 5.1),
 (datetime.datetime(1959, 9, 30, 0, 0), 2775.488, 2.74, 5.3),
 (datetime.datetime(1959, 12, 31, 0, 0), 2785.204, 0.27, 5.6),
 (datetime.datetime(1960, 3, 31, 0, 0), 2847.699, 2.31, 5.2),
 (datetime.datetime(1960, 6, 30, 0, 0), 2834.39, 0.14, 5.2),
 (datetime.datetime(1960, 9, 30, 0, 0), 2839.022, 2.7, 5.6),
 (datetime.datetime(1960, 12, 31, 0, 0), 2802.616, 1.21, 6.3),
 (datetime.datetime(1961, 3, 31, 0, 0), 2819.264, -0.4, 6.8),
 (datetime.datetime(1961, 6, 30, 0, 0), 2872.005, 1.47, 7.0)], 
          dtype=[(&apos;date&apos;, &apos;O&apos;), (&apos;realgdp&apos;, &apos;&lt;f8&apos;), (&apos;infl&apos;, &apos;&lt;f8&apos;), (&apos;unemp&apos;, &apos;&lt;f8&apos;)])






date        item   
1959-03-31  realgdp    2710.349
            infl          0.000
            unemp         5.800
1959-06-30  realgdp    2778.801
            infl          2.340
            unemp         5.100
1959-09-30  realgdp    2775.488
            infl          2.740
            unemp         5.300
1959-12-31  realgdp    2785.204
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ldata[:<span class="number">10</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>date</th><br><th>item</th><br><th>value</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>1959-03-31</td><br><td>realgdp</td><br><td>2710.349</td><br></tr><br><tr><br><th>1</th><br><td>1959-03-31</td><br><td>infl</td><br><td>0.000</td><br></tr><br><tr><br><th>2</th><br><td>1959-03-31</td><br><td>unemp</td><br><td>5.800</td><br></tr><br><tr><br><th>3</th><br><td>1959-06-30</td><br><td>realgdp</td><br><td>2778.801</td><br></tr><br><tr><br><th>4</th><br><td>1959-06-30</td><br><td>infl</td><br><td>2.340</td><br></tr><br><tr><br><th>5</th><br><td>1959-06-30</td><br><td>unemp</td><br><td>5.100</td><br></tr><br><tr><br><th>6</th><br><td>1959-09-30</td><br><td>realgdp</td><br><td>2775.488</td><br></tr><br><tr><br><th>7</th><br><td>1959-09-30</td><br><td>infl</td><br><td>2.740</td><br></tr><br><tr><br><th>8</th><br><td>1959-09-30</td><br><td>unemp</td><br><td>5.300</td><br></tr><br><tr><br><th>9</th><br><td>1959-12-31</td><br><td>realgdp</td><br><td>2785.204</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pivoted = ldata.pivot(<span class="string">'date'</span>, <span class="string">'item'</span>, <span class="string">'value'</span>)</div><div class="line">pivoted.head()</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>item</th><br><th>infl</th><br><th>realgdp</th><br><th>unemp</th><br></tr><br><tr><br><th>date</th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1959-03-31</th><br><td>0.00</td><br><td>2710.349</td><br><td>5.8</td><br></tr><br><tr><br><th>1959-06-30</th><br><td>2.34</td><br><td>2778.801</td><br><td>5.1</td><br></tr><br><tr><br><th>1959-09-30</th><br><td>2.74</td><br><td>2775.488</td><br><td>5.3</td><br></tr><br><tr><br><th>1959-12-31</th><br><td>0.27</td><br><td>2785.204</td><br><td>5.6</td><br></tr><br><tr><br><th>1960-03-31</th><br><td>2.31</td><br><td>2847.699</td><br><td>5.2</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ldata[<span class="string">'value2'</span>] = np.random.randn(len(ldata))</div><div class="line">ldata[:<span class="number">10</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>date</th><br><th>item</th><br><th>value</th><br><th>value2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>1959-03-31</td><br><td>realgdp</td><br><td>2710.349</td><br><td>-0.204708</td><br></tr><br><tr><br><th>1</th><br><td>1959-03-31</td><br><td>infl</td><br><td>0.000</td><br><td>0.478943</td><br></tr><br><tr><br><th>2</th><br><td>1959-03-31</td><br><td>unemp</td><br><td>5.800</td><br><td>-0.519439</td><br></tr><br><tr><br><th>3</th><br><td>1959-06-30</td><br><td>realgdp</td><br><td>2778.801</td><br><td>-0.555730</td><br></tr><br><tr><br><th>4</th><br><td>1959-06-30</td><br><td>infl</td><br><td>2.340</td><br><td>1.965781</td><br></tr><br><tr><br><th>5</th><br><td>1959-06-30</td><br><td>unemp</td><br><td>5.100</td><br><td>1.393406</td><br></tr><br><tr><br><th>6</th><br><td>1959-09-30</td><br><td>realgdp</td><br><td>2775.488</td><br><td>0.092908</td><br></tr><br><tr><br><th>7</th><br><td>1959-09-30</td><br><td>infl</td><br><td>2.740</td><br><td>0.281746</td><br></tr><br><tr><br><th>8</th><br><td>1959-09-30</td><br><td>unemp</td><br><td>5.300</td><br><td>0.769023</td><br></tr><br><tr><br><th>9</th><br><td>1959-12-31</td><br><td>realgdp</td><br><td>2785.204</td><br><td>1.246435</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pivoted = ldata.pivot(<span class="string">'date'</span>, <span class="string">'item'</span>)</div><div class="line">pivoted[:<span class="number">5</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr><br><th></th><br><th colspan="3" halign="left">value</th><br><th colspan="3" halign="left">value2</th><br></tr><br><tr><br><th>item</th><br><th>infl</th><br><th>realgdp</th><br><th>unemp</th><br><th>infl</th><br><th>realgdp</th><br><th>unemp</th><br></tr><br><tr><br><th>date</th><br><th></th><br><th></th><br><th></th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1959-03-31</th><br><td>0.00</td><br><td>2710.349</td><br><td>5.8</td><br><td>0.478943</td><br><td>-0.204708</td><br><td>-0.519439</td><br></tr><br><tr><br><th>1959-06-30</th><br><td>2.34</td><br><td>2778.801</td><br><td>5.1</td><br><td>1.965781</td><br><td>-0.555730</td><br><td>1.393406</td><br></tr><br><tr><br><th>1959-09-30</th><br><td>2.74</td><br><td>2775.488</td><br><td>5.3</td><br><td>0.281746</td><br><td>0.092908</td><br><td>0.769023</td><br></tr><br><tr><br><th>1959-12-31</th><br><td>0.27</td><br><td>2785.204</td><br><td>5.6</td><br><td>1.007189</td><br><td>1.246435</td><br><td>-1.296221</td><br></tr><br><tr><br><th>1960-03-31</th><br><td>2.31</td><br><td>2847.699</td><br><td>5.2</td><br><td>0.228913</td><br><td>0.274992</td><br><td>1.352917</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pivoted[<span class="string">'value'</span>][:<span class="number">5</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th>item</th><br><th>infl</th><br><th>realgdp</th><br><th>unemp</th><br></tr><br><tr><br><th>date</th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1959-03-31</th><br><td>0.00</td><br><td>2710.349</td><br><td>5.8</td><br></tr><br><tr><br><th>1959-06-30</th><br><td>2.34</td><br><td>2778.801</td><br><td>5.1</td><br></tr><br><tr><br><th>1959-09-30</th><br><td>2.74</td><br><td>2775.488</td><br><td>5.3</td><br></tr><br><tr><br><th>1959-12-31</th><br><td>0.27</td><br><td>2785.204</td><br><td>5.6</td><br></tr><br><tr><br><th>1960-03-31</th><br><td>2.31</td><br><td>2847.699</td><br><td>5.2</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ldata.set_index([<span class="string">'date'</span>, <span class="string">'item'</span>])[:<span class="number">9</span>]</div><div class="line">unstacked = ldata.set_index([<span class="string">'date'</span>, <span class="string">'item'</span>]).unstack(<span class="string">'item'</span>)</div><div class="line">unstacked[:<span class="number">7</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th></th><br><th>value</th><br><th>value2</th><br></tr><br><tr><br><th>date</th><br><th>item</th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th rowspan="3" valign="top">1959-03-31</th><br><th>realgdp</th><br><td>2710.349</td><br><td>-0.204708</td><br></tr><br><tr><br><th>infl</th><br><td>0.000</td><br><td>0.478943</td><br></tr><br><tr><br><th>unemp</th><br><td>5.800</td><br><td>-0.519439</td><br></tr><br><tr><br><th rowspan="3" valign="top">1959-06-30</th><br><th>realgdp</th><br><td>2778.801</td><br><td>-0.555730</td><br></tr><br><tr><br><th>infl</th><br><td>2.340</td><br><td>1.965781</td><br></tr><br><tr><br><th>unemp</th><br><td>5.100</td><br><td>1.393406</td><br></tr><br><tr><br><th rowspan="3" valign="top">1959-09-30</th><br><th>realgdp</th><br><td>2775.488</td><br><td>0.092908</td><br></tr><br><tr><br><th>infl</th><br><td>2.740</td><br><td>0.281746</td><br></tr><br><tr><br><th>unemp</th><br><td>5.300</td><br><td>0.769023</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr><br><th></th><br><th colspan="3" halign="left">value</th><br><th colspan="3" halign="left">value2</th><br></tr><br><tr><br><th>item</th><br><th>infl</th><br><th>realgdp</th><br><th>unemp</th><br><th>infl</th><br><th>realgdp</th><br><th>unemp</th><br></tr><br><tr><br><th>date</th><br><th></th><br><th></th><br><th></th><br><th></th><br><th></th><br><th></th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1959-03-31</th><br><td>0.00</td><br><td>2710.349</td><br><td>5.8</td><br><td>0.478943</td><br><td>-0.204708</td><br><td>-0.519439</td><br></tr><br><tr><br><th>1959-06-30</th><br><td>2.34</td><br><td>2778.801</td><br><td>5.1</td><br><td>1.965781</td><br><td>-0.555730</td><br><td>1.393406</td><br></tr><br><tr><br><th>1959-09-30</th><br><td>2.74</td><br><td>2775.488</td><br><td>5.3</td><br><td>0.281746</td><br><td>0.092908</td><br><td>0.769023</td><br></tr><br><tr><br><th>1959-12-31</th><br><td>0.27</td><br><td>2785.204</td><br><td>5.6</td><br><td>1.007189</td><br><td>1.246435</td><br><td>-1.296221</td><br></tr><br><tr><br><th>1960-03-31</th><br><td>2.31</td><br><td>2847.699</td><br><td>5.2</td><br><td>0.228913</td><br><td>0.274992</td><br><td>1.352917</td><br></tr><br><tr><br><th>1960-06-30</th><br><td>0.14</td><br><td>2834.390</td><br><td>5.2</td><br><td>-2.001637</td><br><td>0.886429</td><br><td>-0.371843</td><br></tr><br><tr><br><th>1960-09-30</th><br><td>2.70</td><br><td>2839.022</td><br><td>5.6</td><br><td>-0.438570</td><br><td>1.669025</td><br><td>-0.539741</td><br></tr><br><br></tbody><br></table><br></div><h2 id="数据转换"><a href="#数据转换" class="headerlink" title="数据转换"></a>数据转换</h2><h3 id="移除重复值"><a href="#移除重复值" class="headerlink" title="移除重复值"></a>移除重复值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">data = DataFrame(&#123;<span class="string">'k1'</span>: [<span class="string">'one'</span>] * <span class="number">3</span> + [<span class="string">'two'</span>] * <span class="number">4</span>,</div><div class="line">                  <span class="string">'k2'</span>: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>]&#125;)</div><div class="line">data</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>k1</th><br><th>k2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>one</td><br><td>1</td><br></tr><br><tr><br><th>1</th><br><td>one</td><br><td>1</td><br></tr><br><tr><br><th>2</th><br><td>one</td><br><td>2</td><br></tr><br><tr><br><th>3</th><br><td>two</td><br><td>3</td><br></tr><br><tr><br><th>4</th><br><td>two</td><br><td>3</td><br></tr><br><tr><br><th>5</th><br><td>two</td><br><td>4</td><br></tr><br><tr><br><th>6</th><br><td>two</td><br><td>4</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.duplicated()</div></pre></td></tr></table></figure><pre><code>0    False
1     True
2    False
3    False
4     True
5    False
6     True
dtype: bool
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.drop_duplicates()</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>k1</th><br><th>k2</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>one</td><br><td>1</td><br></tr><br><tr><br><th>2</th><br><td>one</td><br><td>2</td><br></tr><br><tr><br><th>3</th><br><td>two</td><br><td>3</td><br></tr><br><tr><br><th>5</th><br><td>two</td><br><td>4</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">data[<span class="string">'v1'</span>] = range(<span class="number">7</span>)</div><div class="line">data</div><div class="line">data.drop_duplicates([<span class="string">'k1'</span>])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>k1</th><br><th>k2</th><br><th>v1</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>one</td><br><td>1</td><br><td>0</td><br></tr><br><tr><br><th>1</th><br><td>one</td><br><td>1</td><br><td>1</td><br></tr><br><tr><br><th>2</th><br><td>one</td><br><td>2</td><br><td>2</td><br></tr><br><tr><br><th>3</th><br><td>two</td><br><td>3</td><br><td>3</td><br></tr><br><tr><br><th>4</th><br><td>two</td><br><td>3</td><br><td>4</td><br></tr><br><tr><br><th>5</th><br><td>two</td><br><td>4</td><br><td>5</td><br></tr><br><tr><br><th>6</th><br><td>two</td><br><td>4</td><br><td>6</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>k1</th><br><th>k2</th><br><th>v1</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>one</td><br><td>1</td><br><td>0</td><br></tr><br><tr><br><th>3</th><br><td>two</td><br><td>3</td><br><td>3</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data.drop_duplicates([<span class="string">'k1'</span>, <span class="string">'k2'</span>], keep=<span class="string">'last'</span>)</div><div class="line">data.drop_duplicates([<span class="string">'k1'</span>, <span class="string">'k2'</span>], keep=<span class="string">'first'</span>)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>k1</th><br><th>k2</th><br><th>v1</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1</th><br><td>one</td><br><td>1</td><br><td>1</td><br></tr><br><tr><br><th>2</th><br><td>one</td><br><td>2</td><br><td>2</td><br></tr><br><tr><br><th>4</th><br><td>two</td><br><td>3</td><br><td>4</td><br></tr><br><tr><br><th>6</th><br><td>two</td><br><td>4</td><br><td>6</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>k1</th><br><th>k2</th><br><th>v1</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>one</td><br><td>1</td><br><td>0</td><br></tr><br><tr><br><th>2</th><br><td>one</td><br><td>2</td><br><td>2</td><br></tr><br><tr><br><th>3</th><br><td>two</td><br><td>3</td><br><td>3</td><br></tr><br><tr><br><th>5</th><br><td>two</td><br><td>4</td><br><td>5</td><br></tr><br><br></tbody><br></table><br></div><h3 id="利用函数或映射进行数据转换"><a href="#利用函数或映射进行数据转换" class="headerlink" title="利用函数或映射进行数据转换"></a>利用函数或映射进行数据转换</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">data = DataFrame(&#123;<span class="string">'food'</span>: [<span class="string">'bacon'</span>, <span class="string">'pulled pork'</span>, <span class="string">'bacon'</span>, <span class="string">'Pastrami'</span>,</div><div class="line">                           <span class="string">'corned beef'</span>, <span class="string">'Bacon'</span>, <span class="string">'pastrami'</span>, <span class="string">'honey ham'</span>,</div><div class="line">                           <span class="string">'nova lox'</span>],</div><div class="line">                  <span class="string">'ounces'</span>: [<span class="number">4</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">6</span>, <span class="number">7.5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>]&#125;)</div><div class="line">data</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>food</th><br><th>ounces</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>bacon</td><br><td>4.0</td><br></tr><br><tr><br><th>1</th><br><td>pulled pork</td><br><td>3.0</td><br></tr><br><tr><br><th>2</th><br><td>bacon</td><br><td>12.0</td><br></tr><br><tr><br><th>3</th><br><td>Pastrami</td><br><td>6.0</td><br></tr><br><tr><br><th>4</th><br><td>corned beef</td><br><td>7.5</td><br></tr><br><tr><br><th>5</th><br><td>Bacon</td><br><td>8.0</td><br></tr><br><tr><br><th>6</th><br><td>pastrami</td><br><td>3.0</td><br></tr><br><tr><br><th>7</th><br><td>honey ham</td><br><td>5.0</td><br></tr><br><tr><br><th>8</th><br><td>nova lox</td><br><td>6.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">meat_to_animal = &#123;</div><div class="line">  <span class="string">'bacon'</span>: <span class="string">'pig'</span>,</div><div class="line">  <span class="string">'pulled pork'</span>: <span class="string">'pig'</span>,</div><div class="line">  <span class="string">'pastrami'</span>: <span class="string">'cow'</span>,</div><div class="line">  <span class="string">'corned beef'</span>: <span class="string">'cow'</span>,</div><div class="line">  <span class="string">'honey ham'</span>: <span class="string">'pig'</span>,</div><div class="line">  <span class="string">'nova lox'</span>: <span class="string">'salmon'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data[<span class="string">'animal'</span>] = data[<span class="string">'food'</span>].map(str.lower).map(meat_to_animal)</div><div class="line">data</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>food</th><br><th>ounces</th><br><th>animal</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>bacon</td><br><td>4.0</td><br><td>pig</td><br></tr><br><tr><br><th>1</th><br><td>pulled pork</td><br><td>3.0</td><br><td>pig</td><br></tr><br><tr><br><th>2</th><br><td>bacon</td><br><td>12.0</td><br><td>pig</td><br></tr><br><tr><br><th>3</th><br><td>Pastrami</td><br><td>6.0</td><br><td>cow</td><br></tr><br><tr><br><th>4</th><br><td>corned beef</td><br><td>7.5</td><br><td>cow</td><br></tr><br><tr><br><th>5</th><br><td>Bacon</td><br><td>8.0</td><br><td>pig</td><br></tr><br><tr><br><th>6</th><br><td>pastrami</td><br><td>3.0</td><br><td>cow</td><br></tr><br><tr><br><th>7</th><br><td>honey ham</td><br><td>5.0</td><br><td>pig</td><br></tr><br><tr><br><th>8</th><br><td>nova lox</td><br><td>6.0</td><br><td>salmon</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data[<span class="string">'food'</span>].map(<span class="keyword">lambda</span> x: meat_to_animal[x.lower()])</div></pre></td></tr></table></figure><pre><code>0       pig
1       pig
2       pig
3       cow
4       cow
5       pig
6       cow
7       pig
8    salmon
Name: food, dtype: object
</code></pre><h3 id="替换值"><a href="#替换值" class="headerlink" title="替换值"></a>替换值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data = Series([<span class="number">1.</span>, <span class="number">-999.</span>, <span class="number">2.</span>, <span class="number">-999.</span>, <span class="number">-1000.</span>, <span class="number">3.</span>])</div><div class="line">data</div></pre></td></tr></table></figure><pre><code>0       1.0
1    -999.0
2       2.0
3    -999.0
4   -1000.0
5       3.0
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.replace(<span class="number">-999</span>, np.nan)</div></pre></td></tr></table></figure><pre><code>0       1.0
1       NaN
2       2.0
3       NaN
4   -1000.0
5       3.0
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.replace([<span class="number">-999</span>, <span class="number">-1000</span>], np.nan)</div></pre></td></tr></table></figure><pre><code>0    1.0
1    NaN
2    2.0
3    NaN
4    NaN
5    3.0
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.replace([<span class="number">-999</span>, <span class="number">-1000</span>], [np.nan, <span class="number">0</span>])</div></pre></td></tr></table></figure><pre><code>0    1.0
1    NaN
2    2.0
3    NaN
4    0.0
5    3.0
dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.replace(&#123;<span class="number">-999</span>: np.nan, <span class="number">-1000</span>: <span class="number">0</span>&#125;)</div></pre></td></tr></table></figure><pre><code>0    1.0
1    NaN
2    2.0
3    NaN
4    0.0
5    3.0
dtype: float64
</code></pre><h3 id="重命名轴索引"><a href="#重命名轴索引" class="headerlink" title="重命名轴索引"></a>重命名轴索引</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">data = DataFrame(np.arange(<span class="number">12</span>).reshape((<span class="number">3</span>, <span class="number">4</span>)),</div><div class="line">                 index=[<span class="string">'Ohio'</span>, <span class="string">'Colorado'</span>, <span class="string">'New York'</span>],</div><div class="line">                 columns=[<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>, <span class="string">'four'</span>])</div><div class="line">data</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>one</th><br><th>two</th><br><th>three</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>Ohio</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>Colorado</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>New York</th><br><td>8</td><br><td>9</td><br><td>10</td><br><td>11</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.index.map(str.upper)</div></pre></td></tr></table></figure><pre><code>array([&apos;OHIO&apos;, &apos;COLORADO&apos;, &apos;NEW YORK&apos;], dtype=object)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data.index = data.index.map(str.upper)</div><div class="line">data</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>one</th><br><th>two</th><br><th>three</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>OHIO</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>COLORADO</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>NEW YORK</th><br><td>8</td><br><td>9</td><br><td>10</td><br><td>11</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.rename(index=str.title, columns=str.upper)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>ONE</th><br><th>TWO</th><br><th>THREE</th><br><th>FOUR</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>Ohio</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>Colorado</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>New York</th><br><td>8</td><br><td>9</td><br><td>10</td><br><td>11</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data.rename(index=&#123;<span class="string">'OHIO'</span>: <span class="string">'INDIANA'</span>&#125;,</div><div class="line">            columns=&#123;<span class="string">'three'</span>: <span class="string">'peekaboo'</span>&#125;)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>one</th><br><th>two</th><br><th>peekaboo</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>INDIANA</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>COLORADO</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>NEW YORK</th><br><td>8</td><br><td>9</td><br><td>10</td><br><td>11</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Always returns a reference to a DataFrame</span></div><div class="line">_ = data.rename(index=&#123;<span class="string">'OHIO'</span>: <span class="string">'INDIANA'</span>&#125;, inplace=<span class="keyword">True</span>)</div><div class="line">data</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>one</th><br><th>two</th><br><th>three</th><br><th>four</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>INDIANA</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>COLORADO</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>NEW YORK</th><br><td>8</td><br><td>9</td><br><td>10</td><br><td>11</td><br></tr><br><br></tbody><br></table><br></div><h3 id="离散化和面元划分"><a href="#离散化和面元划分" class="headerlink" title="离散化和面元划分"></a>离散化和面元划分</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ages = [<span class="number">20</span>, <span class="number">22</span>, <span class="number">25</span>, <span class="number">27</span>, <span class="number">21</span>, <span class="number">23</span>, <span class="number">37</span>, <span class="number">31</span>, <span class="number">61</span>, <span class="number">45</span>, <span class="number">41</span>, <span class="number">32</span>]</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bins = [<span class="number">18</span>, <span class="number">25</span>, <span class="number">35</span>, <span class="number">60</span>, <span class="number">100</span>]</div><div class="line">cats = pd.cut(ages, bins)</div><div class="line">cats</div></pre></td></tr></table></figure><pre><code>[(18, 25], (18, 25], (18, 25], (25, 35], (18, 25], ..., (25, 35], (60, 100], (35, 60], (35, 60], (25, 35]]
Length: 12
Categories (4, object): [(18, 25] &lt; (25, 35] &lt; (35, 60] &lt; (60, 100]]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cats.codes</div></pre></td></tr></table></figure><pre><code>array([0, 0, 0, 1, 0, 0, 2, 1, 3, 2, 2, 1], dtype=int8)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cats.categories</div></pre></td></tr></table></figure><pre><code>Index([&apos;(18, 25]&apos;, &apos;(25, 35]&apos;, &apos;(35, 60]&apos;, &apos;(60, 100]&apos;], dtype=&apos;object&apos;)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.value_counts(cats)</div></pre></td></tr></table></figure><pre><code>(18, 25]     5
(35, 60]     3
(25, 35]     3
(60, 100]    1
dtype: int64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.cut(ages, [<span class="number">18</span>, <span class="number">26</span>, <span class="number">36</span>, <span class="number">61</span>, <span class="number">100</span>], right=<span class="keyword">False</span>)</div></pre></td></tr></table></figure><pre><code>[[18, 26), [18, 26), [18, 26), [26, 36), [18, 26), ..., [26, 36), [61, 100), [36, 61), [36, 61), [26, 36)]
Length: 12
Categories (4, object): [[18, 26) &lt; [26, 36) &lt; [36, 61) &lt; [61, 100)]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">group_names = [<span class="string">'Youth'</span>, <span class="string">'YoungAdult'</span>, <span class="string">'MiddleAged'</span>, <span class="string">'Senior'</span>]</div><div class="line">pd.cut(ages, bins, labels=group_names)</div></pre></td></tr></table></figure><pre><code>[Youth, Youth, Youth, YoungAdult, Youth, ..., YoungAdult, Senior, MiddleAged, MiddleAged, YoungAdult]
Length: 12
Categories (4, object): [Youth &lt; YoungAdult &lt; MiddleAged &lt; Senior]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data = np.random.rand(<span class="number">20</span>)</div><div class="line">pd.cut(data, <span class="number">4</span>, precision=<span class="number">2</span>)</div></pre></td></tr></table></figure><pre><code>[(0.25, 0.49], (0.25, 0.49], (0.73, 0.98], (0.25, 0.49], (0.25, 0.49], ..., (0.25, 0.49], (0.73, 0.98], (0.49, 0.73], (0.49, 0.73], (0.49, 0.73]]
Length: 20
Categories (4, object): [(0.0032, 0.25] &lt; (0.25, 0.49] &lt; (0.49, 0.73] &lt; (0.73, 0.98]]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">data = np.random.randn(<span class="number">1000</span>) <span class="comment"># Normally distributed</span></div><div class="line">cats = pd.qcut(data, <span class="number">4</span>) <span class="comment"># Cut into quartiles</span></div><div class="line">cats</div></pre></td></tr></table></figure><pre><code>[(0.636, 3.26], [-3.745, -0.648], (0.636, 3.26], (-0.022, 0.636], (-0.648, -0.022], ..., (0.636, 3.26], (-0.022, 0.636], [-3.745, -0.648], (-0.022, 0.636], (-0.022, 0.636]]
Length: 1000
Categories (4, object): [[-3.745, -0.648] &lt; (-0.648, -0.022] &lt; (-0.022, 0.636] &lt; (0.636, 3.26]]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.value_counts(cats)</div></pre></td></tr></table></figure><pre><code>(0.636, 3.26]       250
(-0.022, 0.636]     250
(-0.648, -0.022]    250
[-3.745, -0.648]    250
dtype: int64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.qcut(data, [<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0.5</span>, <span class="number">0.9</span>, <span class="number">1.</span>])</div></pre></td></tr></table></figure><pre><code>[(-0.022, 1.298], [-3.745, -1.274], (-0.022, 1.298], (-0.022, 1.298], (-1.274, -0.022], ..., (-0.022, 1.298], (-0.022, 1.298], [-3.745, -1.274], (-0.022, 1.298], (-0.022, 1.298]]
Length: 1000
Categories (4, object): [[-3.745, -1.274] &lt; (-1.274, -0.022] &lt; (-0.022, 1.298] &lt; (1.298, 3.26]]
</code></pre><h3 id="检测和过滤异常值"><a href="#检测和过滤异常值" class="headerlink" title="检测和过滤异常值"></a>检测和过滤异常值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">np.random.seed(<span class="number">12345</span>)</div><div class="line">data = DataFrame(np.random.randn(<span class="number">1000</span>, <span class="number">4</span>))</div><div class="line">data.describe()</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br><th>2</th><br><th>3</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>count</th><br><td>1000.000000</td><br><td>1000.000000</td><br><td>1000.000000</td><br><td>1000.000000</td><br></tr><br><tr><br><th>mean</th><br><td>-0.067684</td><br><td>0.067924</td><br><td>0.025598</td><br><td>-0.002298</td><br></tr><br><tr><br><th>std</th><br><td>0.998035</td><br><td>0.992106</td><br><td>1.006835</td><br><td>0.996794</td><br></tr><br><tr><br><th>min</th><br><td>-3.428254</td><br><td>-3.548824</td><br><td>-3.184377</td><br><td>-3.745356</td><br></tr><br><tr><br><th>25%</th><br><td>-0.774890</td><br><td>-0.591841</td><br><td>-0.641675</td><br><td>-0.644144</td><br></tr><br><tr><br><th>50%</th><br><td>-0.116401</td><br><td>0.101143</td><br><td>0.002073</td><br><td>-0.013611</td><br></tr><br><tr><br><th>75%</th><br><td>0.616366</td><br><td>0.780282</td><br><td>0.680391</td><br><td>0.654328</td><br></tr><br><tr><br><th>max</th><br><td>3.366626</td><br><td>2.653656</td><br><td>3.260383</td><br><td>3.927528</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">col = data[<span class="number">3</span>]</div><div class="line">col[np.abs(col) &gt; <span class="number">3</span>]</div></pre></td></tr></table></figure><pre><code>97     3.927528
305   -3.399312
400   -3.745356
Name: 3, dtype: float64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data[(np.abs(data) &gt; <span class="number">3</span>).any(<span class="number">1</span>)]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br><th>2</th><br><th>3</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>5</th><br><td>-0.539741</td><br><td>0.476985</td><br><td>3.248944</td><br><td>-1.021228</td><br></tr><br><tr><br><th>97</th><br><td>-0.774363</td><br><td>0.552936</td><br><td>0.106061</td><br><td>3.927528</td><br></tr><br><tr><br><th>102</th><br><td>-0.655054</td><br><td>-0.565230</td><br><td>3.176873</td><br><td>0.959533</td><br></tr><br><tr><br><th>305</th><br><td>-2.315555</td><br><td>0.457246</td><br><td>-0.025907</td><br><td>-3.399312</td><br></tr><br><tr><br><th>324</th><br><td>0.050188</td><br><td>1.951312</td><br><td>3.260383</td><br><td>0.963301</td><br></tr><br><tr><br><th>400</th><br><td>0.146326</td><br><td>0.508391</td><br><td>-0.196713</td><br><td>-3.745356</td><br></tr><br><tr><br><th>499</th><br><td>-0.293333</td><br><td>-0.242459</td><br><td>-3.056990</td><br><td>1.918403</td><br></tr><br><tr><br><th>523</th><br><td>-3.428254</td><br><td>-0.296336</td><br><td>-0.439938</td><br><td>-0.867165</td><br></tr><br><tr><br><th>586</th><br><td>0.275144</td><br><td>1.179227</td><br><td>-3.184377</td><br><td>1.369891</td><br></tr><br><tr><br><th>808</th><br><td>-0.362528</td><br><td>-3.548824</td><br><td>1.553205</td><br><td>-2.186301</td><br></tr><br><tr><br><th>900</th><br><td>3.366626</td><br><td>-2.372214</td><br><td>0.851010</td><br><td>1.332846</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">data[np.abs(data) &gt; <span class="number">3</span>] = np.sign(data) * <span class="number">3</span></div><div class="line">data.describe()</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br><th>2</th><br><th>3</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>count</th><br><td>1000.000000</td><br><td>1000.000000</td><br><td>1000.000000</td><br><td>1000.000000</td><br></tr><br><tr><br><th>mean</th><br><td>-0.067623</td><br><td>0.068473</td><br><td>0.025153</td><br><td>-0.002081</td><br></tr><br><tr><br><th>std</th><br><td>0.995485</td><br><td>0.990253</td><br><td>1.003977</td><br><td>0.989736</td><br></tr><br><tr><br><th>min</th><br><td>-3.000000</td><br><td>-3.000000</td><br><td>-3.000000</td><br><td>-3.000000</td><br></tr><br><tr><br><th>25%</th><br><td>-0.774890</td><br><td>-0.591841</td><br><td>-0.641675</td><br><td>-0.644144</td><br></tr><br><tr><br><th>50%</th><br><td>-0.116401</td><br><td>0.101143</td><br><td>0.002073</td><br><td>-0.013611</td><br></tr><br><tr><br><th>75%</th><br><td>0.616366</td><br><td>0.780282</td><br><td>0.680391</td><br><td>0.654328</td><br></tr><br><tr><br><th>max</th><br><td>3.000000</td><br><td>2.653656</td><br><td>3.000000</td><br><td>3.000000</td><br></tr><br><br></tbody><br></table><br></div><h3 id="排列和随机采样"><a href="#排列和随机采样" class="headerlink" title="排列和随机采样"></a>排列和随机采样</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">df = DataFrame(np.arange(<span class="number">5</span> * <span class="number">4</span>).reshape((<span class="number">5</span>, <span class="number">4</span>)))</div><div class="line">sampler = np.random.permutation(<span class="number">5</span>)</div><div class="line">sampler</div></pre></td></tr></table></figure><pre><code>array([1, 0, 2, 3, 4])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br><th>2</th><br><th>3</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>1</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>2</th><br><td>8</td><br><td>9</td><br><td>10</td><br><td>11</td><br></tr><br><tr><br><th>3</th><br><td>12</td><br><td>13</td><br><td>14</td><br><td>15</td><br></tr><br><tr><br><th>4</th><br><td>16</td><br><td>17</td><br><td>18</td><br><td>19</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.take(sampler)</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br><th>2</th><br><th>3</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>0</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>2</th><br><td>8</td><br><td>9</td><br><td>10</td><br><td>11</td><br></tr><br><tr><br><th>3</th><br><td>12</td><br><td>13</td><br><td>14</td><br><td>15</td><br></tr><br><tr><br><th>4</th><br><td>16</td><br><td>17</td><br><td>18</td><br><td>19</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">df.take(np.random.permutation(len(df))[:<span class="number">3</span>])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>0</th><br><th>1</th><br><th>2</th><br><th>3</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>1</th><br><td>4</td><br><td>5</td><br><td>6</td><br><td>7</td><br></tr><br><tr><br><th>0</th><br><td>0</td><br><td>1</td><br><td>2</td><br><td>3</td><br></tr><br><tr><br><th>4</th><br><td>16</td><br><td>17</td><br><td>18</td><br><td>19</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bag = np.array([<span class="number">5</span>, <span class="number">7</span>, <span class="number">-1</span>, <span class="number">6</span>, <span class="number">4</span>])</div><div class="line">sampler = np.random.randint(<span class="number">0</span>, len(bag), size=<span class="number">10</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sampler</div></pre></td></tr></table></figure><pre><code>array([3, 0, 4, 1, 1, 2, 3, 0, 1, 2])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">draws = bag.take(sampler)</div><div class="line">draws</div></pre></td></tr></table></figure><pre><code>array([ 6,  5,  4,  7,  7, -1,  6,  5,  7, -1])
</code></pre><h3 id="计算指标-哑变量"><a href="#计算指标-哑变量" class="headerlink" title="计算指标 / 哑变量"></a>计算指标 / 哑变量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">df = DataFrame(&#123;<span class="string">'key'</span>: [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>],</div><div class="line">                <span class="string">'data1'</span>: range(<span class="number">6</span>)&#125;)</div><div class="line">df</div><div class="line">pd.get_dummies(df[<span class="string">'key'</span>])</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>b</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>b</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>a</td><br></tr><br><tr><br><th>3</th><br><td>3</td><br><td>c</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>a</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>b</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>a</th><br><th>b</th><br><th>c</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>1</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>2</th><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>3</th><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>4</th><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>5</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dummies = pd.get_dummies(df[<span class="string">'key'</span>], prefix=<span class="string">'key'</span>)</div><div class="line">dummies</div><div class="line">df_with_dummy = df[[<span class="string">'data1'</span>]].join(dummies)</div><div class="line">df_with_dummy</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>key_a</th><br><th>key_b</th><br><th>key_c</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>1</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>2</th><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>3</th><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>4</th><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>5</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><br></tbody><br></table><br></div><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>data1</th><br><th>key_a</th><br><th>key_b</th><br><th>key_c</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>1</th><br><td>1</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>2</th><br><td>2</td><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>3</th><br><td>3</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>4</th><br><td>4</td><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>5</th><br><td>5</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mnames = [<span class="string">'movie_id'</span>, <span class="string">'title'</span>, <span class="string">'genres'</span>]</div><div class="line">movies = pd.read_table(<span class="string">'ch02/movielens/movies.dat'</span>, sep=<span class="string">'::'</span>, header=<span class="keyword">None</span>,</div><div class="line">                        names=mnames)</div><div class="line">movies[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>C:\Users\Ewan\Anaconda3\lib\site-packages\ipykernel\__main__.py:3: ParserWarning: Falling back to the &apos;python&apos; engine because the &apos;c&apos; engine does not support regex separators (separators &gt; 1 char and different from &apos;\s+&apos; are interpreted as regex); you can avoid this warning by specifying engine=&apos;python&apos;.
  app.launch_new_instance()
</code></pre><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>movie_id</th><br><th>title</th><br><th>genres</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>1</td><br><td>Toy Story (1995)</td><br><td>Animation|Children’s|Comedy</td><br></tr><br><tr><br><th>1</th><br><td>2</td><br><td>Jumanji (1995)</td><br><td>Adventure|Children’s|Fantasy</td><br></tr><br><tr><br><th>2</th><br><td>3</td><br><td>Grumpier Old Men (1995)</td><br><td>Comedy|Romance</td><br></tr><br><tr><br><th>3</th><br><td>4</td><br><td>Waiting to Exhale (1995)</td><br><td>Comedy|Drama</td><br></tr><br><tr><br><th>4</th><br><td>5</td><br><td>Father of the Bride Part II (1995)</td><br><td>Comedy</td><br></tr><br><tr><br><th>5</th><br><td>6</td><br><td>Heat (1995)</td><br><td>Action|Crime|Thriller</td><br></tr><br><tr><br><th>6</th><br><td>7</td><br><td>Sabrina (1995)</td><br><td>Comedy|Romance</td><br></tr><br><tr><br><th>7</th><br><td>8</td><br><td>Tom and Huck (1995)</td><br><td>Adventure|Children’s</td><br></tr><br><tr><br><th>8</th><br><td>9</td><br><td>Sudden Death (1995)</td><br><td>Action</td><br></tr><br><tr><br><th>9</th><br><td>10</td><br><td>GoldenEye (1995)</td><br><td>Action|Adventure|Thriller</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">genre_iter = (set(x.split(<span class="string">'|'</span>)) <span class="keyword">for</span> x <span class="keyword">in</span> movies.genres)</div><div class="line">genres = sorted(set.union(*genre_iter))</div><div class="line">genres</div></pre></td></tr></table></figure><pre><code>[&apos;Action&apos;,
 &apos;Adventure&apos;,
 &apos;Animation&apos;,
 &quot;Children&apos;s&quot;,
 &apos;Comedy&apos;,
 &apos;Crime&apos;,
 &apos;Documentary&apos;,
 &apos;Drama&apos;,
 &apos;Fantasy&apos;,
 &apos;Film-Noir&apos;,
 &apos;Horror&apos;,
 &apos;Musical&apos;,
 &apos;Mystery&apos;,
 &apos;Romance&apos;,
 &apos;Sci-Fi&apos;,
 &apos;Thriller&apos;,
 &apos;War&apos;,
 &apos;Western&apos;]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dummies = DataFrame(np.zeros((len(movies), len(genres))), columns=genres)</div><div class="line">dummies[:<span class="number">10</span>].ix[:, :<span class="number">5</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Action</th><br><th>Adventure</th><br><th>Animation</th><br><th>Children’s</th><br><th>Comedy</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>1</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>2</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>3</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>4</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>5</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>6</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>7</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>8</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>9</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i, gen <span class="keyword">in</span> enumerate(movies.genres):</div><div class="line">    dummies.ix[i, gen.split(<span class="string">'|'</span>)] = <span class="number">1</span></div><div class="line">dummies[:<span class="number">10</span>].ix[:, :<span class="number">5</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>Action</th><br><th>Adventure</th><br><th>Animation</th><br><th>Children’s</th><br><th>Comedy</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br><td>1.0</td><br><td>1.0</td><br></tr><br><tr><br><th>1</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>2</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>3</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>4</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>5</th><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>6</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>7</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>8</th><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>9</th><br><td>1.0</td><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">movies_windic = movies.join(dummies.add_prefix(<span class="string">'Genre_'</span>))</div><div class="line">movies_windic.ix[<span class="number">0</span>]</div></pre></td></tr></table></figure><pre><code>movie_id                                       1
title                           Toy Story (1995)
genres               Animation|Children&apos;s|Comedy
Genre_Action                                   0
Genre_Adventure                                0
Genre_Animation                                1
Genre_Children&apos;s                               1
Genre_Comedy                                   1
Genre_Crime                                    0
Genre_Documentary                              0
Genre_Drama                                    0
Genre_Fantasy                                  0
Genre_Film-Noir                                0
Genre_Horror                                   0
Genre_Musical                                  0
Genre_Mystery                                  0
Genre_Romance                                  0
Genre_Sci-Fi                                   0
Genre_Thriller                                 0
Genre_War                                      0
Genre_Western                                  0
Name: 0, dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">np.random.seed(<span class="number">12345</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">values = np.random.rand(<span class="number">10</span>)</div><div class="line">values</div></pre></td></tr></table></figure><pre><code>array([ 0.9296,  0.3164,  0.1839,  0.2046,  0.5677,  0.5955,  0.9645,
        0.6532,  0.7489,  0.6536])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bins = [<span class="number">0</span>, <span class="number">0.2</span>, <span class="number">0.4</span>, <span class="number">0.6</span>, <span class="number">0.8</span>, <span class="number">1</span>]</div><div class="line">pd.get_dummies(pd.cut(values, bins))</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>(0, 0.2]</th><br><th>(0.2, 0.4]</th><br><th>(0.4, 0.6]</th><br><th>(0.6, 0.8]</th><br><th>(0.8, 1]</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>1</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>2</th><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>3</th><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>4</th><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>5</th><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br><td>0.0</td><br></tr><br><tr><br><th>6</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br></tr><br><tr><br><th>7</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>8</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><tr><br><th>9</th><br><td>0.0</td><br><td>0.0</td><br><td>0.0</td><br><td>1.0</td><br><td>0.0</td><br></tr><br><br></tbody><br></table><br></div><h2 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h2><h3 id="字符串对象方法"><a href="#字符串对象方法" class="headerlink" title="字符串对象方法"></a>字符串对象方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">val = <span class="string">'a,b,  guido'</span></div><div class="line">val.split(<span class="string">','</span>)</div></pre></td></tr></table></figure><pre><code>[&apos;a&apos;, &apos;b&apos;, &apos;  guido&apos;]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pieces = [x.strip() <span class="keyword">for</span> x <span class="keyword">in</span> val.split(<span class="string">','</span>)]</div><div class="line">pieces</div></pre></td></tr></table></figure><pre><code>[&apos;a&apos;, &apos;b&apos;, &apos;guido&apos;]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">first, second, third = pieces</div><div class="line">first + <span class="string">'::'</span> + second + <span class="string">'::'</span> + third</div></pre></td></tr></table></figure><pre><code>&apos;a::b::guido&apos;
</code></pre><p>Surprise :P</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'::'</span>.join(pieces)</div></pre></td></tr></table></figure><pre><code>&apos;a::b::guido&apos;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'guido'</span> <span class="keyword">in</span> val</div></pre></td></tr></table></figure><pre><code>True
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">val.index(<span class="string">','</span>)</div></pre></td></tr></table></figure><pre><code>1
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">val.find(<span class="string">':'</span>)</div></pre></td></tr></table></figure><pre><code>-1
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">val.index(<span class="string">':'</span>)</div></pre></td></tr></table></figure><pre><code>---------------------------------------------------------------------------

ValueError                                Traceback (most recent call last)

&lt;ipython-input-110-280f8b2856ce&gt; in &lt;module&gt;()
----&gt; 1 val.index(&apos;:&apos;)


ValueError: substring not found
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">val.count(<span class="string">','</span>)</div></pre></td></tr></table></figure><pre><code>2
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">val.replace(<span class="string">','</span>, <span class="string">'::'</span>)</div></pre></td></tr></table></figure><pre><code>&apos;a::b::  guido&apos;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">val.replace(<span class="string">','</span>, <span class="string">''</span>)</div></pre></td></tr></table></figure><pre><code>&apos;ab  guido&apos;
</code></pre><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> re</div><div class="line">text = <span class="string">"foo    bar\t baz  \tqux"</span></div><div class="line">re.split(<span class="string">'\s+'</span>, text)</div></pre></td></tr></table></figure><pre><code>[&apos;foo&apos;, &apos;bar&apos;, &apos;baz&apos;, &apos;qux&apos;]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">regex = re.compile(<span class="string">'\s+'</span>)</div><div class="line">regex.split(text)</div></pre></td></tr></table></figure><pre><code>[&apos;foo&apos;, &apos;bar&apos;, &apos;baz&apos;, &apos;qux&apos;]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">regex.findall(text)</div></pre></td></tr></table></figure><pre><code>[&apos;    &apos;, &apos;\t &apos;, &apos;  \t&apos;]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">text = <span class="string">"""Dave dave@google.com</span></div><div class="line">Steve steve@gmail.com</div><div class="line">Rob rob@gmail.com</div><div class="line">Ryan ryan@yahoo.com</div><div class="line">"""</div><div class="line">pattern = <span class="string">r'[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]&#123;2,4&#125;'</span></div><div class="line"></div><div class="line"><span class="comment"># re.IGNORECASE makes the regex case-insensitive</span></div><div class="line">regex = re.compile(pattern, flags=re.IGNORECASE)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">regex.findall(text)</div></pre></td></tr></table></figure><pre><code>[&apos;dave@google.com&apos;, &apos;steve@gmail.com&apos;, &apos;rob@gmail.com&apos;, &apos;ryan@yahoo.com&apos;]
</code></pre><p>Search只返回第一项</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">m = regex.search(text)</div><div class="line">m</div></pre></td></tr></table></figure><pre><code>&lt;_sre.SRE_Match object; span=(5, 20), match=&apos;dave@google.com&apos;&gt;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">text[m.start():m.end()]</div></pre></td></tr></table></figure><pre><code>&apos;dave@google.com&apos;
</code></pre><p>只匹配出现在字符串开头的模式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">print(regex.match(text))</div></pre></td></tr></table></figure><pre><code>None
</code></pre><p>​</p><p>替换</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">print(regex.sub(<span class="string">'REDACTED'</span>, text))</div></pre></td></tr></table></figure><pre><code>Dave REDACTED
Steve REDACTED
Rob REDACTED
Ryan REDACTED
</code></pre><p>​</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pattern = <span class="string">r'([A-Z0-9._%+-]+)@([A-Z0-9.-]+)\.([A-Z]&#123;2,4&#125;)'</span></div><div class="line">regex = re.compile(pattern, flags=re.IGNORECASE)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">m = regex.match(<span class="string">'wesm@bright.net'</span>)</div><div class="line">m.groups()</div></pre></td></tr></table></figure><pre><code>(&apos;wesm&apos;, &apos;bright&apos;, &apos;net&apos;)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">regex.findall(text)</div></pre></td></tr></table></figure><pre><code>[(&apos;dave&apos;, &apos;google&apos;, &apos;com&apos;),
 (&apos;steve&apos;, &apos;gmail&apos;, &apos;com&apos;),
 (&apos;rob&apos;, &apos;gmail&apos;, &apos;com&apos;),
 (&apos;ryan&apos;, &apos;yahoo&apos;, &apos;com&apos;)]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">print(regex.sub(<span class="string">r'Username: \1, Domain: \2, Suffix: \3'</span>, text))</div></pre></td></tr></table></figure><pre><code>Dave Username: dave, Domain: google, Suffix: com
Steve Username: steve, Domain: gmail, Suffix: com
Rob Username: rob, Domain: gmail, Suffix: com
Ryan Username: ryan, Domain: yahoo, Suffix: com
</code></pre><p>​</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">regex = re.compile(<span class="string">r"""</span></div><div class="line">    (?P&lt;username&gt;[A-Z0-9._%+-]+)</div><div class="line">    @</div><div class="line">    (?P&lt;domain&gt;[A-Z0-9.-]+)</div><div class="line">    \.</div><div class="line">    (?P&lt;suffix&gt;[A-Z]&#123;2,4&#125;)""", flags=re.IGNORECASE|re.VERBOSE)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">m = regex.match(<span class="string">'wesm@bright.net'</span>)</div><div class="line">m.groupdict()</div></pre></td></tr></table></figure><pre><code>{&apos;domain&apos;: &apos;bright&apos;, &apos;suffix&apos;: &apos;net&apos;, &apos;username&apos;: &apos;wesm&apos;}
</code></pre><h3 id="pandas中矢量化的字符串函数"><a href="#pandas中矢量化的字符串函数" class="headerlink" title="pandas中矢量化的字符串函数"></a>pandas中矢量化的字符串函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">data = &#123;<span class="string">'Dave'</span>: <span class="string">'dave@google.com'</span>, <span class="string">'Steve'</span>: <span class="string">'steve@gmail.com'</span>,</div><div class="line">        <span class="string">'Rob'</span>: <span class="string">'rob@gmail.com'</span>, <span class="string">'Wes'</span>: np.nan&#125;</div><div class="line">data = Series(data)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data</div></pre></td></tr></table></figure><pre><code>Dave     dave@google.com
Rob        rob@gmail.com
Steve    steve@gmail.com
Wes                  NaN
dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.isnull()</div></pre></td></tr></table></figure><pre><code>Dave     False
Rob      False
Steve    False
Wes       True
dtype: bool
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.str.contains(<span class="string">'gmail'</span>)</div></pre></td></tr></table></figure><pre><code>Dave     False
Rob       True
Steve     True
Wes        NaN
dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pattern</div></pre></td></tr></table></figure><pre><code>&apos;([A-Z0-9._%+-]+)@([A-Z0-9.-]+)\\.([A-Z]{2,4})&apos;
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.str.findall(pattern, flags=re.IGNORECASE)</div></pre></td></tr></table></figure><pre><code>Dave     [(dave, google, com)]
Rob        [(rob, gmail, com)]
Steve    [(steve, gmail, com)]
Wes                        NaN
dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">matches = data.str.match(pattern, flags=re.IGNORECASE)</div><div class="line">matches</div></pre></td></tr></table></figure><pre><code>C:\Users\Ewan\Anaconda3\lib\site-packages\ipykernel\__main__.py:1: FutureWarning: In future versions of pandas, match will change to always return a bool indexer.
  if __name__ == &apos;__main__&apos;:





Dave     (dave, google, com)
Rob        (rob, gmail, com)
Steve    (steve, gmail, com)
Wes                      NaN
dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">matches.str.get(<span class="number">1</span>)</div></pre></td></tr></table></figure><pre><code>Dave     google
Rob       gmail
Steve     gmail
Wes         NaN
dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">matches.str[<span class="number">0</span>]</div></pre></td></tr></table></figure><pre><code>Dave      dave
Rob        rob
Steve    steve
Wes        NaN
dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data.str[:<span class="number">5</span>]</div></pre></td></tr></table></figure><pre><code>Dave     dave@
Rob      rob@g
Steve    steve
Wes        NaN
dtype: object
</code></pre><h2 id="Example-USDA-Food-Database"><a href="#Example-USDA-Food-Database" class="headerlink" title="Example: USDA Food Database"></a>Example: USDA Food Database</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "id": 21441,</div><div class="line">  "description": "KENTUCKY FRIED CHICKEN, Fried Chicken, EXTRA CRISPY,</div><div class="line">Wing, meat and skin with breading",</div><div class="line">  "tags": ["KFC"],</div><div class="line">  "manufacturer": "Kentucky Fried Chicken",</div><div class="line">  "group": "Fast Foods",</div><div class="line">  "portions": [</div><div class="line">    &#123;</div><div class="line">      "amount": 1,</div><div class="line">      "unit": "wing, with skin",</div><div class="line">      "grams": 68.0</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    ...</div><div class="line">  ],</div><div class="line">  "nutrients": [</div><div class="line">    &#123;</div><div class="line">      "value": 20.8,</div><div class="line">      "units": "g",</div><div class="line">      "description": "Protein",</div><div class="line">      "group": "Composition"</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    ...</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line">db = json.load(open(<span class="string">'ch07/foods-2011-10-03.json'</span>))</div><div class="line">len(db)</div></pre></td></tr></table></figure><pre><code>6636
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db[<span class="number">0</span>].keys()</div></pre></td></tr></table></figure><pre><code>dict_keys([&apos;id&apos;, &apos;tags&apos;, &apos;portions&apos;, &apos;nutrients&apos;, &apos;description&apos;, &apos;group&apos;, &apos;manufacturer&apos;])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db[<span class="number">0</span>][<span class="string">'nutrients'</span>][<span class="number">0</span>]</div></pre></td></tr></table></figure><pre><code>{&apos;description&apos;: &apos;Protein&apos;,
 &apos;group&apos;: &apos;Composition&apos;,
 &apos;units&apos;: &apos;g&apos;,
 &apos;value&apos;: 25.18}
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nutrients = DataFrame(db[<span class="number">0</span>][<span class="string">'nutrients'</span>])</div><div class="line">nutrients[:<span class="number">7</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>description</th><br><th>group</th><br><th>units</th><br><th>value</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>Protein</td><br><td>Composition</td><br><td>g</td><br><td>25.18</td><br></tr><br><tr><br><th>1</th><br><td>Total lipid (fat)</td><br><td>Composition</td><br><td>g</td><br><td>29.20</td><br></tr><br><tr><br><th>2</th><br><td>Carbohydrate, by difference</td><br><td>Composition</td><br><td>g</td><br><td>3.06</td><br></tr><br><tr><br><th>3</th><br><td>Ash</td><br><td>Other</td><br><td>g</td><br><td>3.28</td><br></tr><br><tr><br><th>4</th><br><td>Energy</td><br><td>Energy</td><br><td>kcal</td><br><td>376.00</td><br></tr><br><tr><br><th>5</th><br><td>Water</td><br><td>Composition</td><br><td>g</td><br><td>39.28</td><br></tr><br><tr><br><th>6</th><br><td>Energy</td><br><td>Energy</td><br><td>kJ</td><br><td>1573.00</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">info_keys = [<span class="string">'description'</span>, <span class="string">'group'</span>, <span class="string">'id'</span>, <span class="string">'manufacturer'</span>]</div><div class="line">info = DataFrame(db, columns=info_keys)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">info[:<span class="number">5</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>description</th><br><th>group</th><br><th>id</th><br><th>manufacturer</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td>1008</td><br><td></td><br></tr><br><tr><br><th>1</th><br><td>Cheese, cheddar</td><br><td>Dairy and Egg Products</td><br><td>1009</td><br><td></td><br></tr><br><tr><br><th>2</th><br><td>Cheese, edam</td><br><td>Dairy and Egg Products</td><br><td>1018</td><br><td></td><br></tr><br><tr><br><th>3</th><br><td>Cheese, feta</td><br><td>Dairy and Egg Products</td><br><td>1019</td><br><td></td><br></tr><br><tr><br><th>4</th><br><td>Cheese, mozzarella, part skim milk</td><br><td>Dairy and Egg Products</td><br><td>1028</td><br><td></td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pd.value_counts(info.group)[:<span class="number">10</span>]</div></pre></td></tr></table></figure><pre><code>Vegetables and Vegetable Products    812
Beef Products                        618
Baked Products                       496
Breakfast Cereals                    403
Legumes and Legume Products          365
Fast Foods                           365
Lamb, Veal, and Game Products        345
Sweets                               341
Pork Products                        328
Fruits and Fruit Juices              328
Name: group, dtype: int64
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">nutrients = []</div><div class="line"></div><div class="line"><span class="keyword">for</span> rec <span class="keyword">in</span> db:</div><div class="line">    fnuts = DataFrame(rec[<span class="string">'nutrients'</span>])</div><div class="line">    fnuts[<span class="string">'id'</span>] = rec[<span class="string">'id'</span>]</div><div class="line">    nutrients.append(fnuts)</div><div class="line"></div><div class="line">nutrients = pd.concat(nutrients, ignore_index=<span class="keyword">True</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nutrients[:<span class="number">10</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>description</th><br><th>group</th><br><th>units</th><br><th>value</th><br><th>id</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>Protein</td><br><td>Composition</td><br><td>g</td><br><td>25.18</td><br><td>1008</td><br></tr><br><tr><br><th>1</th><br><td>Total lipid (fat)</td><br><td>Composition</td><br><td>g</td><br><td>29.20</td><br><td>1008</td><br></tr><br><tr><br><th>2</th><br><td>Carbohydrate, by difference</td><br><td>Composition</td><br><td>g</td><br><td>3.06</td><br><td>1008</td><br></tr><br><tr><br><th>3</th><br><td>Ash</td><br><td>Other</td><br><td>g</td><br><td>3.28</td><br><td>1008</td><br></tr><br><tr><br><th>4</th><br><td>Energy</td><br><td>Energy</td><br><td>kcal</td><br><td>376.00</td><br><td>1008</td><br></tr><br><tr><br><th>5</th><br><td>Water</td><br><td>Composition</td><br><td>g</td><br><td>39.28</td><br><td>1008</td><br></tr><br><tr><br><th>6</th><br><td>Energy</td><br><td>Energy</td><br><td>kJ</td><br><td>1573.00</td><br><td>1008</td><br></tr><br><tr><br><th>7</th><br><td>Fiber, total dietary</td><br><td>Composition</td><br><td>g</td><br><td>0.00</td><br><td>1008</td><br></tr><br><tr><br><th>8</th><br><td>Calcium, Ca</td><br><td>Elements</td><br><td>mg</td><br><td>673.00</td><br><td>1008</td><br></tr><br><tr><br><th>9</th><br><td>Iron, Fe</td><br><td>Elements</td><br><td>mg</td><br><td>0.64</td><br><td>1008</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nutrients.duplicated().sum()</div></pre></td></tr></table></figure><pre><code>14179
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nutrients = nutrients.drop_duplicates()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">col_mapping = &#123;<span class="string">'description'</span> : <span class="string">'food'</span>,</div><div class="line">               <span class="string">'group'</span>       : <span class="string">'fgroup'</span>&#125;</div><div class="line">info = info.rename(columns=col_mapping, copy=<span class="keyword">False</span>)</div><div class="line">info[:<span class="number">10</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>food</th><br><th>fgroup</th><br><th>id</th><br><th>manufacturer</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td>1008</td><br><td></td><br></tr><br><tr><br><th>1</th><br><td>Cheese, cheddar</td><br><td>Dairy and Egg Products</td><br><td>1009</td><br><td></td><br></tr><br><tr><br><th>2</th><br><td>Cheese, edam</td><br><td>Dairy and Egg Products</td><br><td>1018</td><br><td></td><br></tr><br><tr><br><th>3</th><br><td>Cheese, feta</td><br><td>Dairy and Egg Products</td><br><td>1019</td><br><td></td><br></tr><br><tr><br><th>4</th><br><td>Cheese, mozzarella, part skim milk</td><br><td>Dairy and Egg Products</td><br><td>1028</td><br><td></td><br></tr><br><tr><br><th>5</th><br><td>Cheese, mozzarella, part skim milk, low moisture</td><br><td>Dairy and Egg Products</td><br><td>1029</td><br><td></td><br></tr><br><tr><br><th>6</th><br><td>Cheese, romano</td><br><td>Dairy and Egg Products</td><br><td>1038</td><br><td></td><br></tr><br><tr><br><th>7</th><br><td>Cheese, roquefort</td><br><td>Dairy and Egg Products</td><br><td>1039</td><br><td></td><br></tr><br><tr><br><th>8</th><br><td>Cheese spread, pasteurized process, american, …</td><br><td>Dairy and Egg Products</td><br><td>1048</td><br><td></td><br></tr><br><tr><br><th>9</th><br><td>Cream, fluid, half and half</td><br><td>Dairy and Egg Products</td><br><td>1049</td><br><td></td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">col_mapping = &#123;<span class="string">'description'</span> : <span class="string">'nutrient'</span>,</div><div class="line">               <span class="string">'group'</span> : <span class="string">'nutgroup'</span>&#125;</div><div class="line">nutrients = nutrients.rename(columns=col_mapping, copy=<span class="keyword">False</span>)</div><div class="line">nutrients[:<span class="number">10</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>nutrient</th><br><th>nutgroup</th><br><th>units</th><br><th>value</th><br><th>id</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>Protein</td><br><td>Composition</td><br><td>g</td><br><td>25.18</td><br><td>1008</td><br></tr><br><tr><br><th>1</th><br><td>Total lipid (fat)</td><br><td>Composition</td><br><td>g</td><br><td>29.20</td><br><td>1008</td><br></tr><br><tr><br><th>2</th><br><td>Carbohydrate, by difference</td><br><td>Composition</td><br><td>g</td><br><td>3.06</td><br><td>1008</td><br></tr><br><tr><br><th>3</th><br><td>Ash</td><br><td>Other</td><br><td>g</td><br><td>3.28</td><br><td>1008</td><br></tr><br><tr><br><th>4</th><br><td>Energy</td><br><td>Energy</td><br><td>kcal</td><br><td>376.00</td><br><td>1008</td><br></tr><br><tr><br><th>5</th><br><td>Water</td><br><td>Composition</td><br><td>g</td><br><td>39.28</td><br><td>1008</td><br></tr><br><tr><br><th>6</th><br><td>Energy</td><br><td>Energy</td><br><td>kJ</td><br><td>1573.00</td><br><td>1008</td><br></tr><br><tr><br><th>7</th><br><td>Fiber, total dietary</td><br><td>Composition</td><br><td>g</td><br><td>0.00</td><br><td>1008</td><br></tr><br><tr><br><th>8</th><br><td>Calcium, Ca</td><br><td>Elements</td><br><td>mg</td><br><td>673.00</td><br><td>1008</td><br></tr><br><tr><br><th>9</th><br><td>Iron, Fe</td><br><td>Elements</td><br><td>mg</td><br><td>0.64</td><br><td>1008</td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ndata = pd.merge(nutrients, info, on=<span class="string">'id'</span>, how=<span class="string">'outer'</span>)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ndata[:<span class="number">10</span>]</div></pre></td></tr></table></figure><div><br><table border="1" class="dataframe"><br><thead><br><br><tr style="text-align:right"><br><th></th><br><th>nutrient</th><br><th>nutgroup</th><br><th>units</th><br><th>value</th><br><th>id</th><br><th>food</th><br><th>fgroup</th><br><th>manufacturer</th><br></tr><br><br></thead><br><tbody><br><br><tr><br><th>0</th><br><td>Protein</td><br><td>Composition</td><br><td>g</td><br><td>25.18</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>1</th><br><td>Total lipid (fat)</td><br><td>Composition</td><br><td>g</td><br><td>29.20</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>2</th><br><td>Carbohydrate, by difference</td><br><td>Composition</td><br><td>g</td><br><td>3.06</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>3</th><br><td>Ash</td><br><td>Other</td><br><td>g</td><br><td>3.28</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>4</th><br><td>Energy</td><br><td>Energy</td><br><td>kcal</td><br><td>376.00</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>5</th><br><td>Water</td><br><td>Composition</td><br><td>g</td><br><td>39.28</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>6</th><br><td>Energy</td><br><td>Energy</td><br><td>kJ</td><br><td>1573.00</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>7</th><br><td>Fiber, total dietary</td><br><td>Composition</td><br><td>g</td><br><td>0.00</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>8</th><br><td>Calcium, Ca</td><br><td>Elements</td><br><td>mg</td><br><td>673.00</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><tr><br><th>9</th><br><td>Iron, Fe</td><br><td>Elements</td><br><td>mg</td><br><td>0.64</td><br><td>1008</td><br><td>Cheese, caraway</td><br><td>Dairy and Egg Products</td><br><td></td><br></tr><br><br></tbody><br></table><br></div><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ndata.ix[<span class="number">30000</span>]</div></pre></td></tr></table></figure><pre><code>nutrient                                       Glycine
nutgroup                                   Amino Acids
units                                                g
value                                             0.04
id                                                6158
food            Soup, tomato bisque, canned, condensed
fgroup                      Soups, Sauces, and Gravies
manufacturer                                          
Name: 30000, dtype: object
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">result = ndata.groupby([<span class="string">'nutrient'</span>, <span class="string">'fgroup'</span>])[<span class="string">'value'</span>].quantile(<span class="number">0.5</span>)</div><div class="line">result[:<span class="number">10</span>]</div><div class="line">result[<span class="string">'Zinc, Zn'</span>].sort_values().plot(kind=<span class="string">'barh'</span>)</div></pre></td></tr></table></figure><pre><code>nutrient          fgroup                           
Adjusted Protein  Sweets                               12.900
                  Vegetables and Vegetable Products     2.180
Alanine           Baby Foods                            0.085
                  Baked Products                        0.248
                  Beef Products                         1.550
                  Beverages                             0.003
                  Breakfast Cereals                     0.311
                  Cereal Grains and Pasta               0.373
                  Dairy and Egg Products                0.271
                  Ethnic Foods                          1.290
Name: value, dtype: float64






&lt;matplotlib.axes._subplots.AxesSubplot at 0x1ba08c9e780&gt;
</code></pre><p><img src="http://o7ie0tcjk.bkt.clouddn.com/pydata-analysis/ch07/result.png" alt="result"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">by_nutrient = ndata.groupby([<span class="string">'nutgroup'</span>, <span class="string">'nutrient'</span>])</div><div class="line"></div><div class="line">get_maximum = <span class="keyword">lambda</span> x: x.xs(x.value.idxmax())</div><div class="line">get_minimum = <span class="keyword">lambda</span> x: x.xs(x.value.idxmin())</div><div class="line"></div><div class="line">max_foods = by_nutrient.apply(get_maximum)[[<span class="string">'value'</span>, <span class="string">'food'</span>]]</div><div class="line"></div><div class="line"><span class="comment"># make the food a little smaller</span></div><div class="line">max_foods.food = max_foods.food.str[:<span class="number">50</span>]</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">max_foods.ix[<span class="string">'Amino Acids'</span>][<span class="string">'food'</span>]</div></pre></td></tr></table></figure><pre><code>nutrient
Alanine                           Gelatins, dry powder, unsweetened
Arginine                               Seeds, sesame flour, low-fat
Aspartic acid                                   Soy protein isolate
Cystine                Seeds, cottonseed flour, low fat (glandless)
Glutamic acid                                   Soy protein isolate
Glycine                           Gelatins, dry powder, unsweetened
Histidine                Whale, beluga, meat, dried (Alaska Native)
Hydroxyproline    KENTUCKY FRIED CHICKEN, Fried Chicken, ORIGINA...
Isoleucine        Soy protein isolate, PROTEIN TECHNOLOGIES INTE...
Leucine           Soy protein isolate, PROTEIN TECHNOLOGIES INTE...
Lysine            Seal, bearded (Oogruk), meat, dried (Alaska Na...
Methionine                    Fish, cod, Atlantic, dried and salted
Phenylalanine     Soy protein isolate, PROTEIN TECHNOLOGIES INTE...
Proline                           Gelatins, dry powder, unsweetened
Serine            Soy protein isolate, PROTEIN TECHNOLOGIES INTE...
Threonine         Soy protein isolate, PROTEIN TECHNOLOGIES INTE...
Tryptophan         Sea lion, Steller, meat with fat (Alaska Native)
Tyrosine          Soy protein isolate, PROTEIN TECHNOLOGIES INTE...
Valine            Soy protein isolate, PROTEIN TECHNOLOGIES INTE...
Name: food, dtype: object
</code></pre></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/05/cs231n-Assignment-1-softmax/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Ewan Li"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Abracadabra"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Abracadabra" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2017/03/05/cs231n-Assignment-1-softmax/" itemprop="url">cs231n Assignment#1 softmax</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-05T11:07:45+08:00">2017-03-05 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2017/03/05/cs231n-Assignment-1-softmax/#comments" itemprop="discussionUrl"><span class="post-comments-count hc-comment-count" data-xid="2017/03/05/cs231n-Assignment-1-softmax/" itemprop="commentsCount"></span> </a></span><span id="/2017/03/05/cs231n-Assignment-1-softmax/" class="leancloud_visitors" data-flag-title="cs231n Assignment#1 softmax"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="Softmax-exercise"><a href="#Softmax-exercise" class="headerlink" title="Softmax exercise"></a>Softmax exercise</h1><p><em>Complete and hand in this completed worksheet (including its outputs and any supporting code outside of the worksheet) with your assignment submission. For more details see the <a href="http://vision.stanford.edu/teaching/cs231n/assignments.html" target="_blank" rel="external">assignments page</a> on the course website.</em></p><p>This exercise is analogous to the SVM exercise. You will:</p><ul><li>implement a fully-vectorized <strong>loss function</strong> for the Softmax classifier</li><li>implement the fully-vectorized expression for its <strong>analytic gradient</strong></li><li><strong>check your implementation</strong> with numerical gradient</li><li>use a validation set to <strong>tune the learning rate and regularization</strong> strength</li><li><strong>optimize</strong> the loss function with <strong>SGD</strong></li><li><strong>visualize</strong> the final learned weights</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> cs231n.data_utils <span class="keyword">import</span> load_CIFAR10</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line">%matplotlib inline</div><div class="line">plt.rcParams[<span class="string">'figure.figsize'</span>] = (<span class="number">10.0</span>, <span class="number">8.0</span>) <span class="comment"># set default size of plots</span></div><div class="line">plt.rcParams[<span class="string">'image.interpolation'</span>] = <span class="string">'nearest'</span></div><div class="line">plt.rcParams[<span class="string">'image.cmap'</span>] = <span class="string">'gray'</span></div><div class="line"></div><div class="line"><span class="comment"># for auto-reloading extenrnal modules</span></div><div class="line"><span class="comment"># see http://stackoverflow.com/questions/1907993/autoreload-of-modules-in-ipython</span></div><div class="line">%load_ext autoreload</div><div class="line">%autoreload <span class="number">2</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CIFAR10_data</span><span class="params">(num_training=<span class="number">49000</span>, num_validation=<span class="number">1000</span>, num_test=<span class="number">1000</span>, num_dev=<span class="number">500</span>)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  Load the CIFAR-10 dataset from disk and perform preprocessing to prepare</div><div class="line">  it for the linear classifier. These are the same steps as we used for the</div><div class="line">  SVM, but condensed to a single function.  </div><div class="line">  """</div><div class="line">  <span class="comment"># Load the raw CIFAR-10 data</span></div><div class="line">  cifar10_dir = <span class="string">'cs231n/datasets/cifar-10-batches-py'</span></div><div class="line">  X_train, y_train, X_test, y_test = load_CIFAR10(cifar10_dir)</div><div class="line">  </div><div class="line">  <span class="comment"># subsample the data</span></div><div class="line">  mask = range(num_training, num_training + num_validation)</div><div class="line">  X_val = X_train[mask]</div><div class="line">  y_val = y_train[mask]</div><div class="line">  mask = range(num_training)</div><div class="line">  X_train = X_train[mask]</div><div class="line">  y_train = y_train[mask]</div><div class="line">  mask = range(num_test)</div><div class="line">  X_test = X_test[mask]</div><div class="line">  y_test = y_test[mask]</div><div class="line">  mask = np.random.choice(num_training, num_dev, replace=<span class="keyword">False</span>)</div><div class="line">  X_dev = X_train[mask]</div><div class="line">  y_dev = y_train[mask]</div><div class="line">  </div><div class="line">  <span class="comment"># Preprocessing: reshape the image data into rows</span></div><div class="line">  X_train = np.reshape(X_train, (X_train.shape[<span class="number">0</span>], <span class="number">-1</span>))</div><div class="line">  X_val = np.reshape(X_val, (X_val.shape[<span class="number">0</span>], <span class="number">-1</span>))</div><div class="line">  X_test = np.reshape(X_test, (X_test.shape[<span class="number">0</span>], <span class="number">-1</span>))</div><div class="line">  X_dev = np.reshape(X_dev, (X_dev.shape[<span class="number">0</span>], <span class="number">-1</span>))</div><div class="line">  </div><div class="line">  <span class="comment"># Normalize the data: subtract the mean image</span></div><div class="line">  mean_image = np.mean(X_train, axis = <span class="number">0</span>)</div><div class="line">  X_train -= mean_image</div><div class="line">  X_val -= mean_image</div><div class="line">  X_test -= mean_image</div><div class="line">  X_dev -= mean_image</div><div class="line">  </div><div class="line">  <span class="comment"># add bias dimension and transform into columns</span></div><div class="line">  X_train = np.hstack([X_train, np.ones((X_train.shape[<span class="number">0</span>], <span class="number">1</span>))])</div><div class="line">  X_val = np.hstack([X_val, np.ones((X_val.shape[<span class="number">0</span>], <span class="number">1</span>))])</div><div class="line">  X_test = np.hstack([X_test, np.ones((X_test.shape[<span class="number">0</span>], <span class="number">1</span>))])</div><div class="line">  X_dev = np.hstack([X_dev, np.ones((X_dev.shape[<span class="number">0</span>], <span class="number">1</span>))])</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> X_train, y_train, X_val, y_val, X_test, y_test, X_dev, y_dev</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Invoke the above function to get our data.</span></div><div class="line">X_train, y_train, X_val, y_val, X_test, y_test, X_dev, y_dev = get_CIFAR10_data()</div><div class="line"><span class="keyword">print</span> <span class="string">'Train data shape: '</span>, X_train.shape</div><div class="line"><span class="keyword">print</span> <span class="string">'Train labels shape: '</span>, y_train.shape</div><div class="line"><span class="keyword">print</span> <span class="string">'Validation data shape: '</span>, X_val.shape</div><div class="line"><span class="keyword">print</span> <span class="string">'Validation labels shape: '</span>, y_val.shape</div><div class="line"><span class="keyword">print</span> <span class="string">'Test data shape: '</span>, X_test.shape</div><div class="line"><span class="keyword">print</span> <span class="string">'Test labels shape: '</span>, y_test.shape</div><div class="line"><span class="keyword">print</span> <span class="string">'dev data shape: '</span>, X_dev.shape</div><div class="line"><span class="keyword">print</span> <span class="string">'dev labels shape: '</span>, y_dev.shape</div></pre></td></tr></table></figure><pre><code>Train data shape:  (49000L, 3073L)
Train labels shape:  (49000L,)
Validation data shape:  (1000L, 3073L)
Validation labels shape:  (1000L,)
Test data shape:  (1000L, 3073L)
Test labels shape:  (1000L,)
dev data shape:  (500L, 3073L)
dev labels shape:  (500L,)
</code></pre><h2 id="Softmax-Classifier"><a href="#Softmax-Classifier" class="headerlink" title="Softmax Classifier"></a>Softmax Classifier</h2><p>Your code for this section will all be written inside <strong>cs231n/classifiers/softmax.py</strong>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># First implement the naive softmax loss function with nested loops.</span></div><div class="line"><span class="comment"># Open the file cs231n/classifiers/softmax.py and implement the</span></div><div class="line"><span class="comment"># softmax_loss_naive function.</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> cs231n.classifiers.softmax <span class="keyword">import</span> softmax_loss_naive</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="comment"># Generate a random softmax weight matrix and use it to compute the loss.</span></div><div class="line">W = np.random.randn(<span class="number">3073</span>, <span class="number">10</span>) * <span class="number">0.0001</span></div><div class="line">loss, grad = softmax_loss_naive(W, X_dev, y_dev, <span class="number">0.0</span>)</div><div class="line"></div><div class="line"><span class="comment"># As a rough sanity check, our loss should be something close to -log(0.1).</span></div><div class="line"><span class="keyword">print</span> <span class="string">'loss: %f'</span> % loss</div><div class="line"><span class="keyword">print</span> <span class="string">'sanity check: %f'</span> % (-np.log(<span class="number">0.1</span>))</div></pre></td></tr></table></figure><pre><code>loss: 2.395985
sanity check: 2.302585
</code></pre><h2 id="Inline-Question-1"><a href="#Inline-Question-1" class="headerlink" title="Inline Question 1:"></a>Inline Question 1:</h2><p>Why do we expect our loss to be close to -log(0.1)? Explain briefly.</p><p><strong>Your answer:</strong> <em>Because the W is selected by random, so the probability of select the true class is 1/10. That is, 0.1.</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Complete the implementation of softmax_loss_naive and implement a (naive)</span></div><div class="line"><span class="comment"># version of the gradient that uses nested loops.</span></div><div class="line">loss, grad = softmax_loss_naive(W, X_dev, y_dev, <span class="number">0.0</span>)</div><div class="line"></div><div class="line"><span class="comment"># As we did for the SVM, use numeric gradient checking as a debugging tool.</span></div><div class="line"><span class="comment"># The numeric gradient should be close to the analytic gradient.</span></div><div class="line"><span class="keyword">from</span> cs231n.gradient_check <span class="keyword">import</span> grad_check_sparse</div><div class="line">f = <span class="keyword">lambda</span> w: softmax_loss_naive(w, X_dev, y_dev, <span class="number">0.0</span>)[<span class="number">0</span>]</div><div class="line">grad_numerical = grad_check_sparse(f, W, grad, <span class="number">10</span>)</div><div class="line"></div><div class="line"><span class="comment"># similar to SVM case, do another gradient check with regularization</span></div><div class="line">loss, grad = softmax_loss_naive(W, X_dev, y_dev, <span class="number">1e2</span>)</div><div class="line">f = <span class="keyword">lambda</span> w: softmax_loss_naive(w, X_dev, y_dev, <span class="number">1e2</span>)[<span class="number">0</span>]</div><div class="line">grad_numerical = grad_check_sparse(f, W, grad, <span class="number">10</span>)</div></pre></td></tr></table></figure><pre><code>numerical: 2.368141 analytic: 2.368141, relative error: 2.349797e-08
numerical: 1.324690 analytic: 1.324690, relative error: 7.140560e-08
numerical: 3.170412 analytic: 3.170411, relative error: 1.324741e-08
numerical: 0.249509 analytic: 0.249509, relative error: 2.647240e-08
numerical: 1.536095 analytic: 1.536095, relative error: 4.345856e-08
numerical: 1.075819 analytic: 1.075819, relative error: 3.902323e-08
numerical: -0.198098 analytic: -0.198098, relative error: 5.737134e-08
numerical: -0.089902 analytic: -0.089902, relative error: 8.604010e-07
numerical: -0.339487 analytic: -0.339487, relative error: 3.992996e-08
numerical: -4.819781 analytic: -4.819781, relative error: 3.465667e-09
numerical: 1.869922 analytic: 1.869921, relative error: 7.536693e-08
numerical: 0.783465 analytic: 0.783465, relative error: 6.960291e-08
numerical: -3.206007 analytic: -3.206007, relative error: 2.337350e-09
numerical: 0.532183 analytic: 0.532183, relative error: 1.498128e-07
numerical: 0.900500 analytic: 0.900500, relative error: 6.954913e-09
numerical: -0.353224 analytic: -0.353224, relative error: 1.836960e-07
numerical: -1.331470 analytic: -1.331470, relative error: 2.726426e-08
numerical: -0.082452 analytic: -0.082452, relative error: 7.712355e-07
numerical: -1.322133 analytic: -1.322133, relative error: 5.516628e-09
numerical: 0.345814 analytic: 0.345814, relative error: 1.251858e-07
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Now that we have a naive implementation of the softmax loss function and its gradient,</span></div><div class="line"><span class="comment"># implement a vectorized version in softmax_loss_vectorized.</span></div><div class="line"><span class="comment"># The two versions should compute the same results, but the vectorized version should be</span></div><div class="line"><span class="comment"># much faster.</span></div><div class="line">tic = time.time()</div><div class="line">loss_naive, grad_naive = softmax_loss_naive(W, X_dev, y_dev, <span class="number">0.00001</span>)</div><div class="line">toc = time.time()</div><div class="line"><span class="keyword">print</span> <span class="string">'naive loss: %e computed in %fs'</span> % (loss_naive, toc - tic)</div><div class="line"></div><div class="line"><span class="keyword">from</span> cs231n.classifiers.softmax <span class="keyword">import</span> softmax_loss_vectorized</div><div class="line">tic = time.time()</div><div class="line">loss_vectorized, grad_vectorized = softmax_loss_vectorized(W, X_dev, y_dev, <span class="number">0.00001</span>)</div><div class="line">toc = time.time()</div><div class="line"><span class="keyword">print</span> <span class="string">'vectorized loss: %e computed in %fs'</span> % (loss_vectorized, toc - tic)</div><div class="line"></div><div class="line"><span class="comment"># As we did for the SVM, we use the Frobenius norm to compare the two versions</span></div><div class="line"><span class="comment"># of the gradient.</span></div><div class="line">grad_difference = np.linalg.norm(grad_naive - grad_vectorized, ord=<span class="string">'fro'</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">'Loss difference: %f'</span> % np.abs(loss_naive - loss_vectorized)</div><div class="line"><span class="keyword">print</span> <span class="string">'Gradient difference: %f'</span> % grad_difference</div></pre></td></tr></table></figure><pre><code>naive loss: 2.395985e+00 computed in 0.080000s
vectorized loss: 2.395985e+00 computed in 0.003000s
Loss difference: 0.000000
Gradient difference: 0.000000
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Use the validation set to tune hyperparameters (regularization strength and</span></div><div class="line"><span class="comment"># learning rate). You should experiment with different ranges for the learning</span></div><div class="line"><span class="comment"># rates and regularization strengths; if you are careful you should be able to</span></div><div class="line"><span class="comment"># get a classification accuracy of over 0.35 on the validation set.</span></div><div class="line"><span class="keyword">from</span> cs231n.classifiers <span class="keyword">import</span> Softmax</div><div class="line">results = &#123;&#125;</div><div class="line">best_val = <span class="number">-1</span></div><div class="line">best_softmax = <span class="keyword">None</span></div><div class="line">learning_rates = [<span class="number">1e-8</span>, <span class="number">1e-7</span>, <span class="number">2e-7</span>]</div><div class="line">regularization_strengths = [<span class="number">1e4</span>, <span class="number">2e4</span>, <span class="number">3e4</span>, <span class="number">4e4</span>, <span class="number">5e4</span>, <span class="number">6e4</span>, <span class="number">7e4</span>, <span class="number">8e4</span>, <span class="number">1e5</span>]</div><div class="line"></div><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="comment"># <span class="doctag">TODO:</span>                                                                        #</span></div><div class="line"><span class="comment"># Use the validation set to set the learning rate and regularization strength. #</span></div><div class="line"><span class="comment"># This should be identical to the validation that you did for the SVM; save    #</span></div><div class="line"><span class="comment"># the best trained softmax classifer in best_softmax.                          #</span></div><div class="line"><span class="comment">################################################################################</span></div><div class="line">iters = <span class="number">2000</span></div><div class="line"><span class="keyword">for</span> lr <span class="keyword">in</span> learning_rates:</div><div class="line">    <span class="keyword">for</span> rs <span class="keyword">in</span> regularization_strengths:</div><div class="line">        softmax = Softmax()</div><div class="line">        softmax.train(X_train, y_train, learning_rate=lr, reg=rs, num_iters=iters)</div><div class="line">        </div><div class="line">        y_train_pred = softmax.predict(X_train)</div><div class="line">        acc_train = np.mean(y_train == y_train_pred)</div><div class="line">        y_val_pred = softmax.predict(X_val)</div><div class="line">        acc_val = np.mean(y_val == y_val_pred)</div><div class="line">        </div><div class="line">        results[(lr, rs)] = (acc_train, acc_val)</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> best_val &lt; acc_val:</div><div class="line">            best_val = acc_val</div><div class="line">            best_softmax = softmax</div><div class="line"><span class="comment">################################################################################</span></div><div class="line"><span class="comment">#                              END OF YOUR CODE                                #</span></div><div class="line"><span class="comment">################################################################################</span></div><div class="line">    </div><div class="line"><span class="comment"># Print out results.</span></div><div class="line"><span class="keyword">for</span> lr, reg <span class="keyword">in</span> sorted(results):</div><div class="line">    train_accuracy, val_accuracy = results[(lr, reg)]</div><div class="line">    <span class="keyword">print</span> <span class="string">'lr %e reg %e train accuracy: %f val accuracy: %f'</span> % (</div><div class="line">                lr, reg, train_accuracy, val_accuracy)</div><div class="line">    </div><div class="line"><span class="keyword">print</span> <span class="string">'best validation accuracy achieved during cross-validation: %f'</span> % best_val</div></pre></td></tr></table></figure><pre><code>lr 1.000000e-08 reg 1.000000e+04 train accuracy: 0.175633 val accuracy: 0.179000
lr 1.000000e-08 reg 2.000000e+04 train accuracy: 0.174102 val accuracy: 0.161000
lr 1.000000e-08 reg 3.000000e+04 train accuracy: 0.203490 val accuracy: 0.210000
lr 1.000000e-08 reg 4.000000e+04 train accuracy: 0.191367 val accuracy: 0.202000
lr 1.000000e-08 reg 5.000000e+04 train accuracy: 0.208000 val accuracy: 0.197000
lr 1.000000e-08 reg 6.000000e+04 train accuracy: 0.203571 val accuracy: 0.215000
lr 1.000000e-08 reg 7.000000e+04 train accuracy: 0.213551 val accuracy: 0.215000
lr 1.000000e-08 reg 8.000000e+04 train accuracy: 0.238347 val accuracy: 0.229000
lr 1.000000e-08 reg 1.000000e+05 train accuracy: 0.245102 val accuracy: 0.242000
lr 1.000000e-07 reg 1.000000e+04 train accuracy: 0.358265 val accuracy: 0.362000
lr 1.000000e-07 reg 2.000000e+04 train accuracy: 0.356306 val accuracy: 0.374000
lr 1.000000e-07 reg 3.000000e+04 train accuracy: 0.347327 val accuracy: 0.362000
lr 1.000000e-07 reg 4.000000e+04 train accuracy: 0.336347 val accuracy: 0.354000
lr 1.000000e-07 reg 5.000000e+04 train accuracy: 0.331490 val accuracy: 0.348000
lr 1.000000e-07 reg 6.000000e+04 train accuracy: 0.320163 val accuracy: 0.336000
lr 1.000000e-07 reg 7.000000e+04 train accuracy: 0.314551 val accuracy: 0.325000
lr 1.000000e-07 reg 8.000000e+04 train accuracy: 0.313082 val accuracy: 0.324000
lr 1.000000e-07 reg 1.000000e+05 train accuracy: 0.303000 val accuracy: 0.315000
lr 2.000000e-07 reg 1.000000e+04 train accuracy: 0.374163 val accuracy: 0.389000
lr 2.000000e-07 reg 2.000000e+04 train accuracy: 0.353184 val accuracy: 0.365000
lr 2.000000e-07 reg 3.000000e+04 train accuracy: 0.340265 val accuracy: 0.359000
lr 2.000000e-07 reg 4.000000e+04 train accuracy: 0.334673 val accuracy: 0.351000
lr 2.000000e-07 reg 5.000000e+04 train accuracy: 0.326531 val accuracy: 0.337000
lr 2.000000e-07 reg 6.000000e+04 train accuracy: 0.319857 val accuracy: 0.336000
lr 2.000000e-07 reg 7.000000e+04 train accuracy: 0.317878 val accuracy: 0.329000
lr 2.000000e-07 reg 8.000000e+04 train accuracy: 0.310449 val accuracy: 0.329000
lr 2.000000e-07 reg 1.000000e+05 train accuracy: 0.316286 val accuracy: 0.315000
best validation accuracy achieved during cross-validation: 0.389000
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># evaluate on test set</span></div><div class="line"><span class="comment"># Evaluate the best softmax on test set</span></div><div class="line">y_test_pred = best_softmax.predict(X_test)</div><div class="line">test_accuracy = np.mean(y_test == y_test_pred)</div><div class="line"><span class="keyword">print</span> <span class="string">'softmax on raw pixels final test set accuracy: %f'</span> % (test_accuracy, )</div></pre></td></tr></table></figure><pre><code>softmax on raw pixels final test set accuracy: 0.375000
</code></pre><p>​</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Visualize the learned weights for each class</span></div><div class="line">w = best_softmax.W[:<span class="number">-1</span>,:] <span class="comment"># strip out the bias</span></div><div class="line">w = w.reshape(<span class="number">32</span>, <span class="number">32</span>, <span class="number">3</span>, <span class="number">10</span>)</div><div class="line"></div><div class="line">w_min, w_max = np.min(w), np.max(w)</div><div class="line"></div><div class="line">classes = [<span class="string">'plane'</span>, <span class="string">'car'</span>, <span class="string">'bird'</span>, <span class="string">'cat'</span>, <span class="string">'deer'</span>, <span class="string">'dog'</span>, <span class="string">'frog'</span>, <span class="string">'horse'</span>, <span class="string">'ship'</span>, <span class="string">'truck'</span>]</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>):</div><div class="line">  plt.subplot(<span class="number">2</span>, <span class="number">5</span>, i + <span class="number">1</span>)</div><div class="line">  </div><div class="line">  <span class="comment"># Rescale the weights to be between 0 and 255</span></div><div class="line">  wimg = <span class="number">255.0</span> * (w[:, :, :, i].squeeze() - w_min) / (w_max - w_min)</div><div class="line">  plt.imshow(wimg.astype(<span class="string">'uint8'</span>))</div><div class="line">  plt.axis(<span class="string">'off'</span>)</div><div class="line">  plt.title(classes[i])</div></pre></td></tr></table></figure><p><img src="http://o7ie0tcjk.bkt.clouddn.com/cs231n/assignment/01/softmax/template.png" alt="template"></p><h1 id="Codes"><a href="#Codes" class="headerlink" title="Codes"></a>Codes</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> shuffle</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">softmax_loss_naive</span><span class="params">(W, X, y, reg)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Softmax loss function, naive implementation (with loops)</div><div class="line"></div><div class="line">    Inputs have dimension D, there are C classes, and we operate on minibatches</div><div class="line">    of N examples.</div><div class="line"></div><div class="line">    Inputs:</div><div class="line">    - W: A numpy array of shape (D, C) containing weights.</div><div class="line">    - X: A numpy array of shape (N, D) containing a minibatch of data.</div><div class="line">    - y: A numpy array of shape (N,) containing training labels; y[i] = c means</div><div class="line">      that X[i] has label c, where 0 &lt;= c &lt; C.</div><div class="line">    - reg: (float) regularization strength</div><div class="line"></div><div class="line">    Returns a tuple of:</div><div class="line">    - loss as single float</div><div class="line">    - gradient with respect to weights W; an array of same shape as W</div><div class="line">    """</div><div class="line">    <span class="comment"># Initialize the loss and gradient to zero.</span></div><div class="line">    loss = <span class="number">0.0</span></div><div class="line">    dW = np.zeros_like(W)</div><div class="line"></div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line">    <span class="comment"># <span class="doctag">TODO:</span> Compute the softmax loss and its gradient using explicit loops.     #</span></div><div class="line">    <span class="comment"># Store the loss in loss and the gradient in dW. If you are not careful     #</span></div><div class="line">    <span class="comment"># here, it is easy to run into numeric instability. Don't forget the        #</span></div><div class="line">    <span class="comment"># regularization!                                                           #</span></div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line">    num_train = X.shape[<span class="number">0</span>]</div><div class="line">    num_classes = W.shape[<span class="number">1</span>]</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(num_train):</div><div class="line">        f = X[i, :].dot(W)</div><div class="line">        f -= np.max(f)</div><div class="line">        correct_f = f[y[i]]</div><div class="line">        denom = np.sum(np.exp(f))</div><div class="line"></div><div class="line">        p = np.exp(correct_f) / denom</div><div class="line">        loss += -np.log(p)</div><div class="line"></div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> xrange(num_classes):</div><div class="line">            <span class="keyword">if</span> j == y[i]:</div><div class="line">                dW[:, y[i]] += (np.exp(f[j]) / denom - <span class="number">1</span>) * X[i, :]</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                dW[:, j] += (np.exp(f[j]) / denom) * X[i, :]</div><div class="line"></div><div class="line">    loss /= num_train</div><div class="line">    loss += <span class="number">0.5</span> * reg * np.sum(W * W)</div><div class="line"></div><div class="line">    dW /= num_train</div><div class="line">    dW += reg * W</div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line">    <span class="comment">#                          END OF YOUR CODE                                 #</span></div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> loss, dW</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">softmax_loss_vectorized</span><span class="params">(W, X, y, reg)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Softmax loss function, vectorized version.</div><div class="line"></div><div class="line">    Inputs and outputs are the same as softmax_loss_naive.</div><div class="line">    """</div><div class="line">    <span class="comment"># Initialize the loss and gradient to zero.</span></div><div class="line">    loss = <span class="number">0.0</span></div><div class="line">    dW = np.zeros_like(W)</div><div class="line"></div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line">    <span class="comment"># <span class="doctag">TODO:</span> Compute the softmax loss and its gradient using no explicit loops.  #</span></div><div class="line">    <span class="comment"># Store the loss in loss and the gradient in dW. If you are not careful     #</span></div><div class="line">    <span class="comment"># here, it is easy to run into numeric instability. Don't forget the        #</span></div><div class="line">    <span class="comment"># regularization!                                                           #</span></div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line">    num_train = X.shape[<span class="number">0</span>]</div><div class="line"></div><div class="line">    f = X.dot(W)</div><div class="line">    f = f - np.max(f, axis=<span class="number">1</span>)[:, np.newaxis]</div><div class="line">    loss = -np.sum(</div><div class="line">        np.log(np.exp(f[np.arange(num_train), y]) / np.sum(np.exp(f), axis=<span class="number">1</span>)))</div><div class="line"></div><div class="line">    loss /= num_train</div><div class="line">    loss += <span class="number">0.5</span> * reg * np.sum(W * W)</div><div class="line"></div><div class="line">    ind = np.zeros_like(f)</div><div class="line">    ind[np.arange(num_train), y] = <span class="number">1</span></div><div class="line">    dW = X.T.dot(np.exp(f) / np.sum(np.exp(f), axis=<span class="number">1</span>, keepdims=<span class="keyword">True</span>) - ind)</div><div class="line"></div><div class="line">    dW /= num_train</div><div class="line">    dW += reg * W</div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line">    <span class="comment">#                          END OF YOUR CODE                                 #</span></div><div class="line">    <span class="comment">#############################################################################</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> loss, dW</div></pre></td></tr></table></figure></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/02/CS231n-Lecture3-note/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Ewan Li"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Abracadabra"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Abracadabra" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2017/03/02/CS231n-Lecture3-note/" itemprop="url">CS231n Lecture3 note</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-02T14:33:34+08:00">2017-03-02 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2017/03/02/CS231n-Lecture3-note/#comments" itemprop="discussionUrl"><span class="post-comments-count hc-comment-count" data-xid="2017/03/02/CS231n-Lecture3-note/" itemprop="commentsCount"></span> </a></span><span id="/2017/03/02/CS231n-Lecture3-note/" class="leancloud_visitors" data-flag-title="CS231n Lecture3 note"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="Loss-function"><a href="#Loss-function" class="headerlink" title="Loss function"></a>Loss function</h1><p>Source is <a href="http://cs231n.github.io/linear-classify/" target="_blank" rel="external">here</a>.</p><h2 id="Multiclass-Support-Vector-Machine-loss"><a href="#Multiclass-Support-Vector-Machine-loss" class="headerlink" title="Multiclass Support Vector Machine loss"></a>Multiclass Support Vector Machine loss</h2><p>The SVM loss is set up so that the SVM “wants” the correct class for each image to a have a score higher than the incorrect classes by some fixed margin $\Delta$</p><p>The Multiclass SVM loss for the i-th example is formalized as follows:</p><p><strong>Example</strong></p><p>$s = [13, -7, 11]$ and $\Delta = 10$, then,</p><p>$$L_i = \max(0, -7 - 13 + 10) + \max(0, 11 - 13 + 10)$$</p><p>In summary, the SVM loss function wants the score of the correct class $y_i$ to be larger than the incorrect class scores by at least by $\Delta$ (delta). If this is not the case, we will accumulate loss.</p><p>Note that $f(x_i; W) = W x_i$, so we can also rewrite the loss function in this equivalent form:</p><p>$$L_i = \sum_{j\neq y_i} \max(0, w_j^T x_i - w_{y_i}^T x_i + \Delta)$$</p><p>A last piece of terminology we’ll mention before we finish with this section is that the threshold at zero $\max(0,−)$ function is often called the <strong>hinge loss</strong>. You’ll sometimes hear about people instead using the squared hinge loss SVM (or L2-SVM), which uses the form $\max(0,−)^2$ that penalizes violated margins more strongly (quadratically instead of linearly). The unsquared version is more standard, but in some datasets the squared hinge loss can work better. This can be determined during cross-validation.</p><p>The follow image shows the motivation of the SVM loss function”</p><p><img src="http://o7ie0tcjk.bkt.clouddn.com/cs231n/03/margin.jpg" alt="margin"></p><h3 id="Regularization"><a href="#Regularization" class="headerlink" title="Regularization"></a>Regularization</h3><p>There is one bug with the loss function we presented above. Suppose that we have a dataset and a set of parameters <strong>W</strong> that correctly classify every example (i.e. all scores are so that all the margins are met, and $L_i=0$ for all i). The issue is that this set of <strong>W</strong> is not necessarily unique: there might be many similar <strong>W</strong> that correctly classify the examples. One easy way to see this is that if some parameters <strong>W</strong> correctly classify all examples (so loss is zero for each example), then any multiple of these parameters $\lambda W$ where $\lambda &gt; 1$ will also give zero loss because this transformation uniformly stretches all score magnitudes and hence also their absolute differences. For example, if the difference in scores between a correct class and a nearest incorrect class was 15, then multiplying all elements of <strong>W</strong> by 2 would make the new difference 30.</p><p>We can avoid this by extending the loss function with a <strong>regularization penalty</strong> $R(W)$. The most common regularization penalty is the <strong>L2</strong> norm:</p><p>$$R(W) = \sum_k\sum_l W_{k,l}^2$$</p><p>That is, the full Multiclass SVM loss becomes:</p><p>$$L = \underbrace{ \frac{1}{N} \sum_i L_i }_\text{data loss} + \underbrace{ \lambda R(W) }_\text{regularization loss} \\\\$$</p><p>Or expanding this out in its full form:</p><p>$$L = \frac{1}{N} \sum_i \sum_{j\neq y_i} \left[ \max(0, f(x_i; W)_j - f(x_i; W)_{y_i} + \Delta) \right] + \lambda \sum_k\sum_l W_{k,l}^2$$</p><p>Including the L2 penalty leads to the appealing <strong>max margin</strong> property in SVMs (See <a href="http://cs229.stanford.edu/notes/cs229-notes3.pdf" target="_blank" rel="external">CS229</a> lecture notes for full details if you are interested).</p><p>The most appealing property is that penalizing large weights tends to improve generalization, because it means that no input dimension can have a very large influence on the scores all by itself. For example, suppose that we have some input vector $x=[1,1,1,1]$ and two weight vectors $w_1=[1,0,0,0]$, $w_2=[0.25,0.25,0.25,0.25]$. Then $w^T_1x=w^T_2x=1$ so both weight vectors lead to the same dot product, but the <strong>L2</strong> penalty of $w_1$ is 1.0 while the <strong>L2</strong> penalty of $w_2$ is only 0.25. Therefore, according to the <strong>L2</strong> penalty the weight vector $w_2$ would be preferred since it achieves a lower regularization loss. Intuitively, this is because the weights in $w_2$ are smaller and more diffuse. Since the <strong>L2</strong> penalty prefers smaller and more diffuse weight vectors, the final classifier is encouraged to take into account all input dimensions to small amounts rather than a few input dimensions and very strongly. As we will see later in the class, this effect can improve the generalization performance of the classifiers on test images and lead to less <em>overfitting</em>.</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">L_i</span><span class="params">(x, y, W)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  unvectorized version. Compute the multiclass svm loss for a single example (x,y)</div><div class="line">  - x is a column vector representing an image (e.g. 3073 x 1 in CIFAR-10)</div><div class="line">    with an appended bias dimension in the 3073-rd position (i.e. bias trick)</div><div class="line">  - y is an integer giving index of correct class (e.g. between 0 and 9 in CIFAR-10)</div><div class="line">  - W is the weight matrix (e.g. 10 x 3073 in CIFAR-10)</div><div class="line">  """</div><div class="line">  delta = <span class="number">1.0</span> <span class="comment"># see notes about delta later in this section</span></div><div class="line">  scores = W.dot(x) <span class="comment"># scores becomes of size 10 x 1, the scores for each class</span></div><div class="line">  correct_class_score = scores[y]</div><div class="line">  D = W.shape[<span class="number">0</span>] <span class="comment"># number of classes, e.g. 10</span></div><div class="line">  loss_i = <span class="number">0.0</span></div><div class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> xrange(D): <span class="comment"># iterate over all wrong classes</span></div><div class="line">    <span class="keyword">if</span> j == y:</div><div class="line">      <span class="comment"># skip for the true class to only loop over incorrect classes</span></div><div class="line">      <span class="keyword">continue</span></div><div class="line">    <span class="comment"># accumulate loss for the i-th example</span></div><div class="line">    loss_i += max(<span class="number">0</span>, scores[j] - correct_class_score + delta)</div><div class="line">  <span class="keyword">return</span> loss_i</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">L_i_vectorized</span><span class="params">(x, y, W)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  A faster half-vectorized implementation. half-vectorized</div><div class="line">  refers to the fact that for a single example the implementation contains</div><div class="line">  no for loops, but there is still one loop over the examples (outside this function)</div><div class="line">  """</div><div class="line">  delta = <span class="number">1.0</span></div><div class="line">  scores = W.dot(x)</div><div class="line">  <span class="comment"># compute the margins for all classes in one vector operation</span></div><div class="line">  margins = np.maximum(<span class="number">0</span>, scores - scores[y] + delta)</div><div class="line">  <span class="comment"># on y-th position scores[y] - scores[y] canceled and gave delta. We want</span></div><div class="line">  <span class="comment"># to ignore the y-th position and only consider margin on max wrong class</span></div><div class="line">  margins[y] = <span class="number">0</span></div><div class="line">  loss_i = np.sum(margins)</div><div class="line">  <span class="keyword">return</span> loss_i</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">L</span><span class="params">(X, y, W)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  fully-vectorized implementation :</div><div class="line">  - X holds all the training examples as columns (e.g. 3073 x 50,000 in CIFAR-10)</div><div class="line">  - y is array of integers specifying correct class (e.g. 50,000-D array)</div><div class="line">  - W are weights (e.g. 10 x 3073)</div><div class="line">  """</div><div class="line">  <span class="comment"># evaluate loss over all examples in X without using any for loops</span></div><div class="line">  <span class="comment"># left as exercise to reader in the assignment</span></div></pre></td></tr></table></figure><h3 id="Practice-Considerations"><a href="#Practice-Considerations" class="headerlink" title="Practice Considerations"></a>Practice Considerations</h3><h4 id="Setting-Delta"><a href="#Setting-Delta" class="headerlink" title="Setting Delta"></a>Setting Delta</h4><p>Note that we brushed over the hyperparameter $\Delta$ and its setting. What value should it be set to, and do we have to cross-validate it? It turns out that this hyperparameter can safely be set to $\Delta = 1.0$ in all cases. The hyperparameters $\Delta$ and $\lambda$ seem like two different hyperparameters, but in fact they both control the same tradeoff: The tradeoff between the data loss and the regularization loss in the objective. The key to understanding this is that the magnitude of the weights <strong>W</strong> has direct effect on the scores (and hence also their differences): As we shrink all values inside <strong>W</strong> the score differences will become lower, and as we scale up the weights the score differences will all become higher. Therefore, the exact value of the margin between the scores (e.g. $\Delta = 10$, or$\Delta = 100$) is in some sense meaningless because the weights can shrink or stretch the differences arbitrarily. Hence, the only real tradeoff is how large we allow the weights to grow (through the regularization strength $\lambda$).</p><h2 id="Softmax-classifier"><a href="#Softmax-classifier" class="headerlink" title="Softmax classifier"></a>Softmax classifier</h2><p>In the Softmax classifier, the function mapping $f(x_i; W) = W x_i$ stays unchanged, but we now interpret these scores as the unnormalized log probabilities for each class and replace the <em>hinge loss</em> with a <strong>cross-entropy loss</strong> that has the form:</p><p>$$L_i = -\log\left(\frac{e^{f_{y_i}}}{ \sum_j e^{f_j} }\right) \hspace{0.5in} \text{or equivalently} \hspace{0.5in} L_i = -f_{y_i} + \log\sum_j e^{f_j}$$</p><p>The function $f_j(z) = \frac{e^{z_j}}{\sum_k e^{z_k}}$ is called the <strong>softmax function</strong>.</p><h3 id="Information-theory-view"><a href="#Information-theory-view" class="headerlink" title="Information theory view"></a>Information theory view</h3><p>The <em>cross-entropy</em> between a “true” distribution $p$ and an estimated distribution $q$ is defined as:<br>$$<br>H(p,q) = - \sum_x p(x) \log q(x)<br>$$<br>The Softmax classifier is hence minimizing the cross-entropy between the estimated class probabilities ( $q = e^{f_{y_i}} / \sum_j e^{f_j}$ as seen above) and the “true” distribution, which in this interpretation is the distribution where all probability mass is on the correct class (i.e. $p = [0, \ldots 1, \ldots, 0]$ contains a single 1 at the $y_i$ -th position.).</p><p>Moreover, since the cross-entropy can be written in terms of entropy and the Kullback-Leibler divergence as $H(p,q) = H(p) + D_{KL}(p||q)$, and the entropy of the delta function $p$ is zero, this is also equivalent to minimizing the <strong>KL</strong> divergence between the two distributions (a measure of distance). In other words, the cross-entropy objective <em>wants</em> the predicted distribution to have all of its mass on the correct answer.</p><h3 id="Probabilistic-interpretation"><a href="#Probabilistic-interpretation" class="headerlink" title="Probabilistic interpretation"></a>Probabilistic interpretation</h3><p>$$P(y_i \mid x_i; W) = \frac{e^{f_{y_i}}}{\sum_j e^{f_j} }$$</p><p>can be interpreted as the (normalized) probability assigned to the correct label $y_i$given the image $x_i$ and parameterized by <strong>W</strong>. To see this, remember that the Softmax classifier interprets the scores inside the output vector $f$ as the unnormalized log probabilities. Exponentiating these quantities therefore gives the (unnormalized) probabilities, and the division performs the normalization so that the probabilities sum to one. In the probabilistic interpretation, we are therefore minimizing the negative log likelihood of the correct class, which can be interpreted as performing <em>Maximum Likelihood Estimation</em> (MLE). A nice feature of this view is that we can now also interpret the regularization term $R(W)$ in the full loss function as coming from a Gaussian prior over the weight matrix <strong>W</strong>, where instead of MLE we are performing the <em>Maximum a posteriori</em> (MAP) estimation.</p><h3 id="Numeric-stability"><a href="#Numeric-stability" class="headerlink" title="Numeric stability"></a>Numeric stability</h3><p>When you’re writing code for computing the Softmax function in practice, the intermediate term $e^{f_{y_i}}$ and $\sum_j e^{f_j}$ may be very large due to the exponentials. Dividing large numbers can be numerically unstable, so it is important to use a normalization trick. Notice that if we multiply the top and bottom of the fraction by a constant <strong>C</strong> and push it into the sum, we get the following (mathematically equivalent) expression:</p><p>$$\frac{e^{f_{y_i}}}{\sum_j e^{f_j}}= \frac{Ce^{f_{y_i}}}{C\sum_j e^{f_j}}= \frac{e^{f_{y_i} + \log C}}{\sum_j e^{f_j + \log C}}$$</p><p>We are free to choose the value of <strong>C</strong>. This will not change any of the results, but we can use this value to improve the numerical stability of the computation. A common choice for <strong>C</strong> is to set $\log C = -\max_j f_j$. This simply states that we should shift the values inside the vector ff so that the highest value is zero. In code:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">f = np.array([<span class="number">123</span>, <span class="number">456</span>, <span class="number">789</span>]) <span class="comment"># example with 3 classes and each having large scores</span></div><div class="line">p = np.exp(f) / np.sum(np.exp(f)) <span class="comment"># Bad: Numeric problem, potential blowup</span></div><div class="line"></div><div class="line"><span class="comment"># instead: first shift the values of f so that the highest number is 0:</span></div><div class="line">f -= np.max(f) <span class="comment"># f becomes [-666, -333, 0]</span></div><div class="line">p = np.exp(f) / np.sum(np.exp(f)) <span class="comment"># safe to do, gives the correct answer</span></div></pre></td></tr></table></figure><h3 id="Some-tricks"><a href="#Some-tricks" class="headerlink" title="Some tricks"></a>Some tricks</h3><p>How peaky or diffuse these probabilities are depends directly on the regularization strength $\lambda$ - which you are in charge of as input to the system. For example, suppose that the unnormalized log-probabilities for some three classes come out to be [1, -2, 0]. The softmax function would then compute:</p><p>$$[1, -2, 0] \rightarrow [e^1, e^{-2}, e^0] = [2.71, 0.14, 1] \rightarrow [0.7, 0.04, 0.26]$$</p><p>Where the steps taken are to exponentiate and normalize to sum to one. Now, if the regularization strength $\lambda$ was higher, the weights <strong>W</strong> would be penalized more and this would lead to smaller weights. For example, suppose that the weights became one half smaller ([0.5, -1, 0]). The softmax would now compute:</p><p>$$[0.5, -1, 0] \rightarrow [e^{0.5}, e^{-1}, e^0] = [1.65, 0.37, 1] \rightarrow [0.55, 0.12, 0.33]$$</p><p>where the probabilites are now more diffuse.</p><h3 id="Futher-Reading"><a href="#Futher-Reading" class="headerlink" title="Futher Reading"></a>Futher Reading</h3><ul><li><a href="http://arxiv.org/abs/1306.0239" target="_blank" rel="external">Deep Learning using Linear Support Vector Machines</a> from Charlie Tang 2013 presents some results claiming that the L2SVM outperforms Softmax.</li></ul><h1 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h1><h2 id="Strategy-1-A-first-very-bad-idea-solution-Random-search"><a href="#Strategy-1-A-first-very-bad-idea-solution-Random-search" class="headerlink" title="Strategy #1: A first very bad idea solution: Random search"></a>Strategy #1: A first very bad idea solution: Random search</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># assume X_train is the data where each column is an example (e.g. 3073 x 50,000)</span></div><div class="line"><span class="comment"># assume Y_train are the labels (e.g. 1D array of 50,000)</span></div><div class="line"><span class="comment"># assume the function L evaluates the loss function</span></div><div class="line"></div><div class="line">bestloss = float(<span class="string">"inf"</span>) <span class="comment"># Python assigns the highest possible float value</span></div><div class="line"><span class="keyword">for</span> num <span class="keyword">in</span> xrange(<span class="number">1000</span>):</div><div class="line">  W = np.random.randn(<span class="number">10</span>, <span class="number">3073</span>) * <span class="number">0.0001</span> <span class="comment"># generate random parameters</span></div><div class="line">  loss = L(X_train, Y_train, W) <span class="comment"># get the loss over the entire training set</span></div><div class="line">  <span class="keyword">if</span> loss &lt; bestloss: <span class="comment"># keep track of the best solution</span></div><div class="line">    bestloss = loss</div><div class="line">    bestW = W</div><div class="line">  <span class="keyword">print</span> <span class="string">'in attempt %d the loss was %f, best %f'</span> % (num, loss, bestloss)</div><div class="line"></div><div class="line"><span class="comment"># prints:</span></div><div class="line"><span class="comment"># in attempt 0 the loss was 9.401632, best 9.401632</span></div><div class="line"><span class="comment"># in attempt 1 the loss was 8.959668, best 8.959668</span></div><div class="line"><span class="comment"># in attempt 2 the loss was 9.044034, best 8.959668</span></div><div class="line"><span class="comment"># in attempt 3 the loss was 9.278948, best 8.959668</span></div><div class="line"><span class="comment"># in attempt 4 the loss was 8.857370, best 8.857370</span></div><div class="line"><span class="comment"># in attempt 5 the loss was 8.943151, best 8.857370</span></div><div class="line"><span class="comment"># in attempt 6 the loss was 8.605604, best 8.605604</span></div><div class="line"><span class="comment"># ... (trunctated: continues for 1000 lines)</span></div></pre></td></tr></table></figure><p>We can take the best weights <strong>W</strong> found by this search and try it out on the test set:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Assume X_test is [3073 x 10000], Y_test [10000 x 1]</span></div><div class="line">scores = Wbest.dot(Xte_cols) <span class="comment"># 10 x 10000, the class scores for all test examples</span></div><div class="line"><span class="comment"># find the index with max score in each column (the predicted class)</span></div><div class="line">Yte_predict = np.argmax(scores, axis = <span class="number">0</span>)</div><div class="line"><span class="comment"># and calculate accuracy (fraction of predictions that are correct)</span></div><div class="line">np.mean(Yte_predict == Yte)</div><div class="line"><span class="comment"># returns 0.1555</span></div></pre></td></tr></table></figure><p>With the best <strong>W</strong> this gives an accuracy of about <strong>15.5%</strong>.</p><p><strong>Core idea: iterative refinement</strong>. Of course, it turns out that we can do much better. The core idea is that finding the best set of weights <strong>W</strong> is a very difficult or even impossible problem (especially once <strong>W</strong> contains weights for entire complex neural networks), but the problem of refining a specific set of weights <strong>W</strong> to be slightly better is significantly less difficult. In other words, our approach will be to start with a random <strong>W</strong> and then iteratively refine it, making it slightly better each time.</p><blockquote><p>Our strategy will be to start with random weights and iteratively refine them over time to get lower loss</p></blockquote><h2 id="Strategy-2-Random-Local-Search"><a href="#Strategy-2-Random-Local-Search" class="headerlink" title="Strategy #2: Random Local Search"></a>Strategy #2: Random Local Search</h2><p>Concretely, we will start out with a random WW, generate random perturbations $\delta W$ to it and if the loss at the perturbed $W + \delta W$ is lower, we will perform an update. The code for this procedure is as follows:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">W = np.random.randn(<span class="number">10</span>, <span class="number">3073</span>) * <span class="number">0.001</span> <span class="comment"># generate random starting W</span></div><div class="line">bestloss = float(<span class="string">"inf"</span>)</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1000</span>):</div><div class="line">  step_size = <span class="number">0.0001</span></div><div class="line">  Wtry = W + np.random.randn(<span class="number">10</span>, <span class="number">3073</span>) * step_size</div><div class="line">  loss = L(Xtr_cols, Ytr, Wtry)</div><div class="line">  <span class="keyword">if</span> loss &lt; bestloss:</div><div class="line">    W = Wtry</div><div class="line">    bestloss = loss</div><div class="line">  <span class="keyword">print</span> <span class="string">'iter %d loss is %f'</span> % (i, bestloss)</div></pre></td></tr></table></figure><p>This approach achieves test set classification accuracy of <strong>21.4%</strong>.</p><h2 id="Strategy-3-Following-the-Gradient"><a href="#Strategy-3-Following-the-Gradient" class="headerlink" title="Strategy #3: Following the Gradient"></a>Strategy #3: Following the Gradient</h2><p>The mathematical expression for the derivative of a 1-D function with respect its input is:<br>$$<br>\frac{df(x)}{dx} = \lim_{h\ \to 0} \frac{f(x + h) - f(x)}{h}<br>$$<br>When the functions of interest take a vector of numbers instead of a single number, we call the derivatives <strong>partial derivatives</strong>, and the gradient is simply the vector of partial derivatives in each dimension.</p><h3 id="Computing-the-gradient"><a href="#Computing-the-gradient" class="headerlink" title="Computing the gradient"></a>Computing the gradient</h3><p>There are two ways to compute the gradient: A slow, approximate but easy way (<strong>numerical gradient</strong>), and a fast, exact but more error-prone way that requires calculus (<strong>analytic gradient</strong>). We will now present both.</p><h4 id="Computing-the-gradient-numerically-with-finite-differences"><a href="#Computing-the-gradient-numerically-with-finite-differences" class="headerlink" title="Computing the gradient numerically with finite differences"></a>Computing the gradient numerically with finite differences</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">eval_numerical_gradient</span><span class="params">(f, x)</span>:</span></div><div class="line">  <span class="string">""" </span></div><div class="line">  a naive implementation of numerical gradient of f at x </div><div class="line">  - f should be a function that takes a single argument</div><div class="line">  - x is the point (numpy array) to evaluate the gradient at</div><div class="line">  """ </div><div class="line"></div><div class="line">  fx = f(x) <span class="comment"># evaluate function value at original point</span></div><div class="line">  grad = np.zeros(x.shape)</div><div class="line">  h = <span class="number">0.00001</span></div><div class="line"></div><div class="line">  <span class="comment"># iterate over all indexes in x</span></div><div class="line">  it = np.nditer(x, flags=[<span class="string">'multi_index'</span>], op_flags=[<span class="string">'readwrite'</span>])</div><div class="line">  <span class="keyword">while</span> <span class="keyword">not</span> it.finished:</div><div class="line"></div><div class="line">    <span class="comment"># evaluate function at x+h</span></div><div class="line">    ix = it.multi_index</div><div class="line">    old_value = x[ix]</div><div class="line">    x[ix] = old_value + h <span class="comment"># increment by h</span></div><div class="line">    fxh = f(x) <span class="comment"># evalute f(x + h)</span></div><div class="line">    x[ix] = old_value <span class="comment"># restore to previous value (very important!)</span></div><div class="line"></div><div class="line">    <span class="comment"># compute the partial derivative</span></div><div class="line">    grad[ix] = (fxh - fx) / h <span class="comment"># the slope</span></div><div class="line">    it.iternext() <span class="comment"># step to next dimension</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> grad</div></pre></td></tr></table></figure><p><strong>Practical considerations</strong>.</p><p>Note that in the mathematical formulation the gradient is defined in the limit as <strong>h</strong> goes towards zero, but in practice it is often sufficient to use a very small value (such as 1e-5 as seen in the example). Ideally, you want to use the smallest step size that does not lead to numerical issues. Additionally, in practice it often works better to compute the numeric gradient using the <strong>centered difference formula</strong>:<br>$$<br>[f(x+h) - f(x-h)] / 2 h<br>$$<br>See <a href="http://en.wikipedia.org/wiki/Numerical_differentiation" target="_blank" rel="external">wiki</a> for details.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># to use the generic code above we want a function that takes a single argument</span></div><div class="line"><span class="comment"># (the weights in our case) so we close over X_train and Y_train</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CIFAR10_loss_fun</span><span class="params">(W)</span>:</span></div><div class="line">  <span class="keyword">return</span> L(X_train, Y_train, W)</div><div class="line"></div><div class="line">W = np.random.rand(<span class="number">10</span>, <span class="number">3073</span>) * <span class="number">0.001</span> <span class="comment"># random weight vector</span></div><div class="line">df = eval_numerical_gradient(CIFAR10_loss_fun, W) <span class="comment"># get the gradient</span></div></pre></td></tr></table></figure><p>Then we can use to make an update:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">loss_original = CIFAR10_loss_fun(W) <span class="comment"># the original loss</span></div><div class="line"><span class="keyword">print</span> <span class="string">'original loss: %f'</span> % (loss_original, )</div><div class="line"></div><div class="line"><span class="comment"># lets see the effect of multiple step sizes</span></div><div class="line"><span class="keyword">for</span> step_size_log <span class="keyword">in</span> [<span class="number">-10</span>, <span class="number">-9</span>, <span class="number">-8</span>, <span class="number">-7</span>, <span class="number">-6</span>, <span class="number">-5</span>,<span class="number">-4</span>,<span class="number">-3</span>,<span class="number">-2</span>,<span class="number">-1</span>]:</div><div class="line">  step_size = <span class="number">10</span> ** step_size_log</div><div class="line">  W_new = W - step_size * df <span class="comment"># new position in the weight space</span></div><div class="line">  loss_new = CIFAR10_loss_fun(W_new)</div><div class="line">  <span class="keyword">print</span> <span class="string">'for step size %f new loss: %f'</span> % (step_size, loss_new)</div><div class="line"></div><div class="line"><span class="comment"># prints:</span></div><div class="line"><span class="comment"># original loss: 2.200718</span></div><div class="line"><span class="comment"># for step size 1.000000e-10 new loss: 2.200652</span></div><div class="line"><span class="comment"># for step size 1.000000e-09 new loss: 2.200057</span></div><div class="line"><span class="comment"># for step size 1.000000e-08 new loss: 2.194116</span></div><div class="line"><span class="comment"># for step size 1.000000e-07 new loss: 2.135493</span></div><div class="line"><span class="comment"># for step size 1.000000e-06 new loss: 1.647802</span></div><div class="line"><span class="comment"># for step size 1.000000e-05 new loss: 2.844355</span></div><div class="line"><span class="comment"># for step size 1.000000e-04 new loss: 25.558142</span></div><div class="line"><span class="comment"># for step size 1.000000e-03 new loss: 254.086573</span></div><div class="line"><span class="comment"># for step size 1.000000e-02 new loss: 2539.370888</span></div><div class="line"><span class="comment"># for step size 1.000000e-01 new loss: 25392.214036</span></div></pre></td></tr></table></figure><p><strong>Effect of step size</strong></p><p><img src="http://o7ie0tcjk.bkt.clouddn.com/cs231n/03/stepsize.jpg" alt="margin"></p><h4 id="Computing-the-gradient-analytically-with-Calculus"><a href="#Computing-the-gradient-analytically-with-Calculus" class="headerlink" title="Computing the gradient analytically with Calculus"></a>Computing the gradient analytically with Calculus</h4><p>However, unlike the numerical gradient it can be more error prone to implement, which is why in practice it is very common to compute the analytic gradient and compare it to the numerical gradient to check the correctness of your implementation. This is called a <strong>gradient check</strong>.</p><p>Lets use the example of the SVM loss function for a single datapoint:<br>$$<br>L_i = \sum_{j\neq y_i} \left[ \max(0, w_j^Tx_i - w_{y_i}^Tx_i + \Delta) \right]<br>$$</p><p>$$<br>\nabla_{w_{y_i}} L_i = - \left( \sum_{j\neq y_i} \mathbb{1}(w_j^Tx_i - w_{y_i}^Tx_i + \Delta &gt; 0) \right) x_i<br>$$</p><p>when you’re implementing this in code you’d simply count the number of classes that didn’t meet the desired margin (and hence contributed to the loss function) and then the data vector $x_i$ scaled by this number is the gradient.<br>$$<br>\nabla_{w_j} L_i = \mathbb{1}(w_j^Tx_i - w_{y_i}^Tx_i + \Delta &gt; 0) x_i<br>$$</p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></section><nav class="pagination"><a class="extend prev" rel="prev" href="/page/20/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/22/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Ewan Li"><p class="site-author-name" itemprop="name">Ewan Li</p><p class="site-description motion-element" itemprop="description">Ewan's IT Blog</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">121</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">58</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ewanlee" target="_blank" title="Github"><i class="fa fa-fw fa-globe"></i> Github </a></span><span class="links-of-author-item"><a href="http://weibo.com/3946248928/profile?topnav=1&wvr=6" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Ewan Li</span></div><div class="powered-by">Powered by <a class="theme-link" href="https://hexo.io">Hexo</a></div><div class="theme-info">Theme - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user">本站访客数</i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span>人次</span> <span class="site-pv"><i class="fa fa-eye">本站总访问量</i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><script type="text/javascript">_hcwp=window._hcwp||[],_hcwp.push({widget:"Bloggerstream",widget_id:89825,selector:".hc-comment-count",label:"{%COUNT%}"}),function(){if(!("HC_LOAD_INIT"in window)){HC_LOAD_INIT=!0;var t=(navigator.language||navigator.systemLanguage||navigator.userLanguage||"en").substr(0,2).toLowerCase(),e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https":"http")+"://w.hypercomments.com/widget/hc/89825/"+t+"/widget.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n.nextSibling)}}()</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),n=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!1,n=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=decodeURIComponent(r.url),i=-1,l=-1,p=-1;if(""!=n&&a.forEach(function(e,t){i=n.indexOf(e),l=s.indexOf(e),(i>=0||l>=0)&&(c=!0,0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+n+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),n.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script><script>AV.initialize("e27VKX5tTklQLCtF7iNMmhcA-gzGzoHsz","nnQn2znNgXXEdK7W2bVJ3bfK")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script></body></html>