<!doctype html><html class="theme-next mist use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="Hexo, NexT"><link rel="alternate" href="/atom.xml" title="Abracdabra" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0"><meta name="description" content="Ewan&apos;s IT Blog"><meta property="og:type" content="website"><meta property="og:title" content="Abracdabra"><meta property="og:url" content="http://yoursite.com/page/9/index.html"><meta property="og:site_name" content="Abracdabra"><meta property="og:description" content="Ewan&apos;s IT Blog"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Abracdabra"><meta name="twitter:description" content="Ewan&apos;s IT Blog"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/page/9/"><title>Abracdabra</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?dc405a79ad500922134d14cdf288f646";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Abracdabra</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Do it yourself</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div><span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/26/Movie-Recommendation-with-MLlib/"><span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Ewan Li"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Abracdabra"><span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Abracdabra" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2017/04/26/Movie-Recommendation-with-MLlib/" itemprop="url">Movie Recommendation with MLlib</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-26T14:24:57+08:00">2017-04-26 </time></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2017/04/26/Movie-Recommendation-with-MLlib/#comments" itemprop="discussionUrl"><span class="post-comments-count hc-comment-count" data-xid="2017/04/26/Movie-Recommendation-with-MLlib/" itemprop="commentsCount"></span> </a></span><span id="/2017/04/26/Movie-Recommendation-with-MLlib/" class="leancloud_visitors" data-flag-title="Movie Recommendation with MLlib"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="Spark-Summit-2014"><a href="#Spark-Summit-2014" class="headerlink" title="Spark Summit 2014"></a>Spark Summit 2014</h2><p><a href="https://databricks-training.s3.amazonaws.com/index.html" target="_blank" rel="external">https://databricks-training.s3.amazonaws.com/index.html</a></p><p>we will use MLlib to make personalized movie recommendations tailored <em>for you</em>. We will work with 10 million ratings from 72,000 users on 10,000 movies, collected by <a href="http://movielens.umn.edu/" target="_blank" rel="external">MovieLens</a>. This dataset is pre-loaded in your USB drive under <code>data/movielens/large</code>. For quick testing of your code, you may want to use a smaller dataset under <code>data/movielens/medium</code>, which contains 1 million ratings from 6000 users on 4000 movies.</p><h2 id="DataSet"><a href="#DataSet" class="headerlink" title="DataSet"></a>DataSet</h2><p>We will use two files from this MovieLens dataset: “<code>ratings.dat</code>” and “<code>movies.dat</code>”. All ratings are contained in the file “<code>ratings.dat</code>” and are in the following format:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UserID::MovieID::Rating::Timestamp</div></pre></td></tr></table></figure><p>Movie information is in the file “<code>movies.dat</code>” and is in the following format:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MovieID::Title::Genres</div></pre></td></tr></table></figure><h2 id="Collaborative-filtering"><a href="#Collaborative-filtering" class="headerlink" title="Collaborative filtering"></a>Collaborative filtering</h2><p>Collaborative filtering is commonly used for recommender systems. These techniques aim to fill in the missing entries of a user-item association matrix, in our case, the user-movie rating matrix. MLlib currently supports model-based collaborative filtering, in which users and products are described by a small set of latent factors that can be used to predict missing entries. In particular, we implement the alternating least squares (ALS) algorithm to learn these latent factors.</p><p><img src="https://databricks-training.s3.amazonaws.com/img/matrix_factorization.png" alt="cf"></p><h2 id="Create-training-examples"><a href="#Create-training-examples" class="headerlink" title="Create training examples"></a>Create training examples</h2><p><a href="https://github.com/ewanlee/spark-training" target="_blank" rel="external">https://github.com/ewanlee/spark-training</a></p><p>To make recommendation <em>for you</em>, we are going to learn your taste by asking you to rate a few movies. We have selected a small set of movies that have received the most ratings from users in the MovieLens dataset. You can rate those movies by running <code>bin/rateMovies</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python bin/rateMovies</div></pre></td></tr></table></figure><p>When you run the script, you should see prompt similar to the following:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Please rate the following movie (1-5 (best), or 0 if not seen):</div><div class="line">Toy Story (1995):</div></pre></td></tr></table></figure><p>After you’re done rating the movies, we save your ratings in <code>personalRatings.txt</code> in the MovieLens format, where a special user id <code>0</code> is assigned to you.</p><p><code>rateMovies</code> allows you to re-rate the movies if you’d like to see how your ratings affect your recommendations.</p><p>If you don’t have python installed, please copy <code>personalRatings.txt.template</code> to <code>personalRatings.txt</code> and replace <code>?</code>s with your ratings.</p><h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><p>We will be using a standalone project template for this exercise.</p><ul><li><p>In the training USB drive, this has been setup in</p></li><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">machine-learning/python/</div></pre></td></tr></table></figure></li><li><p>You should find the following items in the directory:</p></li><li><p><code>MovieLensALS.py</code>: Main Python program that you are going to edit, compile and run</p></li><li><p><code>solution</code>: Directory containing the solution code</p></li></ul><p><code>MovieLensALS.py</code> should look as follows:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> itertools</div><div class="line"><span class="keyword">from</span> math <span class="keyword">import</span> sqrt</div><div class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> add</div><div class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> join, isfile, dirname</div><div class="line"></div><div class="line"><span class="keyword">from</span> pyspark <span class="keyword">import</span> SparkConf, SparkContext</div><div class="line"><span class="keyword">from</span> pyspark.mllib.recommendation <span class="keyword">import</span> ALS</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseRating</span><span class="params">(line)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Parses a rating record in MovieLens format userId::movieId::rating::timestamp .</div><div class="line">    """</div><div class="line">    <span class="comment"># ...</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseMovie</span><span class="params">(line)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Parses a movie record in MovieLens format movieId::movieTitle .</div><div class="line">    """</div><div class="line">    <span class="comment"># ...</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadRatings</span><span class="params">(ratingsFile)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Load ratings from file.</div><div class="line">    """</div><div class="line">    <span class="comment"># ...</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">computeRmse</span><span class="params">(model, data, n)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Compute RMSE (Root Mean Squared Error).</div><div class="line">    """</div><div class="line">    <span class="comment"># ...</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    <span class="keyword">if</span> (len(sys.argv) != <span class="number">3</span>):</div><div class="line">        <span class="keyword">print</span> <span class="string">"Usage: [usb root directory]/spark/bin/spark-submit --driver-memory 2g "</span> + \</div><div class="line">          <span class="string">"MovieLensALS.py movieLensDataDir personalRatingsFile"</span></div><div class="line">        sys.exit(<span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="comment"># set up environment</span></div><div class="line">    conf = SparkConf() \</div><div class="line">      .setAppName(<span class="string">"MovieLensALS"</span>) \</div><div class="line">      .set(<span class="string">"spark.executor.memory"</span>, <span class="string">"2g"</span>)</div><div class="line">    sc = SparkContext(conf=conf)</div><div class="line"></div><div class="line">    <span class="comment"># load personal ratings</span></div><div class="line">    myRatings = loadRatings(sys.argv[<span class="number">2</span>])</div><div class="line">    myRatingsRDD = sc.parallelize(myRatings, <span class="number">1</span>)</div><div class="line">    </div><div class="line">    <span class="comment"># load ratings and movie titles</span></div><div class="line"></div><div class="line">    movieLensHomeDir = sys.argv[<span class="number">1</span>]</div><div class="line"></div><div class="line">    <span class="comment"># ratings is an RDD of (last digit of timestamp, (userId, movieId, rating))</span></div><div class="line">    ratings = sc.textFile(join(movieLensHomeDir, <span class="string">"ratings.dat"</span>)).map(parseRating)</div><div class="line"></div><div class="line">    <span class="comment"># movies is an RDD of (movieId, movieTitle)</span></div><div class="line">    movies = dict(sc.textFile(join(movieLensHomeDir, <span class="string">"movies.dat"</span>)).map(parseMovie).collect())</div><div class="line"></div><div class="line">    <span class="comment"># your code here</span></div><div class="line">    </div><div class="line">    <span class="comment"># clean up</span></div><div class="line">    sc.stop()</div></pre></td></tr></table></figure><p>Let’s first take a closer look at our template code in a text editor, then we’ll start adding code to the template. Locate the<code>MovieLensALS</code> class and open it with a text editor.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">usb/$ cd machine-learning/python</div><div class="line">vim MovieLensALS.py  # Or your editor of choice</div></pre></td></tr></table></figure><p>For any Spark computation, we first create a SparkConf object and use it to create a SparkContext object. Since we will be using spark-submit to execute the programs in this tutorial (more on spark-submit in the next section), we only need to configure the executor memory allocation and give the program a name, e.g. “MovieLensALS”, to identify it in Spark’s web UI. In local mode, the web UI can be access at <a href="http://localhost:4040/" target="_blank" rel="external"><code>localhost:4040</code></a> during the execution of a program.</p><p>This is what it looks like in our template code:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">conf = SparkConf() \</div><div class="line">     .setAppName(<span class="string">"MovieLensALS"</span>) \</div><div class="line">     .set(<span class="string">"spark.executor.memory"</span>, <span class="string">"2g"</span>)</div><div class="line">   sc = SparkContext(conf=conf)</div></pre></td></tr></table></figure><p>Next, the code uses the SparkContext to read in ratings. Recall that the rating file is a text file with “<code>::</code>” as the delimiter. The code parses each line to create a RDD for ratings that contains <code>(Int, Rating)</code> pairs. We only keep the last digit of the timestamp as a random key. The <code>Rating</code> class is a wrapper around the tuple <code>(user: Int, product: Int, rating: Double)</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">movieLensHomeDir = sys.argv[<span class="number">1</span>]</div><div class="line"></div><div class="line"><span class="comment"># ratings is an RDD of (last digit of timestamp, (userId, movieId, rating))</span></div><div class="line">ratings = sc.textFile(join(movieLensHomeDir, <span class="string">"ratings.dat"</span>)).map(parseRating)</div></pre></td></tr></table></figure><p>Next, the code read in movie ids and titles, collect them into a movie id to title map.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseMovie</span><span class="params">(line)</span>:</span></div><div class="line">      fields = line.split(<span class="string">"::"</span>)</div><div class="line">      <span class="keyword">return</span> int(fields[<span class="number">0</span>]), fields[<span class="number">1</span>]</div><div class="line"></div><div class="line">    movies = dict(sc.textFile(join(movieLensHomeDir, <span class="string">"movies.dat"</span>)).map(parseMovie).collect())</div></pre></td></tr></table></figure><p>Now, let’s make our first edit to add code to get a summary of the ratings.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">numRatings = ratings.count()</div><div class="line">numUsers = ratings.values().map(<span class="keyword">lambda</span> r: r[<span class="number">0</span>]).distinct().count()</div><div class="line">numMovies = ratings.values().map(<span class="keyword">lambda</span> r: r[<span class="number">1</span>]).distinct().count()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Got %d ratings from %d users on %d movies."</span> % (numRatings, numUsers, numMovies)</div></pre></td></tr></table></figure><h2 id="Running-the-program"><a href="#Running-the-program" class="headerlink" title="Running the program"></a>Running the program</h2><p>Before we compute movie recommendations, here is a quick reminder on how you can run the program at any point during this exercise. As mentioned above, we will use <code>spark-submit</code> to execute your program in local mode for this tutorial.</p><p>Starting with Spark 1.0, <code>spark-submit</code> is the recommended way for running Spark applications, both on clusters and locally in standalone mode.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">usb/$ cd machine-learning/python</div><div class="line"></div><div class="line"># change the folder name from <span class="string">"medium"</span> to <span class="string">"large"</span> to run on the large data <span class="keyword">set</span></div><div class="line">[usb root directory]/spark/bin/spark-submit MovieLensALS.py [usb root directory]/data/movielens/medium/ ../personalRatings.txt</div></pre></td></tr></table></figure><p>You should see output similar to the following on your screen:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Got <span class="number">1000209</span> ratings from <span class="number">6040</span> users on <span class="number">3706</span> movies.</div></pre></td></tr></table></figure><h2 id="Splitting-training-data"><a href="#Splitting-training-data" class="headerlink" title="Splitting training data"></a>Splitting training data</h2><p>We will use MLlib’s <code>ALS</code> to train a <code>MatrixFactorizationModel</code>, which takes a <code>RDD[Rating]</code> object as input in Scala and <code>RDD[(user, product, rating)]</code> in Python. ALS has training parameters such as rank for matrix factors and regularization constants. To determine a good combination of the training parameters, we split the data into three non-overlapping subsets, named training, test, and validation, based on the last digit of the timestamp, and cache them. We will train multiple models based on the training set, select the best model on the validation set based on RMSE (Root Mean Squared Error), and finally evaluate the best model on the test set. We also add your ratings to the training set to make recommendations for you. We hold the training, validation, and test sets in memory by calling <code>cache</code> because we need to visit them multiple times.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">numPartitions = <span class="number">4</span></div><div class="line">training = ratings.filter(<span class="keyword">lambda</span> x: x[<span class="number">0</span>] &lt; <span class="number">6</span>) \</div><div class="line">  .values() \</div><div class="line">  .union(myRatingsRDD) \</div><div class="line">  .repartition(numPartitions) \</div><div class="line">  .cache()</div><div class="line"></div><div class="line">validation = ratings.filter(<span class="keyword">lambda</span> x: x[<span class="number">0</span>] &gt;= <span class="number">6</span> <span class="keyword">and</span> x[<span class="number">0</span>] &lt; <span class="number">8</span>) \</div><div class="line">  .values() \</div><div class="line">  .repartition(numPartitions) \</div><div class="line">  .cache()</div><div class="line"></div><div class="line">test = ratings.filter(<span class="keyword">lambda</span> x: x[<span class="number">0</span>] &gt;= <span class="number">8</span>).values().cache()</div><div class="line"></div><div class="line">numTraining = training.count()</div><div class="line">numValidation = validation.count()</div><div class="line">numTest = test.count()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Training: %d, validation: %d, test: %d"</span> % (numTraining, numValidation, numTest)</div></pre></td></tr></table></figure><p>After the split, you should see</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Training: <span class="number">602251</span>, validation: <span class="number">198919</span>, test: <span class="number">199049.</span></div></pre></td></tr></table></figure><h2 id="Training-using-ALS"><a href="#Training-using-ALS" class="headerlink" title="Training using ALS"></a>Training using ALS</h2><p>In this section, we will use <code>ALS.train</code> to train a bunch of models, and select and evaluate the best. Among the training paramters of ALS, the most important ones are rank, lambda (regularization constant), and number of iterations. The <code>train</code>method of ALS we are going to use is defined as the following:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ALS</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(cls, ratings, rank, iterations=<span class="number">5</span>, lambda_=<span class="number">0.01</span>, blocks=<span class="number">-1</span>)</span>:</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line">    <span class="keyword">return</span> MatrixFactorizationModel(sc, mod)</div></pre></td></tr></table></figure><p>deally, we want to try a large number of combinations of them in order to find the best one. Due to time constraint, we will test only 8 combinations resulting from the cross product of 2 different ranks (8 and 12), 2 different lambdas (1.0 and 10.0), and two different numbers of iterations (10 and 20). We use the provided method <code>computeRmse</code> to compute the RMSE on the validation set for each model. The model with the smallest RMSE on the validation set becomes the one selected and its RMSE on the test set is used as the final metric.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">ranks = [<span class="number">8</span>, <span class="number">12</span>]</div><div class="line">lambdas = [<span class="number">1.0</span>, <span class="number">10.0</span>]</div><div class="line">numIters = [<span class="number">10</span>, <span class="number">20</span>]</div><div class="line">bestModel = <span class="keyword">None</span></div><div class="line">bestValidationRmse = float(<span class="string">"inf"</span>)</div><div class="line">bestRank = <span class="number">0</span></div><div class="line">bestLambda = <span class="number">-1.0</span></div><div class="line">bestNumIter = <span class="number">-1</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> rank, lmbda, numIter <span class="keyword">in</span> itertools.product(ranks, lambdas, numIters):</div><div class="line">    model = ALS.train(training, rank, numIter, lmbda)</div><div class="line">    validationRmse = computeRmse(model, validation, numValidation)</div><div class="line">    <span class="keyword">print</span> <span class="string">"RMSE (validation) = %f for the model trained with "</span> % validationRmse + \</div><div class="line">          <span class="string">"rank = %d, lambda = %.1f, and numIter = %d."</span> % (rank, lmbda, numIter)</div><div class="line">    <span class="keyword">if</span> (validationRmse &lt; bestValidationRmse):</div><div class="line">        bestModel = model</div><div class="line">        bestValidationRmse = validationRmse</div><div class="line">        bestRank = rank</div><div class="line">        bestLambda = lmbda</div><div class="line">        bestNumIter = numIter</div><div class="line"></div><div class="line">testRmse = computeRmse(bestModel, test, numTest)</div><div class="line"></div><div class="line"><span class="comment"># evaluate the best model on the test set</span></div><div class="line"><span class="keyword">print</span> <span class="string">"The best model was trained with rank = %d and lambda = %.1f, "</span> % (bestRank, bestLambda) \</div><div class="line">  + <span class="string">"and numIter = %d, and its RMSE on the test set is %f."</span> % (bestNumIter, testRmse)</div></pre></td></tr></table></figure><p>Spark might take a minute or two to train the models. You should see the following on the screen:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The best model was trained using rank <span class="number">8</span> <span class="keyword">and</span> <span class="keyword">lambda</span> <span class="number">10.0</span>, <span class="keyword">and</span> its RMSE on test <span class="keyword">is</span> <span class="number">0.8808492431998702</span>.</div></pre></td></tr></table></figure><h2 id="Recommending-movies-for-you"><a href="#Recommending-movies-for-you" class="headerlink" title="Recommending movies for you"></a>Recommending movies for you</h2><p>As the last part of our tutorial, let’s take a look at what movies our model recommends for you. This is done by generating <code>(0, movieId)</code> pairs for all movies you haven’t rated and calling the model’s <code>predict</code> method to get predictions. <code>0</code> is the special user id assigned to you.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MatrixFactorizationModel</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predictAll</span><span class="params">(self, usersProducts)</span>:</span></div><div class="line">        <span class="comment"># ...</span></div><div class="line">        <span class="keyword">return</span> RDD(self._java_model.predict(usersProductsJRDD._jrdd),</div><div class="line">                   self._context, RatingDeserializer())</div></pre></td></tr></table></figure><p>After we get all predictions, let us list the top 50 recommendations and see whether they look good to you.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">myRatedMovieIds = set([x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> myRatings])</div><div class="line">candidates = sc.parallelize([m <span class="keyword">for</span> m <span class="keyword">in</span> movies <span class="keyword">if</span> m <span class="keyword">not</span> <span class="keyword">in</span> myRatedMovieIds])</div><div class="line">predictions = bestModel.predictAll(candidates.map(<span class="keyword">lambda</span> x: (<span class="number">0</span>, x))).collect()</div><div class="line">recommendations = sorted(predictions, key=<span class="keyword">lambda</span> x: x[<span class="number">2</span>], reverse=<span class="keyword">True</span>)[:<span class="number">50</span>]</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Movies recommended for you:"</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(recommendations)):</div><div class="line">    <span class="keyword">print</span> (<span class="string">"%2d: %s"</span> % (i + <span class="number">1</span>, movies[recommendations[i][<span class="number">1</span>]])).encode(<span class="string">'ascii'</span>, <span class="string">'ignore'</span>)</div></pre></td></tr></table></figure><p>The output should be similar to</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Movies recommended for you:</div><div class="line"> 1: Silence of the Lambs, The (1991)</div><div class="line"> 2: Saving Private Ryan (1998)</div><div class="line"> 3: Godfather, The (1972)</div><div class="line"> 4: Star Wars: Episode IV - A New Hope (1977)</div><div class="line"> 5: Braveheart (1995)</div><div class="line"> 6: Schindler's List (1993)</div><div class="line"> 7: Shawshank Redemption, The (1994)</div><div class="line"> 8: Star Wars: Episode V - The Empire Strikes Back (1980)</div><div class="line"> 9: Pulp Fiction (1994)</div><div class="line">10: Alien (1979)</div><div class="line">...</div></pre></td></tr></table></figure><h2 id="Comparing-to-a-naive-baseline"><a href="#Comparing-to-a-naive-baseline" class="headerlink" title="Comparing to a naive baseline"></a>Comparing to a naive baseline</h2><p>Does ALS output a non-trivial model? We can compare the evaluation result with a naive baseline model that only outputs the average rating (or you may try one that outputs the average rating per movie). Computing the baseline’s RMSE is straightforward:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">meanRating = training.union(validation).map(<span class="keyword">lambda</span> x: x[<span class="number">2</span>]).mean()</div><div class="line">baselineRmse = sqrt(test.map(<span class="keyword">lambda</span> x: (meanRating - x[<span class="number">2</span>]) ** <span class="number">2</span>).reduce(add) / numTest)</div><div class="line">improvement = (baselineRmse - testRmse) / baselineRmse * <span class="number">100</span></div><div class="line"><span class="keyword">print</span> <span class="string">"The best model improves the baseline by %.2f"</span> % (improvement) + <span class="string">"%."</span></div></pre></td></tr></table></figure><p>The output should be similar to</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The best model improves the baseline by <span class="number">20.96</span>%.</div></pre></td></tr></table></figure><p>It seems obvious that the trained model would outperform the naive baseline. However, a bad combination of training parameters would lead to a model worse than this naive baseline. Choosing the right set of parameters is quite important for this task.</p><h2 id="Solution-code"><a href="#Solution-code" class="headerlink" title="Solution code"></a>Solution code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> itertools</div><div class="line"><span class="keyword">from</span> math <span class="keyword">import</span> sqrt</div><div class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> add</div><div class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> join, isfile, dirname</div><div class="line"></div><div class="line"><span class="keyword">from</span> pyspark <span class="keyword">import</span> SparkConf, SparkContext</div><div class="line"><span class="keyword">from</span> pyspark.mllib.recommendation <span class="keyword">import</span> ALS</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseRating</span><span class="params">(line)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Parses a rating record in MovieLens format userId::movieId::rating::timestamp .</div><div class="line">    """</div><div class="line">    fields = line.strip().split(<span class="string">"::"</span>)</div><div class="line">    <span class="keyword">return</span> long(fields[<span class="number">3</span>]) % <span class="number">10</span>, (int(fields[<span class="number">0</span>]), int(fields[<span class="number">1</span>]), float(fields[<span class="number">2</span>]))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseMovie</span><span class="params">(line)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Parses a movie record in MovieLens format movieId::movieTitle .</div><div class="line">    """</div><div class="line">    fields = line.strip().split(<span class="string">"::"</span>)</div><div class="line">    <span class="keyword">return</span> int(fields[<span class="number">0</span>]), fields[<span class="number">1</span>]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadRatings</span><span class="params">(ratingsFile)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Load ratings from file.</div><div class="line">    """</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isfile(ratingsFile):</div><div class="line">        <span class="keyword">print</span> <span class="string">"File %s does not exist."</span> % ratingsFile</div><div class="line">        sys.exit(<span class="number">1</span>)</div><div class="line">    f = open(ratingsFile, <span class="string">'r'</span>)</div><div class="line">    ratings = filter(<span class="keyword">lambda</span> r: r[<span class="number">2</span>] &gt; <span class="number">0</span>, [parseRating(line)[<span class="number">1</span>] <span class="keyword">for</span> line <span class="keyword">in</span> f])</div><div class="line">    f.close()</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ratings:</div><div class="line">        <span class="keyword">print</span> <span class="string">"No ratings provided."</span></div><div class="line">        sys.exit(<span class="number">1</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> ratings</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">computeRmse</span><span class="params">(model, data, n)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Compute RMSE (Root Mean Squared Error).</div><div class="line">    """</div><div class="line">    predictions = model.predictAll(data.map(<span class="keyword">lambda</span> x: (x[<span class="number">0</span>], x[<span class="number">1</span>])))</div><div class="line">    predictionsAndRatings = predictions.map(<span class="keyword">lambda</span> x: ((x[<span class="number">0</span>], x[<span class="number">1</span>]), x[<span class="number">2</span>])) \</div><div class="line">      .join(data.map(<span class="keyword">lambda</span> x: ((x[<span class="number">0</span>], x[<span class="number">1</span>]), x[<span class="number">2</span>]))) \</div><div class="line">      .values()</div><div class="line">    <span class="keyword">return</span> sqrt(predictionsAndRatings.map(<span class="keyword">lambda</span> x: (x[<span class="number">0</span>] - x[<span class="number">1</span>]) ** <span class="number">2</span>).reduce(add) / float(n))</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    <span class="keyword">if</span> (len(sys.argv) != <span class="number">3</span>):</div><div class="line">        <span class="keyword">print</span> <span class="string">"Usage: /path/to/spark/bin/spark-submit --driver-memory 2g "</span> + \</div><div class="line">          <span class="string">"MovieLensALS.py movieLensDataDir personalRatingsFile"</span></div><div class="line">        sys.exit(<span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="comment"># set up environment</span></div><div class="line">    conf = SparkConf() \</div><div class="line">      .setAppName(<span class="string">"MovieLensALS"</span>) \</div><div class="line">      .set(<span class="string">"spark.executor.memory"</span>, <span class="string">"2g"</span>)</div><div class="line">    sc = SparkContext(conf=conf)</div><div class="line"></div><div class="line">    <span class="comment"># load personal ratings</span></div><div class="line">    myRatings = loadRatings(sys.argv[<span class="number">2</span>])</div><div class="line">    myRatingsRDD = sc.parallelize(myRatings, <span class="number">1</span>)</div><div class="line">    </div><div class="line">    <span class="comment"># load ratings and movie titles</span></div><div class="line"></div><div class="line">    movieLensHomeDir = sys.argv[<span class="number">1</span>]</div><div class="line"></div><div class="line">    <span class="comment"># ratings is an RDD of (last digit of timestamp, (userId, movieId, rating))</span></div><div class="line">    ratings = sc.textFile(join(movieLensHomeDir, <span class="string">"ratings.dat"</span>)).map(parseRating)</div><div class="line"></div><div class="line">    <span class="comment"># movies is an RDD of (movieId, movieTitle)</span></div><div class="line">    movies = dict(sc.textFile(join(movieLensHomeDir, <span class="string">"movies.dat"</span>)).map(parseMovie).collect())</div><div class="line"></div><div class="line">    numRatings = ratings.count()</div><div class="line">    numUsers = ratings.values().map(<span class="keyword">lambda</span> r: r[<span class="number">0</span>]).distinct().count()</div><div class="line">    numMovies = ratings.values().map(<span class="keyword">lambda</span> r: r[<span class="number">1</span>]).distinct().count()</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"Got %d ratings from %d users on %d movies."</span> % (numRatings, numUsers, numMovies)</div><div class="line"></div><div class="line">    <span class="comment"># split ratings into train (60%), validation (20%), and test (20%) based on the </span></div><div class="line">    <span class="comment"># last digit of the timestamp, add myRatings to train, and cache them</span></div><div class="line"></div><div class="line">    <span class="comment"># training, validation, test are all RDDs of (userId, movieId, rating)</span></div><div class="line"></div><div class="line">    numPartitions = <span class="number">4</span></div><div class="line">    training = ratings.filter(<span class="keyword">lambda</span> x: x[<span class="number">0</span>] &lt; <span class="number">6</span>) \</div><div class="line">      .values() \</div><div class="line">      .union(myRatingsRDD) \</div><div class="line">      .repartition(numPartitions) \</div><div class="line">      .cache()</div><div class="line"></div><div class="line">    validation = ratings.filter(<span class="keyword">lambda</span> x: x[<span class="number">0</span>] &gt;= <span class="number">6</span> <span class="keyword">and</span> x[<span class="number">0</span>] &lt; <span class="number">8</span>) \</div><div class="line">      .values() \</div><div class="line">      .repartition(numPartitions) \</div><div class="line">      .cache()</div><div class="line"></div><div class="line">    test = ratings.filter(<span class="keyword">lambda</span> x: x[<span class="number">0</span>] &gt;= <span class="number">8</span>).values().cache()</div><div class="line"></div><div class="line">    numTraining = training.count()</div><div class="line">    numValidation = validation.count()</div><div class="line">    numTest = test.count()</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"Training: %d, validation: %d, test: %d"</span> % (numTraining, numValidation, numTest)</div><div class="line"></div><div class="line">    <span class="comment"># train models and evaluate them on the validation set</span></div><div class="line"></div><div class="line">    ranks = [<span class="number">8</span>, <span class="number">12</span>]</div><div class="line">    lambdas = [<span class="number">0.1</span>, <span class="number">10.0</span>]</div><div class="line">    numIters = [<span class="number">10</span>, <span class="number">20</span>]</div><div class="line">    bestModel = <span class="keyword">None</span></div><div class="line">    bestValidationRmse = float(<span class="string">"inf"</span>)</div><div class="line">    bestRank = <span class="number">0</span></div><div class="line">    bestLambda = <span class="number">-1.0</span></div><div class="line">    bestNumIter = <span class="number">-1</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> rank, lmbda, numIter <span class="keyword">in</span> itertools.product(ranks, lambdas, numIters):</div><div class="line">        model = ALS.train(training, rank, numIter, lmbda)</div><div class="line">        validationRmse = computeRmse(model, validation, numValidation)</div><div class="line">        <span class="keyword">print</span> <span class="string">"RMSE (validation) = %f for the model trained with "</span> % validationRmse + \</div><div class="line">              <span class="string">"rank = %d, lambda = %.1f, and numIter = %d."</span> % (rank, lmbda, numIter)</div><div class="line">        <span class="keyword">if</span> (validationRmse &lt; bestValidationRmse):</div><div class="line">            bestModel = model</div><div class="line">            bestValidationRmse = validationRmse</div><div class="line">            bestRank = rank</div><div class="line">            bestLambda = lmbda</div><div class="line">            bestNumIter = numIter</div><div class="line"></div><div class="line">    testRmse = computeRmse(bestModel, test, numTest)</div><div class="line"></div><div class="line">    <span class="comment"># evaluate the best model on the test set</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"The best model was trained with rank = %d and lambda = %.1f, "</span> % (bestRank, bestLambda) \</div><div class="line">      + <span class="string">"and numIter = %d, and its RMSE on the test set is %f."</span> % (bestNumIter, testRmse)</div><div class="line"></div><div class="line">    <span class="comment"># compare the best model with a naive baseline that always returns the mean rating</span></div><div class="line">    meanRating = training.union(validation).map(<span class="keyword">lambda</span> x: x[<span class="number">2</span>]).mean()</div><div class="line">    baselineRmse = sqrt(test.map(<span class="keyword">lambda</span> x: (meanRating - x[<span class="number">2</span>]) ** <span class="number">2</span>).reduce(add) / numTest)</div><div class="line">    improvement = (baselineRmse - testRmse) / baselineRmse * <span class="number">100</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"The best model improves the baseline by %.2f"</span> % (improvement) + <span class="string">"%."</span></div><div class="line"></div><div class="line">    <span class="comment"># make personalized recommendations</span></div><div class="line"></div><div class="line">    myRatedMovieIds = set([x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> myRatings])</div><div class="line">    candidates = sc.parallelize([m <span class="keyword">for</span> m <span class="keyword">in</span> movies <span class="keyword">if</span> m <span class="keyword">not</span> <span class="keyword">in</span> myRatedMovieIds])</div><div class="line">    predictions = bestModel.predictAll(candidates.map(<span class="keyword">lambda</span> x: (<span class="number">0</span>, x))).collect()</div><div class="line">    recommendations = sorted(predictions, key=<span class="keyword">lambda</span> x: x[<span class="number">2</span>], reverse=<span class="keyword">True</span>)[:<span class="number">50</span>]</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"Movies recommended for you:"</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(recommendations)):</div><div class="line">        <span class="keyword">print</span> (<span class="string">"%2d: %s"</span> % (i + <span class="number">1</span>, movies[recommendations[i][<span class="number">1</span>]])).encode(<span class="string">'ascii'</span>, <span class="string">'ignore'</span>)</div><div class="line"></div><div class="line">    <span class="comment"># clean up</span></div><div class="line">    sc.stop()</div></pre></td></tr></table></figure></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></section><nav class="pagination"><a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/57/">57</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Ewan Li"><p class="site-author-name" itemprop="name">Ewan Li</p><p class="site-description motion-element" itemprop="description">Ewan's IT Blog</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">57</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">37</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ewanlee" target="_blank" title="Github"><i class="fa fa-fw fa-globe"></i> Github </a></span><span class="links-of-author-item"><a href="http://weibo.com/3946248928/profile?topnav=1&wvr=6" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Ewan Li</span></div><div class="powered-by">Powered by <a class="theme-link" href="https://hexo.io">Hexo</a></div><div class="theme-info">Theme - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user">本站访客数</i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span>人次</span> <span class="site-pv"><i class="fa fa-eye">本站总访问量</i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><script type="text/javascript">_hcwp=window._hcwp||[],_hcwp.push({widget:"Bloggerstream",widget_id:89825,selector:".hc-comment-count",label:"{%COUNT%}"}),function(){if(!("HC_LOAD_INIT"in window)){HC_LOAD_INIT=!0;var t=(navigator.language||navigator.systemLanguage||navigator.userLanguage||"en").substr(0,2).toLowerCase(),e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https":"http")+"://w.hypercomments.com/widget/hc/89825/"+t+"/widget.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n.nextSibling)}}()</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),n=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!1,n=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),o=decodeURIComponent(r.url),i=-1,l=-1,p=-1;if(""!=n&&a.forEach(function(e,t){i=n.indexOf(e),l=s.indexOf(e),(i>=0||l>=0)&&(c=!0,0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+o+"' class='search-result-title'>"+n+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),n.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script><script>AV.initialize("e27VKX5tTklQLCtF7iNMmhcA-gzGzoHsz","nnQn2znNgXXEdK7W2bVJ3bfK")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script></body></html>